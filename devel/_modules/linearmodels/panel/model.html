<!DOCTYPE html> <html lang=en > <meta charset=utf-8  /> <meta name=viewport  content="width=device-width, initial-scale=1.0" /> <meta name=viewport  content="width=device-width,initial-scale=1"> <meta http-equiv=x-ua-compatible  content="ie=edge"> <meta name="lang:clipboard.copy" content="Copy to clipboard"> <meta name="lang:clipboard.copied" content="Copied to clipboard"> <meta name="lang:search.language" content=en > <meta name="lang:search.pipeline.stopwords" content=True > <meta name="lang:search.pipeline.trimmer" content=True > <meta name="lang:search.result.none" content="No matching documents"> <meta name="lang:search.result.one" content="1 matching document"> <meta name="lang:search.result.other" content="# matching documents"> <meta name="lang:search.tokenizer" content="[\s\-]+"> <link href="https://fonts.gstatic.com/" rel=preconnect  crossorigin> <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700|Roboto:300,400,400i,700&display=fallback" rel=stylesheet > <style> body, input { font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif } code, kbd, pre { font-family: "Roboto Mono", "Courier New", Courier, monospace } </style> <link rel=stylesheet  href="../../../_static/stylesheets/application.css"/> <link rel=stylesheet  href="../../../_static/stylesheets/application-palette.css"/> <link rel=stylesheet  href="../../../_static/stylesheets/application-fixes.css"/> <link rel=stylesheet  href="../../../_static/fonts/material-icons.css"/> <meta name=theme-color  content="#2196f3"> <script src="../../../_static/javascripts/modernizr.js"></script> <title>linearmodels.panel.model &#8212; linearmodels 4.28.dev14+g78d4a968e documentation</title> <link rel=apple-touch-icon  sizes=180x180  href="../../../_static/icons/apple-touch-icon.png"> <link rel=icon  type="image/png" sizes=32x32  href="../../../_static/icons/favicon-32x32.png"> <link rel=icon  type="image/png" sizes=16x16  href="../../../_static/icons/favicon-16x16.png"> <link rel=manifest  href="../../../_static/icons/site.webmanifest"> <link rel=mask-icon  href="../../../_static/icons/safari-pinned-tab.svg" color="#2196f3"> <link rel="shortcut icon" href="../../../_static/icons/favicon.ico"> <meta name=msapplication-TileColor  content="#f8f8f8"> <meta name=msapplication-config  content="../../../_static/icons/browserconfig.xml"> <style> .highlight { background-color: hsla(0,0%,92.5%,.5) !important; } </style> <link rel=stylesheet  type="text/css" href="../../../_static/pygments.css" /> <link rel=stylesheet  type="text/css" href="../../../_static/material.css" /> <script data-url_root="../../../" id=documentation_options  src="../../../_static/documentation_options.js"></script> <script src="../../../_static/jquery.js"></script> <script src="../../../_static/underscore.js"></script> <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script> <script src="../../../_static/doctools.js"></script> <script crossorigin=anonymous  integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script> <link rel="shortcut icon" href="../../../_static/favicon.ico"/> <link rel=index  title=Index  href="../../../genindex.html" /> <link rel=search  title=Search  href="../../../search.html" /> <body dir=ltr data-md-color-primary=blue data-md-color-accent=orange> <svg class=md-svg > <defs data-children-count=0 > <svg xmlns="http://www.w3.org/2000/svg" width=416  height=448  viewBox="0 0 416 448" id=__github ><path fill=currentColor  d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg> </defs> </svg> <input class=md-toggle  data-md-toggle=drawer  type=checkbox  id=__drawer > <input class=md-toggle  data-md-toggle=search  type=checkbox  id=__search > <label class=md-overlay  data-md-component=overlay  for=__drawer ></label> <a href="#_modules/linearmodels/panel/model" tabindex=1  class=md-skip > Skip to content </a> <header class=md-header  data-md-component=header > <nav class="md-header-nav md-grid"> <div class="md-flex navheader"> <div class="md-flex__cell md-flex__cell--shrink"> <a href="../../../index.html" title="linearmodels 4.28.dev14+g78d4a968e documentation" class="md-header-nav__button md-logo"> <img src="../../../_static/bw-logo.svg" height=26  alt="linearmodels 4.28.dev14+g78d4a968e documentation logo"> </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer ></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title" data-md-component=title > <span class=md-header-nav__topic >linearmodels v4.28 (+14)</span> <span class=md-header-nav__topic > linearmodels.panel.model </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--search md-header-nav__button" for=__search ></label> <div class=md-search  data-md-component=search  role=dialog > <label class=md-search__overlay  for=__search ></label> <div class=md-search__inner  role=search > <form class=md-search__form  action="../../../search.html" method=get  name=search > <input type=text  class=md-search__input  name=q  placeholder=Search  autocapitalize=off  autocomplete=off  spellcheck=false  data-md-component=query  data-md-state=active > <label class="md-icon md-search__icon" for=__search ></label> <button type=reset  class="md-icon md-search__icon" data-md-component=reset  tabindex=-1 > &#xE5CD; </button> </form> <div class=md-search__output > <div class=md-search__scrollwrap  data-md-scrollfix> <div class=md-search-result  data-md-component=result > <div class=md-search-result__meta > Type to start searching </div> <ol class=md-search-result__list ></ol> </div> </div> </div> </div> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <div class=md-header-nav__source > <a href="https://github.com/bashtage/linearmodels/" title="Go to repository" class=md-source  data-md-source=github > <div class=md-source__icon > <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width=28  height=28 > <use xlink:href="#__github" width=24  height=24 ></use> </svg> </div> <div class=md-source__repository > linearmodels </div> </a> </div> </div> <div class="md-flex__cell md-flex__cell--shrink dropdown"> <button class=dropdownbutton >Versions</button> <div class="dropdown-content md-hero"> <a title=Release  href="https://bashtage.github.io/linearmodels/">Release</a> <a title=Development  href="https://bashtage.github.io/linearmodels/devel/">Development</a> </div> </div> </div> </nav> </header> <div class=md-container > <nav class=md-tabs  data-md-component=tabs > <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list > <li class=md-tabs__item ><a href="../../index.html" class=md-tabs__link >Module code</a> </ul> </div> </nav> <main class=md-main > <div class="md-main__inner md-grid" data-md-component=container > <div class="md-sidebar md-sidebar--primary" data-md-component=navigation > <div class=md-sidebar__scrollwrap > <div class=md-sidebar__inner > <nav class="md-nav md-nav--primary" data-md-level=0 > <label class="md-nav__title md-nav__title--site" for=__drawer > <a href="../../../index.html" title="linearmodels 4.28.dev14+g78d4a968e documentation" class="md-nav__button md-logo"> <img src="../../../_static/bw-logo.svg" alt=" logo" width=48  height=48 > </a> <a href="../../../index.html" title="linearmodels 4.28.dev14+g78d4a968e documentation">linearmodels v4.28 (+14)</a> </label> <div class=md-nav__source > <a href="https://github.com/bashtage/linearmodels/" title="Go to repository" class=md-source  data-md-source=github > <div class=md-source__icon > <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width=28  height=28 > <use xlink:href="#__github" width=24  height=24 ></use> </svg> </div> <div class=md-source__repository > linearmodels </div> </a> </div> <ul class=md-nav__list > <li class=md-nav__item > <a href="../../../iv/index.html" class=md-nav__link >Instrumental Variable Estimation</a> <li class=md-nav__item > <a href="../../../panel/index.html" class=md-nav__link >Panel Data Model Estimation</a> <li class=md-nav__item > <a href="../../../asset-pricing/index.html" class=md-nav__link >Linear Factor Models for Asset Pricing</a> <li class=md-nav__item > <a href="../../../system/index.html" class=md-nav__link >System Regression Models</a> <li class=md-nav__item > <a href="../../../utility.html" class=md-nav__link >Utilities</a> <li class=md-nav__item > <a href="../../../compatibility.html" class=md-nav__link >Compatibility</a> <li class=md-nav__item > <a href="../../../plan.html" class=md-nav__link >Module Plans</a> <li class=md-nav__item > <a href="../../../contributing.html" class=md-nav__link >Contributing</a> <li class=md-nav__item > <a href="../../../changes.html" class=md-nav__link >Change Log</a> <li class=md-nav__item > <a href="../../../references.html" class=md-nav__link >References</a> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc > <div class=md-sidebar__scrollwrap > <div class=md-sidebar__inner > <nav class="md-nav md-nav--secondary"> <ul class=md-nav__list  data-md-scrollfix=""> <li id=searchbox  class=md-nav__item > </ul> </nav> </div> </div> </div> <div class=md-content > <article class="md-content__inner md-typeset" role=main > <h1 id=modules-linearmodels-panel-model--page-root >Source code for linearmodels.panel.model</h1><div class=highlight ><pre>
<span></span><span class=kn >from</span> <span class=nn >__future__</span> <span class=kn >import</span> <span class=n >annotations</span>

<span class=kn >from</span> <span class=nn >typing</span> <span class=kn >import</span> <span class=n >NamedTuple</span><span class=p >,</span> <span class=n >Type</span><span class=p >,</span> <span class=n >Union</span><span class=p >,</span> <span class=n >cast</span>

<span class=kn >from</span> <span class=nn >formulaic</span> <span class=kn >import</span> <span class=n >model_matrix</span>
<span class=kn >from</span> <span class=nn >formulaic.model_spec</span> <span class=kn >import</span> <span class=n >NAAction</span>
<span class=kn >from</span> <span class=nn >formulaic.parser.algos.tokenize</span> <span class=kn >import</span> <span class=n >tokenize</span>
<span class=kn >import</span> <span class=nn >numpy</span> <span class=k >as</span> <span class=nn >np</span>
<span class=kn >from</span> <span class=nn >pandas</span> <span class=kn >import</span> <span class=n >Categorical</span><span class=p >,</span> <span class=n >DataFrame</span><span class=p >,</span> <span class=n >Index</span><span class=p >,</span> <span class=n >MultiIndex</span><span class=p >,</span> <span class=n >Series</span><span class=p >,</span> <span class=n >get_dummies</span>
<span class=kn >from</span> <span class=nn >scipy.linalg</span> <span class=kn >import</span> <span class=n >lstsq</span> <span class=k >as</span> <span class=n >sp_lstsq</span>
<span class=kn >from</span> <span class=nn >scipy.sparse</span> <span class=kn >import</span> <span class=n >csc_matrix</span><span class=p >,</span> <span class=n >diags</span>
<span class=kn >from</span> <span class=nn >scipy.sparse.linalg</span> <span class=kn >import</span> <span class=n >lsmr</span>

<span class=kn >from</span> <span class=nn >linearmodels.panel.covariance</span> <span class=kn >import</span> <span class=p >(</span>
    <span class=n >ACCovariance</span><span class=p >,</span>
    <span class=n >ClusteredCovariance</span><span class=p >,</span>
    <span class=n >CovarianceManager</span><span class=p >,</span>
    <span class=n >DriscollKraay</span><span class=p >,</span>
    <span class=n >FamaMacBethCovariance</span><span class=p >,</span>
    <span class=n >HeteroskedasticCovariance</span><span class=p >,</span>
    <span class=n >HomoskedasticCovariance</span><span class=p >,</span>
    <span class=n >setup_covariance_estimator</span><span class=p >,</span>
<span class=p >)</span>
<span class=kn >from</span> <span class=nn >linearmodels.panel.data</span> <span class=kn >import</span> <span class=n >PanelData</span><span class=p >,</span> <span class=n >PanelDataLike</span>
<span class=kn >from</span> <span class=nn >linearmodels.panel.results</span> <span class=kn >import</span> <span class=p >(</span>
    <span class=n >FamaMacBethResults</span><span class=p >,</span>
    <span class=n >PanelEffectsResults</span><span class=p >,</span>
    <span class=n >PanelResults</span><span class=p >,</span>
    <span class=n >RandomEffectsResults</span><span class=p >,</span>
<span class=p >)</span>
<span class=kn >from</span> <span class=nn >linearmodels.panel.utility</span> <span class=kn >import</span> <span class=p >(</span>
    <span class=n >AbsorbingEffectWarning</span><span class=p >,</span>
    <span class=n >absorbing_warn_msg</span><span class=p >,</span>
    <span class=n >check_absorbed</span><span class=p >,</span>
    <span class=n >dummy_matrix</span><span class=p >,</span>
    <span class=n >in_2core_graph</span><span class=p >,</span>
    <span class=n >not_absorbed</span><span class=p >,</span>
<span class=p >)</span>
<span class=kn >from</span> <span class=nn >linearmodels.shared.exceptions</span> <span class=kn >import</span> <span class=p >(</span>
    <span class=n >InferenceUnavailableWarning</span><span class=p >,</span>
    <span class=n >MemoryWarning</span><span class=p >,</span>
    <span class=n >MissingValueWarning</span><span class=p >,</span>
    <span class=n >SingletonWarning</span><span class=p >,</span>
    <span class=n >missing_warning</span><span class=p >,</span>
<span class=p >)</span>
<span class=kn >from</span> <span class=nn >linearmodels.shared.hypotheses</span> <span class=kn >import</span> <span class=p >(</span>
    <span class=n >InapplicableTestStatistic</span><span class=p >,</span>
    <span class=n >InvalidTestStatistic</span><span class=p >,</span>
    <span class=n >WaldTestStatistic</span><span class=p >,</span>
<span class=p >)</span>
<span class=kn >from</span> <span class=nn >linearmodels.shared.linalg</span> <span class=kn >import</span> <span class=n >has_constant</span>
<span class=kn >from</span> <span class=nn >linearmodels.shared.typed_getters</span> <span class=kn >import</span> <span class=n >get_panel_data_like</span>
<span class=kn >from</span> <span class=nn >linearmodels.shared.utility</span> <span class=kn >import</span> <span class=n >AttrDict</span><span class=p >,</span> <span class=n >ensure_unique_column</span><span class=p >,</span> <span class=n >panel_to_frame</span>
<span class=kn >from</span> <span class=nn >linearmodels.typing</span> <span class=kn >import</span> <span class=p >(</span>
    <span class=n >ArrayLike</span><span class=p >,</span>
    <span class=n >BoolArray</span><span class=p >,</span>
    <span class=n >Float64Array</span><span class=p >,</span>
    <span class=n >IntArray</span><span class=p >,</span>
    <span class=n >NumericArray</span><span class=p >,</span>
<span class=p >)</span>

<span class=n >CovarianceEstimator</span> <span class=o >=</span> <span class=n >Union</span><span class=p >[</span>
    <span class=n >ACCovariance</span><span class=p >,</span>
    <span class=n >ClusteredCovariance</span><span class=p >,</span>
    <span class=n >DriscollKraay</span><span class=p >,</span>
    <span class=n >HeteroskedasticCovariance</span><span class=p >,</span>
    <span class=n >HomoskedasticCovariance</span><span class=p >,</span>
<span class=p >]</span>

<span class=n >CovarianceEstimatorType</span> <span class=o >=</span> <span class=n >Union</span><span class=p >[</span>
    <span class=n >Type</span><span class=p >[</span><span class=n >ACCovariance</span><span class=p >],</span>
    <span class=n >Type</span><span class=p >[</span><span class=n >ClusteredCovariance</span><span class=p >],</span>
    <span class=n >Type</span><span class=p >[</span><span class=n >DriscollKraay</span><span class=p >],</span>
    <span class=n >Type</span><span class=p >[</span><span class=n >HeteroskedasticCovariance</span><span class=p >],</span>
    <span class=n >Type</span><span class=p >[</span><span class=n >HomoskedasticCovariance</span><span class=p >],</span>
<span class=p >]</span>


<span class=k >def</span> <span class=nf >_lstsq</span><span class=p >(</span>
    <span class=n >x</span><span class=p >:</span> <span class=n >Float64Array</span><span class=p >,</span> <span class=n >y</span><span class=p >:</span> <span class=n >Float64Array</span><span class=p >,</span> <span class=n >rcond</span><span class=p >:</span> <span class=nb >float</span> <span class=o >|</span> <span class=kc >None</span> <span class=o >=</span> <span class=kc >None</span>
<span class=p >)</span> <span class=o >-&gt;</span> <span class=nb >tuple</span><span class=p >[</span><span class=n >Float64Array</span><span class=p >,</span> <span class=n >Float64Array</span><span class=p >,</span> <span class=nb >int</span><span class=p >,</span> <span class=n >Float64Array</span><span class=p >]:</span>
    <span class=k >if</span> <span class=n >rcond</span> <span class=ow >is</span> <span class=kc >None</span><span class=p >:</span>
        <span class=n >eps</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >finfo</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >float64</span><span class=p >)</span><span class=o >.</span><span class=n >eps</span>
        <span class=n >cond</span> <span class=o >=</span> <span class=nb >float</span><span class=p >(</span><span class=nb >max</span><span class=p >(</span><span class=n >x</span><span class=o >.</span><span class=n >shape</span><span class=p >)</span> <span class=o >*</span> <span class=n >eps</span><span class=p >)</span>
    <span class=k >else</span><span class=p >:</span>
        <span class=n >cond</span> <span class=o >=</span> <span class=n >rcond</span>
    <span class=k >return</span> <span class=n >sp_lstsq</span><span class=p >(</span><span class=n >x</span><span class=p >,</span> <span class=n >y</span><span class=p >,</span> <span class=n >cond</span><span class=o >=</span><span class=n >cond</span><span class=p >,</span> <span class=n >lapack_driver</span><span class=o >=</span><span class=s2 >"gelsy"</span><span class=p >)</span>


<span class=k >def</span> <span class=nf >panel_structure_stats</span><span class=p >(</span><span class=n >ids</span><span class=p >:</span> <span class=n >IntArray</span><span class=p >,</span> <span class=n >name</span><span class=p >:</span> <span class=nb >str</span><span class=p >)</span> <span class=o >-&gt;</span> <span class=n >Series</span><span class=p >:</span>
    <span class=n >bc</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >bincount</span><span class=p >(</span><span class=n >ids</span><span class=p >)</span>
    <span class=n >index</span> <span class=o >=</span> <span class=p >[</span><span class=s2 >"mean"</span><span class=p >,</span> <span class=s2 >"median"</span><span class=p >,</span> <span class=s2 >"max"</span><span class=p >,</span> <span class=s2 >"min"</span><span class=p >,</span> <span class=s2 >"total"</span><span class=p >]</span>
    <span class=n >out</span> <span class=o >=</span> <span class=p >[</span><span class=n >bc</span><span class=o >.</span><span class=n >mean</span><span class=p >(),</span> <span class=n >np</span><span class=o >.</span><span class=n >median</span><span class=p >(</span><span class=n >bc</span><span class=p >),</span> <span class=n >bc</span><span class=o >.</span><span class=n >max</span><span class=p >(),</span> <span class=n >bc</span><span class=o >.</span><span class=n >min</span><span class=p >(),</span> <span class=n >bc</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >]]</span>
    <span class=k >return</span> <span class=n >Series</span><span class=p >(</span><span class=n >out</span><span class=p >,</span> <span class=n >index</span><span class=o >=</span><span class=n >index</span><span class=p >,</span> <span class=n >name</span><span class=o >=</span><span class=n >name</span><span class=p >)</span>


<span class=k >class</span> <span class=nc >FInfo</span><span class=p >(</span><span class=n >NamedTuple</span><span class=p >):</span>
    <span class=n >sel</span><span class=p >:</span> <span class=n >BoolArray</span>
    <span class=n >name</span><span class=p >:</span> <span class=nb >str</span>
    <span class=n >invalid_test_stat</span><span class=p >:</span> <span class=n >InvalidTestStatistic</span> <span class=o >|</span> <span class=kc >None</span>
    <span class=n >is_invalid</span><span class=p >:</span> <span class=nb >bool</span>


<span class=k >def</span> <span class=nf >_deferred_f</span><span class=p >(</span>
    <span class=n >params</span><span class=p >:</span> <span class=n >Series</span><span class=p >,</span> <span class=n >cov</span><span class=p >:</span> <span class=n >DataFrame</span><span class=p >,</span> <span class=n >debiased</span><span class=p >:</span> <span class=nb >bool</span><span class=p >,</span> <span class=n >df_resid</span><span class=p >:</span> <span class=nb >int</span><span class=p >,</span> <span class=n >f_info</span><span class=p >:</span> <span class=n >FInfo</span>
<span class=p >)</span> <span class=o >-&gt;</span> <span class=n >InvalidTestStatistic</span> <span class=o >|</span> <span class=n >WaldTestStatistic</span><span class=p >:</span>
    <span class=k >if</span> <span class=n >f_info</span><span class=o >.</span><span class=n >is_invalid</span><span class=p >:</span>
        <span class=k >assert</span> <span class=n >f_info</span><span class=o >.</span><span class=n >invalid_test_stat</span> <span class=ow >is</span> <span class=ow >not</span> <span class=kc >None</span>
        <span class=k >return</span> <span class=n >f_info</span><span class=o >.</span><span class=n >invalid_test_stat</span>
    <span class=n >sel</span> <span class=o >=</span> <span class=n >f_info</span><span class=o >.</span><span class=n >sel</span>
    <span class=n >name</span> <span class=o >=</span> <span class=n >f_info</span><span class=o >.</span><span class=n >name</span>
    <span class=n >test_params</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >asarray</span><span class=p >(</span><span class=n >params</span><span class=p >)[</span><span class=n >sel</span><span class=p >]</span>
    <span class=n >test_cov</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >asarray</span><span class=p >(</span><span class=n >cov</span><span class=p >)[</span><span class=n >sel</span><span class=p >][:,</span> <span class=n >sel</span><span class=p >]</span>
    <span class=n >test_stat</span> <span class=o >=</span> <span class=n >test_params</span><span class=o >.</span><span class=n >T</span> <span class=o >@</span> <span class=n >np</span><span class=o >.</span><span class=n >linalg</span><span class=o >.</span><span class=n >inv</span><span class=p >(</span><span class=n >test_cov</span><span class=p >)</span> <span class=o >@</span> <span class=n >test_params</span>
    <span class=n >test_stat</span> <span class=o >=</span> <span class=nb >float</span><span class=p >(</span><span class=n >test_stat</span><span class=p >)</span>
    <span class=n >df</span> <span class=o >=</span> <span class=nb >int</span><span class=p >(</span><span class=n >sel</span><span class=o >.</span><span class=n >sum</span><span class=p >())</span>
    <span class=n >null</span> <span class=o >=</span> <span class=s2 >"All parameters ex. constant are zero"</span>

    <span class=k >if</span> <span class=n >debiased</span><span class=p >:</span>
        <span class=n >wald</span> <span class=o >=</span> <span class=n >WaldTestStatistic</span><span class=p >(</span><span class=n >test_stat</span> <span class=o >/</span> <span class=n >df</span><span class=p >,</span> <span class=n >null</span><span class=p >,</span> <span class=n >df</span><span class=p >,</span> <span class=n >df_resid</span><span class=p >,</span> <span class=n >name</span><span class=o >=</span><span class=n >name</span><span class=p >)</span>
    <span class=k >else</span><span class=p >:</span>
        <span class=n >wald</span> <span class=o >=</span> <span class=n >WaldTestStatistic</span><span class=p >(</span><span class=n >test_stat</span><span class=p >,</span> <span class=n >null</span><span class=p >,</span> <span class=n >df</span><span class=p >,</span> <span class=n >name</span><span class=o >=</span><span class=n >name</span><span class=p >)</span>
    <span class=k >return</span> <span class=n >wald</span>


<span class=k >class</span> <span class=nc >PanelFormulaParser</span><span class=p >:</span>
    <span class=sd >"""</span>
<span class=sd >    Parse formulas for OLS and IV models</span>

<span class=sd >    Parameters</span>
<span class=sd >    ----------</span>
<span class=sd >    formula : str</span>
<span class=sd >        String formula object.</span>
<span class=sd >    data : DataFrame</span>
<span class=sd >        Frame containing values for variables used in formula</span>
<span class=sd >    context : int</span>
<span class=sd >        Stack depth to use when evaluating formulas</span>

<span class=sd >    Notes</span>
<span class=sd >    -----</span>
<span class=sd >    The general structure of a formula is `dep ~ exog`</span>
<span class=sd >    """</span>

    <span class=k >def</span> <span class=fm >__init__</span><span class=p >(</span><span class=bp >self</span><span class=p >,</span> <span class=n >formula</span><span class=p >:</span> <span class=nb >str</span><span class=p >,</span> <span class=n >data</span><span class=p >:</span> <span class=n >PanelDataLike</span><span class=p >,</span> <span class=n >context</span><span class=p >:</span> <span class=nb >int</span> <span class=o >=</span> <span class=mi >2</span><span class=p >)</span> <span class=o >-&gt;</span> <span class=kc >None</span><span class=p >:</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >_formula</span> <span class=o >=</span> <span class=n >formula</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >_data</span> <span class=o >=</span> <span class=n >PanelData</span><span class=p >(</span><span class=n >data</span><span class=p >,</span> <span class=n >convert_dummies</span><span class=o >=</span><span class=kc >False</span><span class=p >,</span> <span class=n >copy</span><span class=o >=</span><span class=kc >False</span><span class=p >)</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >_na_action</span> <span class=o >=</span> <span class=n >NAAction</span><span class=p >(</span><span class=s2 >"ignore"</span><span class=p >)</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >_context</span> <span class=o >=</span> <span class=n >context</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >_dependent</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_exog</span> <span class=o >=</span> <span class=kc >None</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >_parse</span><span class=p >()</span>

    <span class=k >def</span> <span class=nf >_parse</span><span class=p >(</span><span class=bp >self</span><span class=p >)</span> <span class=o >-&gt;</span> <span class=kc >None</span><span class=p >:</span>

        <span class=n >parts</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_formula</span><span class=o >.</span><span class=n >split</span><span class=p >(</span><span class=s2 >"~"</span><span class=p >)</span>
        <span class=n >parts</span><span class=p >[</span><span class=mi >1</span><span class=p >]</span> <span class=o >=</span> <span class=s2 >" 0 + "</span> <span class=o >+</span> <span class=n >parts</span><span class=p >[</span><span class=mi >1</span><span class=p >]</span>
        <span class=n >cln_formula</span> <span class=o >=</span> <span class=s2 >"~"</span><span class=o >.</span><span class=n >join</span><span class=p >(</span><span class=n >parts</span><span class=p >)</span>
        <span class=n >rm_list</span> <span class=o >=</span> <span class=p >[]</span>
        <span class=n >effects</span> <span class=o >=</span> <span class=p >{</span><span class=s2 >"EntityEffects"</span><span class=p >:</span> <span class=kc >False</span><span class=p >,</span> <span class=s2 >"FixedEffects"</span><span class=p >:</span> <span class=kc >False</span><span class=p >,</span> <span class=s2 >"TimeEffects"</span><span class=p >:</span> <span class=kc >False</span><span class=p >}</span>
        <span class=n >tokens</span> <span class=o >=</span> <span class=n >tokenize</span><span class=p >(</span><span class=n >cln_formula</span><span class=p >)</span>
        <span class=k >for</span> <span class=n >token</span> <span class=ow >in</span> <span class=n >tokens</span><span class=p >:</span>
            <span class=n >_token</span> <span class=o >=</span> <span class=nb >str</span><span class=p >(</span><span class=n >token</span><span class=p >)</span>
            <span class=k >if</span> <span class=n >_token</span> <span class=ow >in</span> <span class=n >effects</span><span class=p >:</span>
                <span class=n >effects</span><span class=p >[</span><span class=n >_token</span><span class=p >]</span> <span class=o >=</span> <span class=kc >True</span>
                <span class=n >rm_list</span><span class=o >.</span><span class=n >append</span><span class=p >(</span><span class=n >_token</span><span class=p >)</span>
        <span class=k >if</span> <span class=n >effects</span><span class=p >[</span><span class=s2 >"EntityEffects"</span><span class=p >]</span> <span class=ow >and</span> <span class=n >effects</span><span class=p >[</span><span class=s2 >"FixedEffects"</span><span class=p >]:</span>
            <span class=k >raise</span> <span class=ne >ValueError</span><span class=p >(</span><span class=s2 >"Cannot use both FixedEffects and EntityEffects"</span><span class=p >)</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >_entity_effect</span> <span class=o >=</span> <span class=n >effects</span><span class=p >[</span><span class=s2 >"EntityEffects"</span><span class=p >]</span> <span class=ow >or</span> <span class=n >effects</span><span class=p >[</span><span class=s2 >"FixedEffects"</span><span class=p >]</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >_time_effect</span> <span class=o >=</span> <span class=n >effects</span><span class=p >[</span><span class=s2 >"TimeEffects"</span><span class=p >]</span>
        <span class=k >for</span> <span class=n >effect</span> <span class=ow >in</span> <span class=n >effects</span><span class=p >:</span>
            <span class=k >if</span> <span class=n >effects</span><span class=p >[</span><span class=n >effect</span><span class=p >]:</span>
                <span class=n >loc</span> <span class=o >=</span> <span class=n >cln_formula</span><span class=o >.</span><span class=n >find</span><span class=p >(</span><span class=n >effect</span><span class=p >)</span>
                <span class=n >start</span> <span class=o >=</span> <span class=n >cln_formula</span><span class=o >.</span><span class=n >rfind</span><span class=p >(</span><span class=s2 >"+"</span><span class=p >,</span> <span class=mi >0</span><span class=p >,</span> <span class=n >loc</span><span class=p >)</span>
                <span class=n >end</span> <span class=o >=</span> <span class=n >loc</span> <span class=o >+</span> <span class=nb >len</span><span class=p >(</span><span class=n >effect</span><span class=p >)</span>
                <span class=n >cln_formula</span> <span class=o >=</span> <span class=n >cln_formula</span><span class=p >[:</span><span class=n >start</span><span class=p >]</span> <span class=o >+</span> <span class=n >cln_formula</span><span class=p >[</span><span class=n >end</span><span class=p >:]</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >_lhs</span><span class=p >,</span> <span class=bp >self</span><span class=o >.</span><span class=n >_rhs</span> <span class=o >=</span> <span class=nb >map</span><span class=p >(</span><span class=k >lambda</span> <span class=n >s</span><span class=p >:</span> <span class=s2 >"0 + "</span> <span class=o >+</span> <span class=n >s</span><span class=o >.</span><span class=n >strip</span><span class=p >(),</span> <span class=n >cln_formula</span><span class=o >.</span><span class=n >split</span><span class=p >(</span><span class=s2 >"~"</span><span class=p >))</span>

    <span class=nd >@property</span>
    <span class=k >def</span> <span class=nf >entity_effect</span><span class=p >(</span><span class=bp >self</span><span class=p >)</span> <span class=o >-&gt;</span> <span class=nb >bool</span><span class=p >:</span>
        <span class=sd >"""Formula contains entity effect"""</span>
        <span class=k >return</span> <span class=bp >self</span><span class=o >.</span><span class=n >_entity_effect</span>

    <span class=nd >@property</span>
    <span class=k >def</span> <span class=nf >time_effect</span><span class=p >(</span><span class=bp >self</span><span class=p >)</span> <span class=o >-&gt;</span> <span class=nb >bool</span><span class=p >:</span>
        <span class=sd >"""Formula contains time effect"""</span>
        <span class=k >return</span> <span class=bp >self</span><span class=o >.</span><span class=n >_time_effect</span>

    <span class=nd >@property</span>
    <span class=k >def</span> <span class=nf >context</span><span class=p >(</span><span class=bp >self</span><span class=p >)</span> <span class=o >-&gt;</span> <span class=nb >int</span><span class=p >:</span>
        <span class=sd >"""Set or get the eval env depth"""</span>
        <span class=k >return</span> <span class=bp >self</span><span class=o >.</span><span class=n >_context</span>

    <span class=nd >@context</span><span class=o >.</span><span class=n >setter</span>
    <span class=k >def</span> <span class=nf >context</span><span class=p >(</span><span class=bp >self</span><span class=p >,</span> <span class=n >value</span><span class=p >:</span> <span class=nb >int</span><span class=p >)</span> <span class=o >-&gt;</span> <span class=kc >None</span><span class=p >:</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >_context</span> <span class=o >=</span> <span class=n >value</span>

    <span class=nd >@property</span>
    <span class=k >def</span> <span class=nf >data</span><span class=p >(</span><span class=bp >self</span><span class=p >)</span> <span class=o >-&gt;</span> <span class=nb >tuple</span><span class=p >[</span><span class=n >DataFrame</span><span class=p >,</span> <span class=n >DataFrame</span><span class=p >]:</span>
        <span class=sd >"""Returns a tuple containing the dependent, exog, endog"""</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >_context</span> <span class=o >+=</span> <span class=mi >1</span>
        <span class=n >out</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=p >,</span> <span class=bp >self</span><span class=o >.</span><span class=n >exog</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >_context</span> <span class=o >-=</span> <span class=mi >1</span>
        <span class=k >return</span> <span class=n >out</span>

    <span class=nd >@property</span>
    <span class=k >def</span> <span class=nf >dependent</span><span class=p >(</span><span class=bp >self</span><span class=p >)</span> <span class=o >-&gt;</span> <span class=n >DataFrame</span><span class=p >:</span>
        <span class=sd >"""DataFrame containing the dependent variable"""</span>
        <span class=k >return</span> <span class=n >DataFrame</span><span class=p >(</span>
            <span class=n >model_matrix</span><span class=p >(</span>
                <span class=bp >self</span><span class=o >.</span><span class=n >_lhs</span><span class=p >,</span>
                <span class=bp >self</span><span class=o >.</span><span class=n >_data</span><span class=o >.</span><span class=n >dataframe</span><span class=p >,</span>
                <span class=n >context</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >_context</span><span class=p >,</span>
                <span class=n >na_action</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >_na_action</span><span class=p >,</span>
            <span class=p >)</span>
        <span class=p >)</span>

    <span class=nd >@property</span>
    <span class=k >def</span> <span class=nf >exog</span><span class=p >(</span><span class=bp >self</span><span class=p >)</span> <span class=o >-&gt;</span> <span class=n >DataFrame</span><span class=p >:</span>
        <span class=sd >"""DataFrame containing the exogenous variables"""</span>
        <span class=k >return</span> <span class=n >DataFrame</span><span class=p >(</span>
            <span class=n >model_matrix</span><span class=p >(</span>
                <span class=bp >self</span><span class=o >.</span><span class=n >_rhs</span><span class=p >,</span>
                <span class=bp >self</span><span class=o >.</span><span class=n >_data</span><span class=o >.</span><span class=n >dataframe</span><span class=p >,</span>
                <span class=n >context</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >_context</span><span class=p >,</span>
                <span class=n >na_action</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >_na_action</span><span class=p >,</span>
            <span class=p >)</span>
        <span class=p >)</span>


<span class=k >class</span> <span class=nc >AmbiguityError</span><span class=p >(</span><span class=ne >Exception</span><span class=p >):</span>
    <span class=k >pass</span>


<span class=n >__all__</span> <span class=o >=</span> <span class=p >[</span>
    <span class=s2 >"PanelOLS"</span><span class=p >,</span>
    <span class=s2 >"PooledOLS"</span><span class=p >,</span>
    <span class=s2 >"RandomEffects"</span><span class=p >,</span>
    <span class=s2 >"FirstDifferenceOLS"</span><span class=p >,</span>
    <span class=s2 >"BetweenOLS"</span><span class=p >,</span>
    <span class=s2 >"AmbiguityError"</span><span class=p >,</span>
    <span class=s2 >"FamaMacBeth"</span><span class=p >,</span>
<span class=p >]</span>


<span class=c1 ># Likely</span>
<span class=c1 ># TODO: Formal test of other outputs</span>
<span class=c1 ># Future</span>
<span class=c1 ># TODO: Bootstrap covariance</span>
<span class=c1 ># TODO: Possibly add AIC/BIC</span>
<span class=c1 ># TODO: ML Estimation of RE model</span>
<span class=c1 ># TODO: Defer estimation of 3 R2 values -- slow</span>

<span class=n >EXOG_PREDICT_MSG</span> <span class=o >=</span> <span class=s2 >"""</span><span class=se >\</span>
<span class=s2 >exog does not have the correct number of columns. Saw </span><span class=si >{x_shape}</span><span class=s2 >, expected</span>
<span class=si >{params_shape}</span><span class=s2 >. This can happen since exog is converted to a PanelData object</span>
<span class=s2 >before computing the fitted value. The best practice is to pass a DataFrame</span>
<span class=s2 >with a 2-level MultiIndex containing the entity- and time-ids."""</span>


<span class=k >class</span> <span class=nc >_PanelModelBase</span><span class=p >:</span>
    <span class=sa >r</span><span class=sd >"""</span>
<span class=sd >    Base class for all panel models</span>

<span class=sd >    Parameters</span>
<span class=sd >    ----------</span>
<span class=sd >    dependent : array_like</span>
<span class=sd >        Dependent (left-hand-side) variable (time by entity)</span>
<span class=sd >    exog : array_like</span>
<span class=sd >        Exogenous or right-hand-side variables (variable by time by entity).</span>
<span class=sd >    weights : array_like</span>
<span class=sd >        Weights to use in estimation.  Assumes residual variance is</span>
<span class=sd >        proportional to inverse of weight to that the residual time</span>
<span class=sd >        the weight should be homoskedastic.</span>
<span class=sd >    check_rank : bool</span>
<span class=sd >        Flag indicating whether to perform a rank check on the exogenous</span>
<span class=sd >        variables to ensure that the model is identified. Skipping this</span>
<span class=sd >        check can reduce the time required to validate a model specification.</span>
<span class=sd >        Results may be numerically unstable if this check is skipped and</span>
<span class=sd >        the matrix is not full rank.</span>
<span class=sd >    """</span>

    <span class=k >def</span> <span class=fm >__init__</span><span class=p >(</span>
        <span class=bp >self</span><span class=p >,</span>
        <span class=n >dependent</span><span class=p >:</span> <span class=n >PanelDataLike</span><span class=p >,</span>
        <span class=n >exog</span><span class=p >:</span> <span class=n >PanelDataLike</span><span class=p >,</span>
        <span class=o >*</span><span class=p >,</span>
        <span class=n >weights</span><span class=p >:</span> <span class=n >PanelDataLike</span> <span class=o >|</span> <span class=kc >None</span> <span class=o >=</span> <span class=kc >None</span><span class=p >,</span>
        <span class=n >check_rank</span><span class=p >:</span> <span class=nb >bool</span> <span class=o >=</span> <span class=kc >True</span><span class=p >,</span>
    <span class=p >)</span> <span class=o >-&gt;</span> <span class=kc >None</span><span class=p >:</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span> <span class=o >=</span> <span class=n >PanelData</span><span class=p >(</span><span class=n >dependent</span><span class=p >,</span> <span class=s2 >"Dep"</span><span class=p >)</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >exog</span> <span class=o >=</span> <span class=n >PanelData</span><span class=p >(</span><span class=n >exog</span><span class=p >,</span> <span class=s2 >"Exog"</span><span class=p >)</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >_original_shape</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >shape</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >_constant</span> <span class=o >=</span> <span class=kc >False</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >_formula</span><span class=p >:</span> <span class=nb >str</span> <span class=o >|</span> <span class=kc >None</span> <span class=o >=</span> <span class=kc >None</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >_is_weighted</span> <span class=o >=</span> <span class=kc >True</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >_name</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=vm >__class__</span><span class=o >.</span><span class=vm >__name__</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >weights</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_adapt_weights</span><span class=p >(</span><span class=n >weights</span><span class=p >)</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >_not_null</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >ones</span><span class=p >(</span><span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >values2d</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >],</span> <span class=n >dtype</span><span class=o >=</span><span class=nb >bool</span><span class=p >)</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >_cov_estimators</span> <span class=o >=</span> <span class=n >CovarianceManager</span><span class=p >(</span>
            <span class=bp >self</span><span class=o >.</span><span class=vm >__class__</span><span class=o >.</span><span class=vm >__name__</span><span class=p >,</span>
            <span class=n >HomoskedasticCovariance</span><span class=p >,</span>
            <span class=n >HeteroskedasticCovariance</span><span class=p >,</span>
            <span class=n >ClusteredCovariance</span><span class=p >,</span>
            <span class=n >DriscollKraay</span><span class=p >,</span>
            <span class=n >ACCovariance</span><span class=p >,</span>
        <span class=p >)</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >_original_index</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >index</span><span class=o >.</span><span class=n >copy</span><span class=p >()</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >_constant_index</span><span class=p >:</span> <span class=nb >int</span> <span class=o >|</span> <span class=kc >None</span> <span class=o >=</span> <span class=kc >None</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >_check_rank</span> <span class=o >=</span> <span class=nb >bool</span><span class=p >(</span><span class=n >check_rank</span><span class=p >)</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >_validate_data</span><span class=p >()</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >_singleton_index</span><span class=p >:</span> <span class=n >BoolArray</span> <span class=o >|</span> <span class=kc >None</span> <span class=o >=</span> <span class=kc >None</span>

    <span class=k >def</span> <span class=fm >__str__</span><span class=p >(</span><span class=bp >self</span><span class=p >)</span> <span class=o >-&gt;</span> <span class=nb >str</span><span class=p >:</span>
        <span class=n >out</span> <span class=o >=</span> <span class=s2 >"</span><span class=si >{name}</span><span class=s2 > </span><span class=se >\n</span><span class=s2 >Num exog: </span><span class=si >{num_exog}</span><span class=s2 >, Constant: </span><span class=si >{has_constant}</span><span class=s2 >"</span>
        <span class=k >return</span> <span class=n >out</span><span class=o >.</span><span class=n >format</span><span class=p >(</span>
            <span class=n >name</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=vm >__class__</span><span class=o >.</span><span class=vm >__name__</span><span class=p >,</span>
            <span class=n >num_exog</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >exog</span><span class=o >.</span><span class=n >dataframe</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >1</span><span class=p >],</span>
            <span class=n >has_constant</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >has_constant</span><span class=p >,</span>
        <span class=p >)</span>

    <span class=k >def</span> <span class=fm >__repr__</span><span class=p >(</span><span class=bp >self</span><span class=p >)</span> <span class=o >-&gt;</span> <span class=nb >str</span><span class=p >:</span>
        <span class=k >return</span> <span class=bp >self</span><span class=o >.</span><span class=fm >__str__</span><span class=p >()</span> <span class=o >+</span> <span class=s2 >"</span><span class=se >\n</span><span class=s2 >id: "</span> <span class=o >+</span> <span class=nb >str</span><span class=p >(</span><span class=nb >hex</span><span class=p >(</span><span class=nb >id</span><span class=p >(</span><span class=bp >self</span><span class=p >)))</span>

    <span class=k >def</span> <span class=nf >reformat_clusters</span><span class=p >(</span><span class=bp >self</span><span class=p >,</span> <span class=n >clusters</span><span class=p >:</span> <span class=n >PanelDataLike</span><span class=p >)</span> <span class=o >-&gt;</span> <span class=n >PanelData</span><span class=p >:</span>
        <span class=sd >"""</span>
<span class=sd >        Reformat cluster variables</span>

<span class=sd >        Parameters</span>
<span class=sd >        ----------</span>
<span class=sd >        clusters : array_like</span>
<span class=sd >            Values to use for variance clustering</span>

<span class=sd >        Returns</span>
<span class=sd >        -------</span>
<span class=sd >        PanelData</span>
<span class=sd >            Original data with matching axis and observation dropped where</span>
<span class=sd >            missing in the model data.</span>

<span class=sd >        Notes</span>
<span class=sd >        -----</span>
<span class=sd >        This is exposed for testing and is not normally needed for estimation</span>
<span class=sd >        """</span>
        <span class=n >clusters_pd</span> <span class=o >=</span> <span class=n >PanelData</span><span class=p >(</span><span class=n >clusters</span><span class=p >,</span> <span class=n >var_name</span><span class=o >=</span><span class=s2 >"cov.cluster"</span><span class=p >,</span> <span class=n >convert_dummies</span><span class=o >=</span><span class=kc >False</span><span class=p >)</span>
        <span class=k >if</span> <span class=n >clusters_pd</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >1</span><span class=p >:]</span> <span class=o >!=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_original_shape</span><span class=p >[</span><span class=mi >1</span><span class=p >:]:</span>
            <span class=k >raise</span> <span class=ne >ValueError</span><span class=p >(</span>
                <span class=s2 >"clusters must have the same number of entities "</span>
                <span class=s2 >"and time periods as the model data."</span>
            <span class=p >)</span>
        <span class=n >clusters_pd</span><span class=o >.</span><span class=n >drop</span><span class=p >(</span><span class=o >~</span><span class=bp >self</span><span class=o >.</span><span class=n >not_null</span><span class=p >)</span>
        <span class=k >return</span> <span class=n >clusters_pd</span><span class=o >.</span><span class=n >copy</span><span class=p >()</span>

    <span class=k >def</span> <span class=nf >_info</span><span class=p >(</span><span class=bp >self</span><span class=p >)</span> <span class=o >-&gt;</span> <span class=nb >tuple</span><span class=p >[</span><span class=n >Series</span><span class=p >,</span> <span class=n >Series</span><span class=p >,</span> <span class=kc >None</span><span class=p >]:</span>
        <span class=sd >"""Information about panel structure"""</span>

        <span class=n >entity_info</span> <span class=o >=</span> <span class=n >panel_structure_stats</span><span class=p >(</span>
            <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >entity_ids</span><span class=o >.</span><span class=n >squeeze</span><span class=p >(),</span> <span class=s2 >"Observations per entity"</span>
        <span class=p >)</span>
        <span class=n >time_info</span> <span class=o >=</span> <span class=n >panel_structure_stats</span><span class=p >(</span>
            <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >time_ids</span><span class=o >.</span><span class=n >squeeze</span><span class=p >(),</span> <span class=s2 >"Observations per time period"</span>
        <span class=p >)</span>
        <span class=n >other_info</span> <span class=o >=</span> <span class=kc >None</span>

        <span class=k >return</span> <span class=n >entity_info</span><span class=p >,</span> <span class=n >time_info</span><span class=p >,</span> <span class=n >other_info</span>

    <span class=k >def</span> <span class=nf >_adapt_weights</span><span class=p >(</span><span class=bp >self</span><span class=p >,</span> <span class=n >weights</span><span class=p >:</span> <span class=n >PanelDataLike</span> <span class=o >|</span> <span class=kc >None</span><span class=p >)</span> <span class=o >-&gt;</span> <span class=n >PanelData</span><span class=p >:</span>
        <span class=sd >"""Check and transform weights depending on size"""</span>
        <span class=k >if</span> <span class=n >weights</span> <span class=ow >is</span> <span class=kc >None</span><span class=p >:</span>
            <span class=bp >self</span><span class=o >.</span><span class=n >_is_weighted</span> <span class=o >=</span> <span class=kc >False</span>
            <span class=n >frame</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >dataframe</span><span class=o >.</span><span class=n >copy</span><span class=p >()</span>
            <span class=n >frame</span><span class=o >.</span><span class=n >iloc</span><span class=p >[:,</span> <span class=p >:]</span> <span class=o >=</span> <span class=mi >1</span>
            <span class=c1 ># TODO: Remove once pandas typing fixed</span>
            <span class=n >frame</span><span class=o >.</span><span class=n >columns</span> <span class=o >=</span> <span class=n >Index</span><span class=p >([</span><span class=s2 >"weight"</span><span class=p >])</span>
            <span class=k >return</span> <span class=n >PanelData</span><span class=p >(</span><span class=n >frame</span><span class=p >)</span>

        <span class=n >frame</span> <span class=o >=</span> <span class=n >DataFrame</span><span class=p >(</span><span class=n >columns</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >entities</span><span class=p >,</span> <span class=n >index</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >time</span><span class=p >)</span>
        <span class=n >nobs</span><span class=p >,</span> <span class=n >nentity</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >exog</span><span class=o >.</span><span class=n >nobs</span><span class=p >,</span> <span class=bp >self</span><span class=o >.</span><span class=n >exog</span><span class=o >.</span><span class=n >nentity</span>

        <span class=k >if</span> <span class=n >weights</span><span class=o >.</span><span class=n >ndim</span> <span class=o >==</span> <span class=mi >3</span> <span class=ow >or</span> <span class=n >weights</span><span class=o >.</span><span class=n >shape</span> <span class=o >==</span> <span class=p >(</span><span class=n >nobs</span><span class=p >,</span> <span class=n >nentity</span><span class=p >):</span>
            <span class=k >return</span> <span class=n >PanelData</span><span class=p >(</span><span class=n >weights</span><span class=p >)</span>

        <span class=k >if</span> <span class=nb >isinstance</span><span class=p >(</span><span class=n >weights</span><span class=p >,</span> <span class=n >np</span><span class=o >.</span><span class=n >ndarray</span><span class=p >):</span>
            <span class=n >weights</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span><span class=n >Float64Array</span><span class=p >,</span> <span class=n >np</span><span class=o >.</span><span class=n >squeeze</span><span class=p >(</span><span class=n >weights</span><span class=p >))</span>
        <span class=k >if</span> <span class=n >weights</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >]</span> <span class=o >==</span> <span class=n >nobs</span> <span class=ow >and</span> <span class=n >nobs</span> <span class=o >==</span> <span class=n >nentity</span><span class=p >:</span>
            <span class=k >raise</span> <span class=n >AmbiguityError</span><span class=p >(</span>
                <span class=s2 >"Unable to distinguish nobs form nentity since they are "</span>
                <span class=s2 >"equal. You must use an 2-d array to avoid ambiguity."</span>
            <span class=p >)</span>
        <span class=k >if</span> <span class=p >(</span>
            <span class=nb >isinstance</span><span class=p >(</span><span class=n >weights</span><span class=p >,</span> <span class=p >(</span><span class=n >Series</span><span class=p >,</span> <span class=n >DataFrame</span><span class=p >))</span>
            <span class=ow >and</span> <span class=nb >isinstance</span><span class=p >(</span><span class=n >weights</span><span class=o >.</span><span class=n >index</span><span class=p >,</span> <span class=n >MultiIndex</span><span class=p >)</span>
            <span class=ow >and</span> <span class=n >weights</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >]</span> <span class=o >==</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >dataframe</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >]</span>
        <span class=p >):</span>
            <span class=n >frame</span> <span class=o >=</span> <span class=n >DataFrame</span><span class=p >(</span><span class=n >weights</span><span class=p >)</span>
        <span class=k >elif</span> <span class=n >weights</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >]</span> <span class=o >==</span> <span class=n >nobs</span><span class=p >:</span>
            <span class=n >weights_arr</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >asarray</span><span class=p >(</span><span class=n >weights</span><span class=p >)[:,</span> <span class=kc >None</span><span class=p >]</span>
            <span class=n >weights_arr</span> <span class=o >=</span> <span class=n >weights_arr</span> <span class=o >@</span> <span class=n >np</span><span class=o >.</span><span class=n >ones</span><span class=p >((</span><span class=mi >1</span><span class=p >,</span> <span class=n >nentity</span><span class=p >))</span>
            <span class=n >frame</span><span class=o >.</span><span class=n >iloc</span><span class=p >[:,</span> <span class=p >:]</span> <span class=o >=</span> <span class=n >weights_arr</span>
        <span class=k >elif</span> <span class=n >weights</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >]</span> <span class=o >==</span> <span class=n >nentity</span><span class=p >:</span>
            <span class=n >weights_arr</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >asarray</span><span class=p >(</span><span class=n >weights</span><span class=p >)[</span><span class=kc >None</span><span class=p >,</span> <span class=p >:]</span>
            <span class=n >weights_arr</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >ones</span><span class=p >((</span><span class=n >nobs</span><span class=p >,</span> <span class=mi >1</span><span class=p >))</span> <span class=o >@</span> <span class=n >weights_arr</span>
            <span class=n >frame</span><span class=o >.</span><span class=n >iloc</span><span class=p >[:,</span> <span class=p >:]</span> <span class=o >=</span> <span class=n >weights_arr</span>
        <span class=k >elif</span> <span class=n >weights</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >]</span> <span class=o >==</span> <span class=n >nentity</span> <span class=o >*</span> <span class=n >nobs</span><span class=p >:</span>
            <span class=n >frame</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >dataframe</span><span class=o >.</span><span class=n >copy</span><span class=p >()</span>
            <span class=n >frame</span><span class=o >.</span><span class=n >iloc</span><span class=p >[:,</span> <span class=p >:]</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >asarray</span><span class=p >(</span><span class=n >weights</span><span class=p >)[:,</span> <span class=kc >None</span><span class=p >]</span>
        <span class=k >else</span><span class=p >:</span>
            <span class=k >raise</span> <span class=ne >ValueError</span><span class=p >(</span><span class=s2 >"Weights do not have a supported shape."</span><span class=p >)</span>
        <span class=k >return</span> <span class=n >PanelData</span><span class=p >(</span><span class=n >frame</span><span class=p >)</span>

    <span class=k >def</span> <span class=nf >_check_exog_rank</span><span class=p >(</span><span class=bp >self</span><span class=p >)</span> <span class=o >-&gt;</span> <span class=nb >int</span><span class=p >:</span>
        <span class=k >if</span> <span class=ow >not</span> <span class=bp >self</span><span class=o >.</span><span class=n >_check_rank</span><span class=p >:</span>
            <span class=k >return</span> <span class=bp >self</span><span class=o >.</span><span class=n >exog</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >1</span><span class=p >]</span>
        <span class=n >x</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span><span class=n >Float64Array</span><span class=p >,</span> <span class=bp >self</span><span class=o >.</span><span class=n >exog</span><span class=o >.</span><span class=n >values2d</span><span class=p >)</span>
        <span class=n >_</span><span class=p >,</span> <span class=n >_</span><span class=p >,</span> <span class=n >rank_of_x</span><span class=p >,</span> <span class=n >_</span> <span class=o >=</span> <span class=n >_lstsq</span><span class=p >(</span><span class=n >x</span><span class=p >,</span> <span class=n >np</span><span class=o >.</span><span class=n >ones</span><span class=p >(</span><span class=n >x</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >]))</span>
        <span class=k >if</span> <span class=n >rank_of_x</span> <span class=o >&lt;</span> <span class=n >x</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >1</span><span class=p >]:</span>
            <span class=k >raise</span> <span class=ne >ValueError</span><span class=p >(</span>
                <span class=s2 >"exog does not have full column rank. If you wish to proceed with "</span>
                <span class=s2 >"model estimation irrespective of the numerical accuracy of "</span>
                <span class=s2 >"coefficient estimates, you can set check_rank=False."</span>
            <span class=p >)</span>
        <span class=k >return</span> <span class=n >rank_of_x</span>

    <span class=k >def</span> <span class=nf >_validate_data</span><span class=p >(</span><span class=bp >self</span><span class=p >)</span> <span class=o >-&gt;</span> <span class=kc >None</span><span class=p >:</span>
        <span class=sd >"""Check input shape and remove missing"""</span>
        <span class=n >y</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_y</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span><span class=n >Float64Array</span><span class=p >,</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >values2d</span><span class=p >)</span>
        <span class=n >x</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_x</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span><span class=n >Float64Array</span><span class=p >,</span> <span class=bp >self</span><span class=o >.</span><span class=n >exog</span><span class=o >.</span><span class=n >values2d</span><span class=p >)</span>
        <span class=n >w</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_w</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span><span class=n >Float64Array</span><span class=p >,</span> <span class=bp >self</span><span class=o >.</span><span class=n >weights</span><span class=o >.</span><span class=n >values2d</span><span class=p >)</span>
        <span class=k >if</span> <span class=n >y</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >]</span> <span class=o >!=</span> <span class=n >x</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >]:</span>
            <span class=k >raise</span> <span class=ne >ValueError</span><span class=p >(</span>
                <span class=s2 >"dependent and exog must have the same number of "</span>
                <span class=s2 >"observations. The number of observations in dependent "</span>
                <span class=sa >f</span><span class=s2 >"is </span><span class=si >{</span><span class=n >y</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >]</span><span class=si >}</span><span class=s2 >, and the number of observations in exog "</span>
                <span class=sa >f</span><span class=s2 >"is </span><span class=si >{</span><span class=n >x</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >]</span><span class=si >}</span><span class=s2 >."</span>
            <span class=p >)</span>
        <span class=k >if</span> <span class=n >y</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >]</span> <span class=o >!=</span> <span class=n >w</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >]:</span>
            <span class=k >raise</span> <span class=ne >ValueError</span><span class=p >(</span>
                <span class=s2 >"weights must have the same number of "</span> <span class=s2 >"observations as dependent."</span>
            <span class=p >)</span>

        <span class=n >all_missing</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >any</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >isnan</span><span class=p >(</span><span class=n >y</span><span class=p >),</span> <span class=n >axis</span><span class=o >=</span><span class=mi >1</span><span class=p >)</span> <span class=o >&amp;</span> <span class=n >np</span><span class=o >.</span><span class=n >all</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >isnan</span><span class=p >(</span><span class=n >x</span><span class=p >),</span> <span class=n >axis</span><span class=o >=</span><span class=mi >1</span><span class=p >)</span>
        <span class=n >missing</span> <span class=o >=</span> <span class=p >(</span>
            <span class=n >np</span><span class=o >.</span><span class=n >any</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >isnan</span><span class=p >(</span><span class=n >y</span><span class=p >),</span> <span class=n >axis</span><span class=o >=</span><span class=mi >1</span><span class=p >)</span>
            <span class=o >|</span> <span class=n >np</span><span class=o >.</span><span class=n >any</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >isnan</span><span class=p >(</span><span class=n >x</span><span class=p >),</span> <span class=n >axis</span><span class=o >=</span><span class=mi >1</span><span class=p >)</span>
            <span class=o >|</span> <span class=n >np</span><span class=o >.</span><span class=n >any</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >isnan</span><span class=p >(</span><span class=n >w</span><span class=p >),</span> <span class=n >axis</span><span class=o >=</span><span class=mi >1</span><span class=p >)</span>
        <span class=p >)</span>

        <span class=n >missing_warning</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >asarray</span><span class=p >(</span><span class=n >all_missing</span> <span class=o >^</span> <span class=n >missing</span><span class=p >),</span> <span class=n >stacklevel</span><span class=o >=</span><span class=mi >4</span><span class=p >)</span>
        <span class=k >if</span> <span class=n >np</span><span class=o >.</span><span class=n >any</span><span class=p >(</span><span class=n >missing</span><span class=p >):</span>
            <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >drop</span><span class=p >(</span><span class=n >missing</span><span class=p >)</span>
            <span class=bp >self</span><span class=o >.</span><span class=n >exog</span><span class=o >.</span><span class=n >drop</span><span class=p >(</span><span class=n >missing</span><span class=p >)</span>
            <span class=bp >self</span><span class=o >.</span><span class=n >weights</span><span class=o >.</span><span class=n >drop</span><span class=p >(</span><span class=n >missing</span><span class=p >)</span>

            <span class=n >x</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span><span class=n >Float64Array</span><span class=p >,</span> <span class=bp >self</span><span class=o >.</span><span class=n >exog</span><span class=o >.</span><span class=n >values2d</span><span class=p >)</span>
            <span class=bp >self</span><span class=o >.</span><span class=n >_not_null</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >asarray</span><span class=p >(</span><span class=o >~</span><span class=n >missing</span><span class=p >)</span>

        <span class=n >w_df</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >weights</span><span class=o >.</span><span class=n >dataframe</span>
        <span class=k >if</span> <span class=n >np</span><span class=o >.</span><span class=n >any</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >asarray</span><span class=p >(</span><span class=n >w_df</span><span class=p >)</span> <span class=o >&lt;=</span> <span class=mi >0</span><span class=p >):</span>
            <span class=k >raise</span> <span class=ne >ValueError</span><span class=p >(</span><span class=s2 >"weights must be strictly positive."</span><span class=p >)</span>
        <span class=n >w_df</span> <span class=o >=</span> <span class=n >w_df</span> <span class=o >/</span> <span class=n >w_df</span><span class=o >.</span><span class=n >mean</span><span class=p >()</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >weights</span> <span class=o >=</span> <span class=n >PanelData</span><span class=p >(</span><span class=n >w_df</span><span class=p >)</span>
        <span class=n >rank_of_x</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_check_exog_rank</span><span class=p >()</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >_constant</span><span class=p >,</span> <span class=bp >self</span><span class=o >.</span><span class=n >_constant_index</span> <span class=o >=</span> <span class=n >has_constant</span><span class=p >(</span><span class=n >x</span><span class=p >,</span> <span class=n >rank_of_x</span><span class=p >)</span>

    <span class=nd >@property</span>
    <span class=k >def</span> <span class=nf >formula</span><span class=p >(</span><span class=bp >self</span><span class=p >)</span> <span class=o >-&gt;</span> <span class=nb >str</span> <span class=o >|</span> <span class=kc >None</span><span class=p >:</span>
        <span class=sd >"""Formula used to construct the model"""</span>
        <span class=k >return</span> <span class=bp >self</span><span class=o >.</span><span class=n >_formula</span>

    <span class=nd >@formula</span><span class=o >.</span><span class=n >setter</span>
    <span class=k >def</span> <span class=nf >formula</span><span class=p >(</span><span class=bp >self</span><span class=p >,</span> <span class=n >value</span><span class=p >:</span> <span class=nb >str</span> <span class=o >|</span> <span class=kc >None</span><span class=p >)</span> <span class=o >-&gt;</span> <span class=kc >None</span><span class=p >:</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >_formula</span> <span class=o >=</span> <span class=n >value</span>

    <span class=nd >@property</span>
    <span class=k >def</span> <span class=nf >has_constant</span><span class=p >(</span><span class=bp >self</span><span class=p >)</span> <span class=o >-&gt;</span> <span class=nb >bool</span><span class=p >:</span>
        <span class=sd >"""Flag indicating the model a constant or implicit constant"""</span>
        <span class=k >return</span> <span class=bp >self</span><span class=o >.</span><span class=n >_constant</span>

    <span class=k >def</span> <span class=nf >_f_statistic</span><span class=p >(</span>
        <span class=bp >self</span><span class=p >,</span>
        <span class=n >weps</span><span class=p >:</span> <span class=n >Float64Array</span><span class=p >,</span>
        <span class=n >y</span><span class=p >:</span> <span class=n >Float64Array</span><span class=p >,</span>
        <span class=n >x</span><span class=p >:</span> <span class=n >Float64Array</span><span class=p >,</span>
        <span class=n >root_w</span><span class=p >:</span> <span class=n >Float64Array</span><span class=p >,</span>
        <span class=n >df_resid</span><span class=p >:</span> <span class=nb >int</span><span class=p >,</span>
    <span class=p >)</span> <span class=o >-&gt;</span> <span class=n >WaldTestStatistic</span> <span class=o >|</span> <span class=n >InvalidTestStatistic</span><span class=p >:</span>
        <span class=sd >"""Compute model F-statistic"""</span>
        <span class=n >weps_const</span> <span class=o >=</span> <span class=n >y</span>
        <span class=n >num_df</span> <span class=o >=</span> <span class=n >x</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >1</span><span class=p >]</span>
        <span class=n >name</span> <span class=o >=</span> <span class=s2 >"Model F-statistic (homoskedastic)"</span>
        <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >has_constant</span><span class=p >:</span>
            <span class=k >if</span> <span class=n >num_df</span> <span class=o >==</span> <span class=mi >1</span><span class=p >:</span>
                <span class=k >return</span> <span class=n >InvalidTestStatistic</span><span class=p >(</span><span class=s2 >"Model contains only a constant"</span><span class=p >,</span> <span class=n >name</span><span class=o >=</span><span class=n >name</span><span class=p >)</span>

            <span class=n >num_df</span> <span class=o >-=</span> <span class=mi >1</span>
            <span class=n >weps_const</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span>
                <span class=n >Float64Array</span><span class=p >,</span> <span class=n >y</span> <span class=o >-</span> <span class=nb >float</span><span class=p >((</span><span class=n >root_w</span><span class=o >.</span><span class=n >T</span> <span class=o >@</span> <span class=n >y</span><span class=p >)</span> <span class=o >/</span> <span class=p >(</span><span class=n >root_w</span><span class=o >.</span><span class=n >T</span> <span class=o >@</span> <span class=n >root_w</span><span class=p >))</span>
            <span class=p >)</span>

        <span class=n >resid_ss</span> <span class=o >=</span> <span class=n >weps</span><span class=o >.</span><span class=n >T</span> <span class=o >@</span> <span class=n >weps</span>
        <span class=n >num</span> <span class=o >=</span> <span class=nb >float</span><span class=p >(</span><span class=n >weps_const</span><span class=o >.</span><span class=n >T</span> <span class=o >@</span> <span class=n >weps_const</span> <span class=o >-</span> <span class=n >resid_ss</span><span class=p >)</span>
        <span class=n >denom</span> <span class=o >=</span> <span class=n >resid_ss</span>
        <span class=n >denom_df</span> <span class=o >=</span> <span class=n >df_resid</span>
        <span class=n >stat</span> <span class=o >=</span> <span class=nb >float</span><span class=p >((</span><span class=n >num</span> <span class=o >/</span> <span class=n >num_df</span><span class=p >)</span> <span class=o >/</span> <span class=p >(</span><span class=n >denom</span> <span class=o >/</span> <span class=n >denom_df</span><span class=p >))</span> <span class=k >if</span> <span class=n >denom</span> <span class=o >&gt;</span> <span class=mf >0.0</span> <span class=k >else</span> <span class=mf >0.0</span>
        <span class=k >return</span> <span class=n >WaldTestStatistic</span><span class=p >(</span>
            <span class=n >stat</span><span class=p >,</span>
            <span class=n >null</span><span class=o >=</span><span class=s2 >"All parameters ex. constant are zero"</span><span class=p >,</span>
            <span class=n >df</span><span class=o >=</span><span class=n >num_df</span><span class=p >,</span>
            <span class=n >df_denom</span><span class=o >=</span><span class=n >denom_df</span><span class=p >,</span>
            <span class=n >name</span><span class=o >=</span><span class=n >name</span><span class=p >,</span>
        <span class=p >)</span>

    <span class=k >def</span> <span class=nf >_f_statistic_robust</span><span class=p >(</span>
        <span class=bp >self</span><span class=p >,</span>
        <span class=n >params</span><span class=p >:</span> <span class=n >Float64Array</span><span class=p >,</span>
    <span class=p >)</span> <span class=o >-&gt;</span> <span class=n >FInfo</span><span class=p >:</span>
        <span class=sd >"""Compute Wald test that all parameters are 0, ex. constant"""</span>
        <span class=n >sel</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >ones</span><span class=p >(</span><span class=n >params</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >],</span> <span class=n >dtype</span><span class=o >=</span><span class=nb >bool</span><span class=p >)</span>
        <span class=n >name</span> <span class=o >=</span> <span class=s2 >"Model F-statistic (robust)"</span>

        <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >has_constant</span><span class=p >:</span>
            <span class=k >if</span> <span class=nb >len</span><span class=p >(</span><span class=n >sel</span><span class=p >)</span> <span class=o >==</span> <span class=mi >1</span><span class=p >:</span>
                <span class=k >return</span> <span class=n >FInfo</span><span class=p >(</span>
                    <span class=n >sel</span><span class=p >,</span>
                    <span class=n >name</span><span class=p >,</span>
                    <span class=n >InvalidTestStatistic</span><span class=p >(</span><span class=s2 >"Model contains only a constant"</span><span class=p >,</span> <span class=n >name</span><span class=o >=</span><span class=n >name</span><span class=p >),</span>
                    <span class=kc >True</span><span class=p >,</span>
                <span class=p >)</span>
            <span class=k >assert</span> <span class=nb >isinstance</span><span class=p >(</span><span class=bp >self</span><span class=o >.</span><span class=n >_constant_index</span><span class=p >,</span> <span class=nb >int</span><span class=p >)</span>
            <span class=n >sel</span><span class=p >[</span><span class=bp >self</span><span class=o >.</span><span class=n >_constant_index</span><span class=p >]</span> <span class=o >=</span> <span class=kc >False</span>

        <span class=k >return</span> <span class=n >FInfo</span><span class=p >(</span><span class=n >sel</span><span class=p >,</span> <span class=n >name</span><span class=p >,</span> <span class=kc >None</span><span class=p >,</span> <span class=kc >False</span><span class=p >)</span>

    <span class=k >def</span> <span class=nf >_prepare_between</span><span class=p >(</span><span class=bp >self</span><span class=p >)</span> <span class=o >-&gt;</span> <span class=nb >tuple</span><span class=p >[</span><span class=n >Float64Array</span><span class=p >,</span> <span class=n >Float64Array</span><span class=p >,</span> <span class=n >Float64Array</span><span class=p >]:</span>
        <span class=sd >"""Prepare values for between estimation of R2"""</span>
        <span class=n >weights</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >weights</span> <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >_is_weighted</span> <span class=k >else</span> <span class=kc >None</span>
        <span class=n >y</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >asarray</span><span class=p >(</span><span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >mean</span><span class=p >(</span><span class=s2 >"entity"</span><span class=p >,</span> <span class=n >weights</span><span class=o >=</span><span class=n >weights</span><span class=p >))</span>
        <span class=n >x</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >asarray</span><span class=p >(</span><span class=bp >self</span><span class=o >.</span><span class=n >exog</span><span class=o >.</span><span class=n >mean</span><span class=p >(</span><span class=s2 >"entity"</span><span class=p >,</span> <span class=n >weights</span><span class=o >=</span><span class=n >weights</span><span class=p >))</span>
        <span class=c1 ># Weight transformation</span>
        <span class=n >wcount</span><span class=p >,</span> <span class=n >wmean</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >weights</span><span class=o >.</span><span class=n >count</span><span class=p >(</span><span class=s2 >"entity"</span><span class=p >),</span> <span class=bp >self</span><span class=o >.</span><span class=n >weights</span><span class=o >.</span><span class=n >mean</span><span class=p >(</span><span class=s2 >"entity"</span><span class=p >)</span>
        <span class=n >wsum</span> <span class=o >=</span> <span class=n >wcount</span> <span class=o >*</span> <span class=n >wmean</span>
        <span class=n >w</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >asarray</span><span class=p >(</span><span class=n >wsum</span><span class=p >)</span>
        <span class=n >w</span> <span class=o >=</span> <span class=n >w</span> <span class=o >/</span> <span class=n >w</span><span class=o >.</span><span class=n >mean</span><span class=p >()</span>

        <span class=k >return</span> <span class=n >y</span><span class=p >,</span> <span class=n >x</span><span class=p >,</span> <span class=n >w</span>

    <span class=k >def</span> <span class=nf >_rsquared_corr</span><span class=p >(</span><span class=bp >self</span><span class=p >,</span> <span class=n >params</span><span class=p >:</span> <span class=n >Float64Array</span><span class=p >)</span> <span class=o >-&gt;</span> <span class=nb >tuple</span><span class=p >[</span><span class=nb >float</span><span class=p >,</span> <span class=nb >float</span><span class=p >,</span> <span class=nb >float</span><span class=p >]:</span>
        <span class=sd >"""Correlation-based measures of R2"""</span>
        <span class=c1 ># Overall</span>
        <span class=n >y</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >values2d</span>
        <span class=n >x</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >exog</span><span class=o >.</span><span class=n >values2d</span>
        <span class=n >xb</span> <span class=o >=</span> <span class=n >x</span> <span class=o >@</span> <span class=n >params</span>
        <span class=n >r2o</span> <span class=o >=</span> <span class=mf >0.0</span>
        <span class=k >if</span> <span class=n >y</span><span class=o >.</span><span class=n >std</span><span class=p >()</span> <span class=o >&gt;</span> <span class=mi >0</span> <span class=ow >and</span> <span class=n >xb</span><span class=o >.</span><span class=n >std</span><span class=p >()</span> <span class=o >&gt;</span> <span class=mi >0</span><span class=p >:</span>
            <span class=n >r2o</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >corrcoef</span><span class=p >(</span><span class=n >y</span><span class=o >.</span><span class=n >T</span><span class=p >,</span> <span class=p >(</span><span class=n >x</span> <span class=o >@</span> <span class=n >params</span><span class=p >)</span><span class=o >.</span><span class=n >T</span><span class=p >)[</span><span class=mi >0</span><span class=p >,</span> <span class=mi >1</span><span class=p >]</span>
        <span class=c1 ># Between</span>
        <span class=n >y</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >asarray</span><span class=p >(</span><span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >mean</span><span class=p >(</span><span class=s2 >"entity"</span><span class=p >))</span>
        <span class=n >x</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >asarray</span><span class=p >(</span><span class=bp >self</span><span class=o >.</span><span class=n >exog</span><span class=o >.</span><span class=n >mean</span><span class=p >(</span><span class=s2 >"entity"</span><span class=p >))</span>
        <span class=n >xb</span> <span class=o >=</span> <span class=n >x</span> <span class=o >@</span> <span class=n >params</span>
        <span class=n >r2b</span> <span class=o >=</span> <span class=mf >0.0</span>
        <span class=k >if</span> <span class=n >y</span><span class=o >.</span><span class=n >std</span><span class=p >()</span> <span class=o >&gt;</span> <span class=mi >0</span> <span class=ow >and</span> <span class=n >xb</span><span class=o >.</span><span class=n >std</span><span class=p >()</span> <span class=o >&gt;</span> <span class=mi >0</span><span class=p >:</span>
            <span class=n >r2b</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >corrcoef</span><span class=p >(</span><span class=n >y</span><span class=o >.</span><span class=n >T</span><span class=p >,</span> <span class=p >(</span><span class=n >x</span> <span class=o >@</span> <span class=n >params</span><span class=p >)</span><span class=o >.</span><span class=n >T</span><span class=p >)[</span><span class=mi >0</span><span class=p >,</span> <span class=mi >1</span><span class=p >]</span>

        <span class=c1 ># Within</span>
        <span class=n >y</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span><span class=n >Float64Array</span><span class=p >,</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >demean</span><span class=p >(</span><span class=s2 >"entity"</span><span class=p >,</span> <span class=n >return_panel</span><span class=o >=</span><span class=kc >False</span><span class=p >))</span>
        <span class=n >x</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span><span class=n >Float64Array</span><span class=p >,</span> <span class=bp >self</span><span class=o >.</span><span class=n >exog</span><span class=o >.</span><span class=n >demean</span><span class=p >(</span><span class=s2 >"entity"</span><span class=p >,</span> <span class=n >return_panel</span><span class=o >=</span><span class=kc >False</span><span class=p >))</span>
        <span class=n >xb</span> <span class=o >=</span> <span class=n >x</span> <span class=o >@</span> <span class=n >params</span>
        <span class=n >r2w</span> <span class=o >=</span> <span class=mf >0.0</span>
        <span class=k >if</span> <span class=n >y</span><span class=o >.</span><span class=n >std</span><span class=p >()</span> <span class=o >&gt;</span> <span class=mi >0</span> <span class=ow >and</span> <span class=n >xb</span><span class=o >.</span><span class=n >std</span><span class=p >()</span> <span class=o >&gt;</span> <span class=mi >0</span><span class=p >:</span>
            <span class=n >r2w</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >corrcoef</span><span class=p >(</span><span class=n >y</span><span class=o >.</span><span class=n >T</span><span class=p >,</span> <span class=n >xb</span><span class=o >.</span><span class=n >T</span><span class=p >)[</span><span class=mi >0</span><span class=p >,</span> <span class=mi >1</span><span class=p >]</span>

        <span class=k >return</span> <span class=n >r2o</span><span class=o >**</span><span class=mi >2</span><span class=p >,</span> <span class=n >r2w</span><span class=o >**</span><span class=mi >2</span><span class=p >,</span> <span class=n >r2b</span><span class=o >**</span><span class=mi >2</span>

    <span class=k >def</span> <span class=nf >_rsquared</span><span class=p >(</span>
        <span class=bp >self</span><span class=p >,</span> <span class=n >params</span><span class=p >:</span> <span class=n >Float64Array</span><span class=p >,</span> <span class=n >reweight</span><span class=p >:</span> <span class=nb >bool</span> <span class=o >=</span> <span class=kc >False</span>
    <span class=p >)</span> <span class=o >-&gt;</span> <span class=nb >tuple</span><span class=p >[</span><span class=nb >float</span><span class=p >,</span> <span class=nb >float</span><span class=p >,</span> <span class=nb >float</span><span class=p >]:</span>
        <span class=sd >"""Compute alternative measures of R2"""</span>
        <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >has_constant</span> <span class=ow >and</span> <span class=bp >self</span><span class=o >.</span><span class=n >exog</span><span class=o >.</span><span class=n >nvar</span> <span class=o >==</span> <span class=mi >1</span><span class=p >:</span>
            <span class=c1 ># Constant only fast track</span>
            <span class=k >return</span> <span class=mf >0.0</span><span class=p >,</span> <span class=mf >0.0</span><span class=p >,</span> <span class=mf >0.0</span>

        <span class=c1 >#############################################</span>
        <span class=c1 ># R2 - Between</span>
        <span class=c1 >#############################################</span>
        <span class=n >y</span><span class=p >,</span> <span class=n >x</span><span class=p >,</span> <span class=n >w</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_prepare_between</span><span class=p >()</span>
        <span class=k >if</span> <span class=n >np</span><span class=o >.</span><span class=n >all</span><span class=p >(</span><span class=bp >self</span><span class=o >.</span><span class=n >weights</span><span class=o >.</span><span class=n >values2d</span> <span class=o >==</span> <span class=mf >1.0</span><span class=p >)</span> <span class=ow >and</span> <span class=ow >not</span> <span class=n >reweight</span><span class=p >:</span>
            <span class=n >w</span> <span class=o >=</span> <span class=n >root_w</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >ones_like</span><span class=p >(</span><span class=n >w</span><span class=p >)</span>
        <span class=k >else</span><span class=p >:</span>
            <span class=n >root_w</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span><span class=n >Float64Array</span><span class=p >,</span> <span class=n >np</span><span class=o >.</span><span class=n >sqrt</span><span class=p >(</span><span class=n >w</span><span class=p >))</span>
        <span class=n >wx</span> <span class=o >=</span> <span class=n >root_w</span> <span class=o >*</span> <span class=n >x</span>
        <span class=n >wy</span> <span class=o >=</span> <span class=n >root_w</span> <span class=o >*</span> <span class=n >y</span>
        <span class=n >weps</span> <span class=o >=</span> <span class=n >wy</span> <span class=o >-</span> <span class=n >wx</span> <span class=o >@</span> <span class=n >params</span>
        <span class=n >residual_ss</span> <span class=o >=</span> <span class=nb >float</span><span class=p >(</span><span class=n >weps</span><span class=o >.</span><span class=n >T</span> <span class=o >@</span> <span class=n >weps</span><span class=p >)</span>
        <span class=n >e</span> <span class=o >=</span> <span class=n >y</span>
        <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >has_constant</span><span class=p >:</span>
            <span class=n >e</span> <span class=o >=</span> <span class=n >y</span> <span class=o >-</span> <span class=p >(</span><span class=n >w</span> <span class=o >*</span> <span class=n >y</span><span class=p >)</span><span class=o >.</span><span class=n >sum</span><span class=p >()</span> <span class=o >/</span> <span class=n >w</span><span class=o >.</span><span class=n >sum</span><span class=p >()</span>

        <span class=n >total_ss</span> <span class=o >=</span> <span class=nb >float</span><span class=p >(</span><span class=n >w</span><span class=o >.</span><span class=n >T</span> <span class=o >@</span> <span class=p >(</span><span class=n >e</span><span class=o >**</span><span class=mi >2</span><span class=p >))</span>
        <span class=n >r2b</span> <span class=o >=</span> <span class=mi >1</span> <span class=o >-</span> <span class=n >residual_ss</span> <span class=o >/</span> <span class=n >total_ss</span> <span class=k >if</span> <span class=n >total_ss</span> <span class=o >&gt;</span> <span class=mf >0.0</span> <span class=k >else</span> <span class=mf >0.0</span>

        <span class=c1 >#############################################</span>
        <span class=c1 ># R2 - Overall</span>
        <span class=c1 >#############################################</span>
        <span class=n >y</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >values2d</span>
        <span class=n >x</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >exog</span><span class=o >.</span><span class=n >values2d</span>
        <span class=n >w</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >weights</span><span class=o >.</span><span class=n >values2d</span>
        <span class=n >root_w</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span><span class=n >Float64Array</span><span class=p >,</span> <span class=n >np</span><span class=o >.</span><span class=n >sqrt</span><span class=p >(</span><span class=n >w</span><span class=p >))</span>
        <span class=n >wx</span> <span class=o >=</span> <span class=n >root_w</span> <span class=o >*</span> <span class=n >x</span>
        <span class=n >wy</span> <span class=o >=</span> <span class=n >root_w</span> <span class=o >*</span> <span class=n >y</span>
        <span class=n >weps</span> <span class=o >=</span> <span class=n >wy</span> <span class=o >-</span> <span class=n >wx</span> <span class=o >@</span> <span class=n >params</span>
        <span class=n >residual_ss</span> <span class=o >=</span> <span class=nb >float</span><span class=p >(</span><span class=n >weps</span><span class=o >.</span><span class=n >T</span> <span class=o >@</span> <span class=n >weps</span><span class=p >)</span>
        <span class=n >mu</span> <span class=o >=</span> <span class=p >(</span><span class=n >w</span> <span class=o >*</span> <span class=n >y</span><span class=p >)</span><span class=o >.</span><span class=n >sum</span><span class=p >()</span> <span class=o >/</span> <span class=n >w</span><span class=o >.</span><span class=n >sum</span><span class=p >()</span> <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >has_constant</span> <span class=k >else</span> <span class=mi >0</span>
        <span class=n >we</span> <span class=o >=</span> <span class=n >wy</span> <span class=o >-</span> <span class=n >root_w</span> <span class=o >*</span> <span class=n >mu</span>
        <span class=n >total_ss</span> <span class=o >=</span> <span class=nb >float</span><span class=p >(</span><span class=n >we</span><span class=o >.</span><span class=n >T</span> <span class=o >@</span> <span class=n >we</span><span class=p >)</span>
        <span class=n >r2o</span> <span class=o >=</span> <span class=mi >1</span> <span class=o >-</span> <span class=n >residual_ss</span> <span class=o >/</span> <span class=n >total_ss</span> <span class=k >if</span> <span class=n >total_ss</span> <span class=o >&gt;</span> <span class=mf >0.0</span> <span class=k >else</span> <span class=mf >0.0</span>

        <span class=c1 >#############################################</span>
        <span class=c1 ># R2 - Within</span>
        <span class=c1 >#############################################</span>
        <span class=n >weights</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >weights</span> <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >_is_weighted</span> <span class=k >else</span> <span class=kc >None</span>
        <span class=n >wy</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span>
            <span class=n >Float64Array</span><span class=p >,</span>
            <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >demean</span><span class=p >(</span><span class=s2 >"entity"</span><span class=p >,</span> <span class=n >weights</span><span class=o >=</span><span class=n >weights</span><span class=p >,</span> <span class=n >return_panel</span><span class=o >=</span><span class=kc >False</span><span class=p >),</span>
        <span class=p >)</span>
        <span class=n >wx</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span>
            <span class=n >Float64Array</span><span class=p >,</span>
            <span class=bp >self</span><span class=o >.</span><span class=n >exog</span><span class=o >.</span><span class=n >demean</span><span class=p >(</span><span class=s2 >"entity"</span><span class=p >,</span> <span class=n >weights</span><span class=o >=</span><span class=n >weights</span><span class=p >,</span> <span class=n >return_panel</span><span class=o >=</span><span class=kc >False</span><span class=p >),</span>
        <span class=p >)</span>
        <span class=k >assert</span> <span class=nb >isinstance</span><span class=p >(</span><span class=n >wy</span><span class=p >,</span> <span class=n >np</span><span class=o >.</span><span class=n >ndarray</span><span class=p >)</span>
        <span class=k >assert</span> <span class=nb >isinstance</span><span class=p >(</span><span class=n >wx</span><span class=p >,</span> <span class=n >np</span><span class=o >.</span><span class=n >ndarray</span><span class=p >)</span>
        <span class=n >weps</span> <span class=o >=</span> <span class=n >wy</span> <span class=o >-</span> <span class=n >wx</span> <span class=o >@</span> <span class=n >params</span>
        <span class=n >residual_ss</span> <span class=o >=</span> <span class=nb >float</span><span class=p >(</span><span class=n >weps</span><span class=o >.</span><span class=n >T</span> <span class=o >@</span> <span class=n >weps</span><span class=p >)</span>
        <span class=n >total_ss</span> <span class=o >=</span> <span class=nb >float</span><span class=p >(</span><span class=n >wy</span><span class=o >.</span><span class=n >T</span> <span class=o >@</span> <span class=n >wy</span><span class=p >)</span>
        <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >nobs</span> <span class=o >==</span> <span class=mi >1</span> <span class=ow >or</span> <span class=p >(</span><span class=bp >self</span><span class=o >.</span><span class=n >exog</span><span class=o >.</span><span class=n >nvar</span> <span class=o >==</span> <span class=mi >1</span> <span class=ow >and</span> <span class=bp >self</span><span class=o >.</span><span class=n >has_constant</span><span class=p >):</span>
            <span class=n >r2w</span> <span class=o >=</span> <span class=mf >0.0</span>
        <span class=k >else</span><span class=p >:</span>
            <span class=n >r2w</span> <span class=o >=</span> <span class=mf >1.0</span> <span class=o >-</span> <span class=n >residual_ss</span> <span class=o >/</span> <span class=n >total_ss</span> <span class=k >if</span> <span class=n >total_ss</span> <span class=o >&gt;</span> <span class=mf >0.0</span> <span class=k >else</span> <span class=mf >0.0</span>

        <span class=k >return</span> <span class=n >r2o</span><span class=p >,</span> <span class=n >r2w</span><span class=p >,</span> <span class=n >r2b</span>

    <span class=k >def</span> <span class=nf >_postestimation</span><span class=p >(</span>
        <span class=bp >self</span><span class=p >,</span>
        <span class=n >params</span><span class=p >:</span> <span class=n >Float64Array</span><span class=p >,</span>
        <span class=n >cov</span><span class=p >:</span> <span class=n >CovarianceEstimator</span><span class=p >,</span>
        <span class=n >debiased</span><span class=p >:</span> <span class=nb >bool</span><span class=p >,</span>
        <span class=n >df_resid</span><span class=p >:</span> <span class=nb >int</span><span class=p >,</span>
        <span class=n >weps</span><span class=p >:</span> <span class=n >Float64Array</span><span class=p >,</span>
        <span class=n >y</span><span class=p >:</span> <span class=n >Float64Array</span><span class=p >,</span>
        <span class=n >x</span><span class=p >:</span> <span class=n >Float64Array</span><span class=p >,</span>
        <span class=n >root_w</span><span class=p >:</span> <span class=n >Float64Array</span><span class=p >,</span>
    <span class=p >)</span> <span class=o >-&gt;</span> <span class=n >AttrDict</span><span class=p >:</span>
        <span class=sd >"""Common post-estimation values"""</span>
        <span class=n >f_info</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_f_statistic_robust</span><span class=p >(</span><span class=n >params</span><span class=p >)</span>
        <span class=n >f_stat</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_f_statistic</span><span class=p >(</span><span class=n >weps</span><span class=p >,</span> <span class=n >y</span><span class=p >,</span> <span class=n >x</span><span class=p >,</span> <span class=n >root_w</span><span class=p >,</span> <span class=n >df_resid</span><span class=p >)</span>
        <span class=n >r2o</span><span class=p >,</span> <span class=n >r2w</span><span class=p >,</span> <span class=n >r2b</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_rsquared</span><span class=p >(</span><span class=n >params</span><span class=p >)</span>
        <span class=n >c2o</span><span class=p >,</span> <span class=n >c2w</span><span class=p >,</span> <span class=n >c2b</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_rsquared_corr</span><span class=p >(</span><span class=n >params</span><span class=p >)</span>
        <span class=n >f_pooled</span> <span class=o >=</span> <span class=n >InapplicableTestStatistic</span><span class=p >(</span>
            <span class=n >reason</span><span class=o >=</span><span class=s2 >"Model has no effects"</span><span class=p >,</span> <span class=n >name</span><span class=o >=</span><span class=s2 >"Pooled F-stat"</span>
        <span class=p >)</span>
        <span class=n >entity_info</span><span class=p >,</span> <span class=n >time_info</span><span class=p >,</span> <span class=n >other_info</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_info</span><span class=p >()</span>
        <span class=n >nobs</span> <span class=o >=</span> <span class=n >weps</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >]</span>
        <span class=n >sigma2</span> <span class=o >=</span> <span class=nb >float</span><span class=p >(</span><span class=n >weps</span><span class=o >.</span><span class=n >T</span> <span class=o >@</span> <span class=n >weps</span> <span class=o >/</span> <span class=n >nobs</span><span class=p >)</span>
        <span class=k >if</span> <span class=n >sigma2</span> <span class=o >&gt;</span> <span class=mf >0.0</span><span class=p >:</span>
            <span class=n >loglik</span> <span class=o >=</span> <span class=o >-</span><span class=mf >0.5</span> <span class=o >*</span> <span class=n >nobs</span> <span class=o >*</span> <span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >log</span><span class=p >(</span><span class=mi >2</span> <span class=o >*</span> <span class=n >np</span><span class=o >.</span><span class=n >pi</span><span class=p >)</span> <span class=o >+</span> <span class=n >np</span><span class=o >.</span><span class=n >log</span><span class=p >(</span><span class=n >sigma2</span><span class=p >)</span> <span class=o >+</span> <span class=mi >1</span><span class=p >)</span>
        <span class=k >else</span><span class=p >:</span>
            <span class=n >loglik</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >nan</span>

        <span class=n >res</span> <span class=o >=</span> <span class=n >AttrDict</span><span class=p >(</span>
            <span class=n >params</span><span class=o >=</span><span class=n >params</span><span class=p >,</span>
            <span class=n >deferred_cov</span><span class=o >=</span><span class=n >cov</span><span class=o >.</span><span class=n >deferred_cov</span><span class=p >,</span>
            <span class=n >f_info</span><span class=o >=</span><span class=n >f_info</span><span class=p >,</span>
            <span class=n >f_stat</span><span class=o >=</span><span class=n >f_stat</span><span class=p >,</span>
            <span class=n >debiased</span><span class=o >=</span><span class=n >debiased</span><span class=p >,</span>
            <span class=n >name</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >_name</span><span class=p >,</span>
            <span class=n >var_names</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >exog</span><span class=o >.</span><span class=n >vars</span><span class=p >,</span>
            <span class=n >r2w</span><span class=o >=</span><span class=n >r2w</span><span class=p >,</span>
            <span class=n >r2b</span><span class=o >=</span><span class=n >r2b</span><span class=p >,</span>
            <span class=n >r2</span><span class=o >=</span><span class=n >r2w</span><span class=p >,</span>
            <span class=n >r2o</span><span class=o >=</span><span class=n >r2o</span><span class=p >,</span>
            <span class=n >c2o</span><span class=o >=</span><span class=n >c2o</span><span class=p >,</span>
            <span class=n >c2b</span><span class=o >=</span><span class=n >c2b</span><span class=p >,</span>
            <span class=n >c2w</span><span class=o >=</span><span class=n >c2w</span><span class=p >,</span>
            <span class=n >s2</span><span class=o >=</span><span class=n >cov</span><span class=o >.</span><span class=n >s2</span><span class=p >,</span>
            <span class=n >model</span><span class=o >=</span><span class=bp >self</span><span class=p >,</span>
            <span class=n >cov_type</span><span class=o >=</span><span class=n >cov</span><span class=o >.</span><span class=n >name</span><span class=p >,</span>
            <span class=n >index</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >index</span><span class=p >,</span>
            <span class=n >entity_info</span><span class=o >=</span><span class=n >entity_info</span><span class=p >,</span>
            <span class=n >time_info</span><span class=o >=</span><span class=n >time_info</span><span class=p >,</span>
            <span class=n >other_info</span><span class=o >=</span><span class=n >other_info</span><span class=p >,</span>
            <span class=n >f_pooled</span><span class=o >=</span><span class=n >f_pooled</span><span class=p >,</span>
            <span class=n >loglik</span><span class=o >=</span><span class=n >loglik</span><span class=p >,</span>
            <span class=n >not_null</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >_not_null</span><span class=p >,</span>
            <span class=n >original_index</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >_original_index</span><span class=p >,</span>
        <span class=p >)</span>
        <span class=k >return</span> <span class=n >res</span>

    <span class=nd >@property</span>
    <span class=k >def</span> <span class=nf >not_null</span><span class=p >(</span><span class=bp >self</span><span class=p >)</span> <span class=o >-&gt;</span> <span class=n >BoolArray</span><span class=p >:</span>
        <span class=sd >"""Locations of non-missing observations"""</span>
        <span class=k >return</span> <span class=bp >self</span><span class=o >.</span><span class=n >_not_null</span>

    <span class=k >def</span> <span class=nf >_setup_clusters</span><span class=p >(</span>
        <span class=bp >self</span><span class=p >,</span> <span class=n >cov_config</span><span class=p >:</span> <span class=nb >dict</span><span class=p >[</span><span class=nb >str</span><span class=p >,</span> <span class=nb >bool</span> <span class=o >|</span> <span class=nb >float</span> <span class=o >|</span> <span class=nb >str</span> <span class=o >|</span> <span class=n >PanelDataLike</span><span class=p >]</span>
    <span class=p >)</span> <span class=o >-&gt;</span> <span class=nb >dict</span><span class=p >[</span><span class=nb >str</span><span class=p >,</span> <span class=nb >bool</span> <span class=o >|</span> <span class=nb >float</span> <span class=o >|</span> <span class=nb >str</span> <span class=o >|</span> <span class=n >Float64Array</span> <span class=o >|</span> <span class=n >DataFrame</span> <span class=o >|</span> <span class=n >PanelData</span><span class=p >]:</span>

        <span class=n >cov_config_upd</span> <span class=o >=</span> <span class=n >cov_config</span><span class=o >.</span><span class=n >copy</span><span class=p >()</span>
        <span class=n >cluster_types</span> <span class=o >=</span> <span class=p >(</span><span class=s2 >"clusters"</span><span class=p >,</span> <span class=s2 >"cluster_entity"</span><span class=p >,</span> <span class=s2 >"cluster_time"</span><span class=p >)</span>
        <span class=n >common</span> <span class=o >=</span> <span class=nb >set</span><span class=p >(</span><span class=n >cov_config</span><span class=o >.</span><span class=n >keys</span><span class=p >())</span><span class=o >.</span><span class=n >intersection</span><span class=p >(</span><span class=n >cluster_types</span><span class=p >)</span>
        <span class=k >if</span> <span class=ow >not</span> <span class=n >common</span><span class=p >:</span>
            <span class=k >return</span> <span class=n >cov_config_upd</span>

        <span class=n >cov_config_upd</span> <span class=o >=</span> <span class=p >{</span><span class=n >k</span><span class=p >:</span> <span class=n >v</span> <span class=k >for</span> <span class=n >k</span><span class=p >,</span> <span class=n >v</span> <span class=ow >in</span> <span class=n >cov_config</span><span class=o >.</span><span class=n >items</span><span class=p >()}</span>

        <span class=n >clusters</span> <span class=o >=</span> <span class=n >get_panel_data_like</span><span class=p >(</span><span class=n >cov_config</span><span class=p >,</span> <span class=s2 >"clusters"</span><span class=p >)</span>
        <span class=n >clusters_frame</span><span class=p >:</span> <span class=n >DataFrame</span> <span class=o >|</span> <span class=kc >None</span> <span class=o >=</span> <span class=kc >None</span>
        <span class=k >if</span> <span class=n >clusters</span> <span class=ow >is</span> <span class=ow >not</span> <span class=kc >None</span><span class=p >:</span>
            <span class=n >formatted_clusters</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >reformat_clusters</span><span class=p >(</span><span class=n >clusters</span><span class=p >)</span>
            <span class=k >for</span> <span class=n >col</span> <span class=ow >in</span> <span class=n >formatted_clusters</span><span class=o >.</span><span class=n >dataframe</span><span class=p >:</span>
                <span class=n >cat</span> <span class=o >=</span> <span class=n >Categorical</span><span class=p >(</span><span class=n >formatted_clusters</span><span class=o >.</span><span class=n >dataframe</span><span class=p >[</span><span class=n >col</span><span class=p >])</span>
                <span class=n >formatted_clusters</span><span class=o >.</span><span class=n >dataframe</span><span class=p >[</span><span class=n >col</span><span class=p >]</span> <span class=o >=</span> <span class=n >cat</span><span class=o >.</span><span class=n >codes</span><span class=o >.</span><span class=n >astype</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >int64</span><span class=p >)</span>
            <span class=n >clusters_frame</span> <span class=o >=</span> <span class=n >formatted_clusters</span><span class=o >.</span><span class=n >dataframe</span>

        <span class=n >cluster_entity</span> <span class=o >=</span> <span class=nb >bool</span><span class=p >(</span><span class=n >cov_config_upd</span><span class=o >.</span><span class=n >pop</span><span class=p >(</span><span class=s2 >"cluster_entity"</span><span class=p >,</span> <span class=kc >False</span><span class=p >))</span>
        <span class=k >if</span> <span class=n >cluster_entity</span><span class=p >:</span>
            <span class=n >group_ids</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >entity_ids</span><span class=o >.</span><span class=n >squeeze</span><span class=p >()</span>
            <span class=n >name</span> <span class=o >=</span> <span class=s2 >"cov.cluster.entity"</span>
            <span class=n >group_ids</span> <span class=o >=</span> <span class=n >Series</span><span class=p >(</span><span class=n >group_ids</span><span class=p >,</span> <span class=n >index</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >index</span><span class=p >,</span> <span class=n >name</span><span class=o >=</span><span class=n >name</span><span class=p >)</span>
            <span class=k >if</span> <span class=n >clusters_frame</span> <span class=ow >is</span> <span class=ow >not</span> <span class=kc >None</span><span class=p >:</span>
                <span class=n >clusters_frame</span><span class=p >[</span><span class=n >name</span><span class=p >]</span> <span class=o >=</span> <span class=n >group_ids</span>
            <span class=k >else</span><span class=p >:</span>
                <span class=n >clusters_frame</span> <span class=o >=</span> <span class=n >DataFrame</span><span class=p >(</span><span class=n >group_ids</span><span class=p >)</span>

        <span class=n >cluster_time</span> <span class=o >=</span> <span class=nb >bool</span><span class=p >(</span><span class=n >cov_config_upd</span><span class=o >.</span><span class=n >pop</span><span class=p >(</span><span class=s2 >"cluster_time"</span><span class=p >,</span> <span class=kc >False</span><span class=p >))</span>
        <span class=k >if</span> <span class=n >cluster_time</span><span class=p >:</span>
            <span class=n >group_ids</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >time_ids</span><span class=o >.</span><span class=n >squeeze</span><span class=p >()</span>
            <span class=n >name</span> <span class=o >=</span> <span class=s2 >"cov.cluster.time"</span>
            <span class=n >group_ids</span> <span class=o >=</span> <span class=n >Series</span><span class=p >(</span><span class=n >group_ids</span><span class=p >,</span> <span class=n >index</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >index</span><span class=p >,</span> <span class=n >name</span><span class=o >=</span><span class=n >name</span><span class=p >)</span>
            <span class=k >if</span> <span class=n >clusters_frame</span> <span class=ow >is</span> <span class=ow >not</span> <span class=kc >None</span><span class=p >:</span>
                <span class=n >clusters_frame</span><span class=p >[</span><span class=n >name</span><span class=p >]</span> <span class=o >=</span> <span class=n >group_ids</span>
            <span class=k >else</span><span class=p >:</span>
                <span class=n >clusters_frame</span> <span class=o >=</span> <span class=n >DataFrame</span><span class=p >(</span><span class=n >group_ids</span><span class=p >)</span>
        <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >_singleton_index</span> <span class=ow >is</span> <span class=ow >not</span> <span class=kc >None</span> <span class=ow >and</span> <span class=n >clusters_frame</span> <span class=ow >is</span> <span class=ow >not</span> <span class=kc >None</span><span class=p >:</span>
            <span class=n >clusters_frame</span> <span class=o >=</span> <span class=n >clusters_frame</span><span class=o >.</span><span class=n >loc</span><span class=p >[</span><span class=o >~</span><span class=bp >self</span><span class=o >.</span><span class=n >_singleton_index</span><span class=p >]</span>

        <span class=n >cov_config_upd</span><span class=p >[</span><span class=s2 >"clusters"</span><span class=p >]</span> <span class=o >=</span> <span class=p >(</span>
            <span class=n >np</span><span class=o >.</span><span class=n >asarray</span><span class=p >(</span><span class=n >clusters_frame</span><span class=p >)</span> <span class=k >if</span> <span class=n >clusters_frame</span> <span class=ow >is</span> <span class=ow >not</span> <span class=kc >None</span> <span class=k >else</span> <span class=n >clusters_frame</span>
        <span class=p >)</span>

        <span class=k >return</span> <span class=n >cov_config_upd</span>

    <span class=k >def</span> <span class=nf >predict</span><span class=p >(</span>
        <span class=bp >self</span><span class=p >,</span>
        <span class=n >params</span><span class=p >:</span> <span class=n >ArrayLike</span><span class=p >,</span>
        <span class=o >*</span><span class=p >,</span>
        <span class=n >exog</span><span class=p >:</span> <span class=n >PanelDataLike</span> <span class=o >|</span> <span class=kc >None</span> <span class=o >=</span> <span class=kc >None</span><span class=p >,</span>
        <span class=n >data</span><span class=p >:</span> <span class=n >PanelDataLike</span> <span class=o >|</span> <span class=kc >None</span> <span class=o >=</span> <span class=kc >None</span><span class=p >,</span>
        <span class=n >context</span><span class=p >:</span> <span class=nb >int</span> <span class=o >=</span> <span class=mi >4</span><span class=p >,</span>
    <span class=p >)</span> <span class=o >-&gt;</span> <span class=n >DataFrame</span><span class=p >:</span>
        <span class=sd >"""</span>
<span class=sd >        Predict values for additional data</span>

<span class=sd >        Parameters</span>
<span class=sd >        ----------</span>
<span class=sd >        params : array_like</span>
<span class=sd >            Model parameters (nvar by 1)</span>
<span class=sd >        exog : array_like</span>
<span class=sd >            Exogenous regressors (nobs by nvar)</span>
<span class=sd >        data : DataFrame</span>
<span class=sd >            Values to use when making predictions from a model constructed</span>
<span class=sd >            from a formula</span>
<span class=sd >        context : int</span>
<span class=sd >            Depth of use when evaluating formulas.</span>

<span class=sd >        Returns</span>
<span class=sd >        -------</span>
<span class=sd >        DataFrame</span>
<span class=sd >            Fitted values from supplied data and parameters</span>

<span class=sd >        Notes</span>
<span class=sd >        -----</span>
<span class=sd >        If `data` is not None, then `exog` must be None.</span>
<span class=sd >        Predictions from models constructed using formulas can</span>
<span class=sd >        be computed using either `exog`, which will treat these are</span>
<span class=sd >        arrays of values corresponding to the formula-processed data, or using</span>
<span class=sd >        `data` which will be processed using the formula used to construct the</span>
<span class=sd >        values corresponding to the original model specification.</span>
<span class=sd >        """</span>
        <span class=k >if</span> <span class=n >data</span> <span class=ow >is</span> <span class=ow >not</span> <span class=kc >None</span> <span class=ow >and</span> <span class=bp >self</span><span class=o >.</span><span class=n >formula</span> <span class=ow >is</span> <span class=kc >None</span><span class=p >:</span>
            <span class=k >raise</span> <span class=ne >ValueError</span><span class=p >(</span>
                <span class=s2 >"Unable to use data when the model was not "</span> <span class=s2 >"created using a formula."</span>
            <span class=p >)</span>
        <span class=k >if</span> <span class=n >data</span> <span class=ow >is</span> <span class=ow >not</span> <span class=kc >None</span> <span class=ow >and</span> <span class=n >exog</span> <span class=ow >is</span> <span class=ow >not</span> <span class=kc >None</span><span class=p >:</span>
            <span class=k >raise</span> <span class=ne >ValueError</span><span class=p >(</span>
                <span class=s2 >"Predictions can only be constructed using one "</span>
                <span class=s2 >"of exog or data, but not both."</span>
            <span class=p >)</span>
        <span class=k >if</span> <span class=n >exog</span> <span class=ow >is</span> <span class=ow >not</span> <span class=kc >None</span><span class=p >:</span>
            <span class=n >exog</span> <span class=o >=</span> <span class=n >PanelData</span><span class=p >(</span><span class=n >exog</span><span class=p >)</span><span class=o >.</span><span class=n >dataframe</span>
        <span class=k >else</span><span class=p >:</span>
            <span class=k >assert</span> <span class=bp >self</span><span class=o >.</span><span class=n >_formula</span> <span class=ow >is</span> <span class=ow >not</span> <span class=kc >None</span>
            <span class=k >assert</span> <span class=n >data</span> <span class=ow >is</span> <span class=ow >not</span> <span class=kc >None</span>
            <span class=n >parser</span> <span class=o >=</span> <span class=n >PanelFormulaParser</span><span class=p >(</span><span class=bp >self</span><span class=o >.</span><span class=n >_formula</span><span class=p >,</span> <span class=n >data</span><span class=p >,</span> <span class=n >context</span><span class=o >=</span><span class=n >context</span><span class=p >)</span>
            <span class=n >exog</span> <span class=o >=</span> <span class=n >parser</span><span class=o >.</span><span class=n >exog</span>
        <span class=n >x</span> <span class=o >=</span> <span class=n >exog</span><span class=o >.</span><span class=n >values</span>
        <span class=n >params</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >atleast_2d</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >asarray</span><span class=p >(</span><span class=n >params</span><span class=p >))</span>
        <span class=k >if</span> <span class=n >params</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >]</span> <span class=o >==</span> <span class=mi >1</span><span class=p >:</span>
            <span class=n >params</span> <span class=o >=</span> <span class=n >params</span><span class=o >.</span><span class=n >T</span>
        <span class=k >if</span> <span class=n >x</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >1</span><span class=p >]</span> <span class=o >!=</span> <span class=n >params</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >]:</span>
            <span class=k >raise</span> <span class=ne >ValueError</span><span class=p >(</span>
                <span class=n >EXOG_PREDICT_MSG</span><span class=o >.</span><span class=n >format</span><span class=p >(</span>
                    <span class=n >x_shape</span><span class=o >=</span><span class=n >x</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >1</span><span class=p >],</span> <span class=n >params_shape</span><span class=o >=</span><span class=n >params</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >]</span>
                <span class=p >)</span>
            <span class=p >)</span>

        <span class=n >pred</span> <span class=o >=</span> <span class=n >DataFrame</span><span class=p >(</span><span class=n >x</span> <span class=o >@</span> <span class=n >params</span><span class=p >,</span> <span class=n >index</span><span class=o >=</span><span class=n >exog</span><span class=o >.</span><span class=n >index</span><span class=p >,</span> <span class=n >columns</span><span class=o >=</span><span class=p >[</span><span class=s2 >"predictions"</span><span class=p >])</span>

        <span class=k >return</span> <span class=n >pred</span>


<div class=viewcode-block  id=PooledOLS ><a class=viewcode-back  href="../../../panel/panel/linearmodels.panel.model.PooledOLS.html#linearmodels.panel.model.PooledOLS">[docs]</a><span class=k >class</span> <span class=nc >PooledOLS</span><span class=p >(</span><span class=n >_PanelModelBase</span><span class=p >):</span>
    <span class=sa >r</span><span class=sd >"""</span>
<span class=sd >    Pooled coefficient estimator for panel data</span>

<span class=sd >    Parameters</span>
<span class=sd >    ----------</span>
<span class=sd >    dependent : array_like</span>
<span class=sd >        Dependent (left-hand-side) variable (time by entity)</span>
<span class=sd >    exog : array_like</span>
<span class=sd >        Exogenous or right-hand-side variables (variable by time by entity).</span>
<span class=sd >    weights : array_like</span>
<span class=sd >        Weights to use in estimation.  Assumes residual variance is</span>
<span class=sd >        proportional to inverse of weight to that the residual time</span>
<span class=sd >        the weight should be homoskedastic.</span>
<span class=sd >    check_rank : bool</span>
<span class=sd >        Flag indicating whether to perform a rank check on the exogenous</span>
<span class=sd >        variables to ensure that the model is identified. Skipping this</span>
<span class=sd >        check can reduce the time required to validate a model specification.</span>
<span class=sd >        Results may be numerically unstable if this check is skipped and</span>
<span class=sd >        the matrix is not full rank.</span>

<span class=sd >    Notes</span>
<span class=sd >    -----</span>
<span class=sd >    The model is given by</span>

<span class=sd >    .. math::</span>

<span class=sd >        y_{it}=\beta^{\prime}x_{it}+\epsilon_{it}</span>
<span class=sd >    """</span>

    <span class=k >def</span> <span class=fm >__init__</span><span class=p >(</span>
        <span class=bp >self</span><span class=p >,</span>
        <span class=n >dependent</span><span class=p >:</span> <span class=n >PanelDataLike</span><span class=p >,</span>
        <span class=n >exog</span><span class=p >:</span> <span class=n >PanelDataLike</span><span class=p >,</span>
        <span class=o >*</span><span class=p >,</span>
        <span class=n >weights</span><span class=p >:</span> <span class=n >PanelDataLike</span> <span class=o >|</span> <span class=kc >None</span> <span class=o >=</span> <span class=kc >None</span><span class=p >,</span>
        <span class=n >check_rank</span><span class=p >:</span> <span class=nb >bool</span> <span class=o >=</span> <span class=kc >True</span><span class=p >,</span>
    <span class=p >)</span> <span class=o >-&gt;</span> <span class=kc >None</span><span class=p >:</span>
        <span class=nb >super</span><span class=p >()</span><span class=o >.</span><span class=fm >__init__</span><span class=p >(</span><span class=n >dependent</span><span class=p >,</span> <span class=n >exog</span><span class=p >,</span> <span class=n >weights</span><span class=o >=</span><span class=n >weights</span><span class=p >,</span> <span class=n >check_rank</span><span class=o >=</span><span class=n >check_rank</span><span class=p >)</span>

<div class=viewcode-block  id=PooledOLS.from_formula ><a class=viewcode-back  href="../../../panel/panel/linearmodels.panel.model.PooledOLS.from_formula.html#linearmodels.panel.model.PooledOLS.from_formula">[docs]</a>    <span class=nd >@classmethod</span>
    <span class=k >def</span> <span class=nf >from_formula</span><span class=p >(</span>
        <span class=bp >cls</span><span class=p >,</span>
        <span class=n >formula</span><span class=p >:</span> <span class=nb >str</span><span class=p >,</span>
        <span class=n >data</span><span class=p >:</span> <span class=n >PanelDataLike</span><span class=p >,</span>
        <span class=o >*</span><span class=p >,</span>
        <span class=n >weights</span><span class=p >:</span> <span class=n >PanelDataLike</span> <span class=o >|</span> <span class=kc >None</span> <span class=o >=</span> <span class=kc >None</span><span class=p >,</span>
        <span class=n >check_rank</span><span class=p >:</span> <span class=nb >bool</span> <span class=o >=</span> <span class=kc >True</span><span class=p >,</span>
    <span class=p >)</span> <span class=o >-&gt;</span> <span class=n >PooledOLS</span><span class=p >:</span>
        <span class=sd >"""</span>
<span class=sd >        Create a model from a formula</span>

<span class=sd >        Parameters</span>
<span class=sd >        ----------</span>
<span class=sd >        formula : str</span>
<span class=sd >            Formula to transform into model. Conforms to formulaic formula</span>
<span class=sd >            rules.</span>
<span class=sd >        data : array_like</span>
<span class=sd >            Data structure that can be coerced into a PanelData.  In most</span>
<span class=sd >            cases, this should be a multi-index DataFrame where the level 0</span>
<span class=sd >            index contains the entities and the level 1 contains the time.</span>
<span class=sd >        weights: array_like</span>
<span class=sd >            Weights to use in estimation.  Assumes residual variance is</span>
<span class=sd >            proportional to inverse of weight to that the residual times</span>
<span class=sd >            the weight should be homoskedastic.</span>
<span class=sd >        check_rank : bool</span>
<span class=sd >            Flag indicating whether to perform a rank check on the exogenous</span>
<span class=sd >            variables to ensure that the model is identified. Skipping this</span>
<span class=sd >            check can reduce the time required to validate a model</span>
<span class=sd >            specification. Results may be numerically unstable if this check</span>
<span class=sd >            is skipped and the matrix is not full rank.</span>

<span class=sd >        Returns</span>
<span class=sd >        -------</span>
<span class=sd >        PooledOLS</span>
<span class=sd >            Model specified using the formula</span>

<span class=sd >        Notes</span>
<span class=sd >        -----</span>
<span class=sd >        Unlike standard  formula syntax, it is necessary to explicitly include</span>
<span class=sd >        a constant using the constant indicator (1)</span>

<span class=sd >        Examples</span>
<span class=sd >        --------</span>
<span class=sd >        &gt;&gt;&gt; from linearmodels import PooledOLS</span>
<span class=sd >        &gt;&gt;&gt; from linearmodels.panel import generate_panel_data</span>
<span class=sd >        &gt;&gt;&gt; panel_data = generate_panel_data()</span>
<span class=sd >        &gt;&gt;&gt; mod = PooledOLS.from_formula("y ~ 1 + x1", panel_data.data)</span>
<span class=sd >        &gt;&gt;&gt; res = mod.fit()</span>
<span class=sd >        """</span>
        <span class=n >parser</span> <span class=o >=</span> <span class=n >PanelFormulaParser</span><span class=p >(</span><span class=n >formula</span><span class=p >,</span> <span class=n >data</span><span class=p >)</span>
        <span class=n >dependent</span><span class=p >,</span> <span class=n >exog</span> <span class=o >=</span> <span class=n >parser</span><span class=o >.</span><span class=n >data</span>
        <span class=n >mod</span> <span class=o >=</span> <span class=bp >cls</span><span class=p >(</span><span class=n >dependent</span><span class=p >,</span> <span class=n >exog</span><span class=p >,</span> <span class=n >weights</span><span class=o >=</span><span class=n >weights</span><span class=p >,</span> <span class=n >check_rank</span><span class=o >=</span><span class=n >check_rank</span><span class=p >)</span>
        <span class=n >mod</span><span class=o >.</span><span class=n >formula</span> <span class=o >=</span> <span class=n >formula</span>
        <span class=k >return</span> <span class=n >mod</span></div>

<div class=viewcode-block  id=PooledOLS.fit ><a class=viewcode-back  href="../../../panel/panel/linearmodels.panel.model.PooledOLS.fit.html#linearmodels.panel.model.PooledOLS.fit">[docs]</a>    <span class=k >def</span> <span class=nf >fit</span><span class=p >(</span>
        <span class=bp >self</span><span class=p >,</span>
        <span class=o >*</span><span class=p >,</span>
        <span class=n >cov_type</span><span class=p >:</span> <span class=nb >str</span> <span class=o >=</span> <span class=s2 >"unadjusted"</span><span class=p >,</span>
        <span class=n >debiased</span><span class=p >:</span> <span class=nb >bool</span> <span class=o >=</span> <span class=kc >True</span><span class=p >,</span>
        <span class=o >**</span><span class=n >cov_config</span><span class=p >:</span> <span class=nb >bool</span> <span class=o >|</span> <span class=nb >float</span> <span class=o >|</span> <span class=nb >str</span> <span class=o >|</span> <span class=n >Float64Array</span> <span class=o >|</span> <span class=n >DataFrame</span> <span class=o >|</span> <span class=n >PanelData</span><span class=p >,</span>
    <span class=p >)</span> <span class=o >-&gt;</span> <span class=n >PanelResults</span><span class=p >:</span>
        <span class=sd >"""</span>
<span class=sd >        Estimate model parameters</span>

<span class=sd >        Parameters</span>
<span class=sd >        ----------</span>
<span class=sd >        cov_type : str</span>
<span class=sd >            Name of covariance estimator. See Notes.</span>
<span class=sd >        debiased : bool</span>
<span class=sd >            Flag indicating whether to debiased the covariance estimator using</span>
<span class=sd >            a degree of freedom adjustment.</span>
<span class=sd >        **cov_config</span>
<span class=sd >            Additional covariance-specific options.  See Notes.</span>

<span class=sd >        Returns</span>
<span class=sd >        -------</span>
<span class=sd >        PanelResults</span>
<span class=sd >            Estimation results</span>

<span class=sd >        Examples</span>
<span class=sd >        --------</span>
<span class=sd >        &gt;&gt;&gt; from linearmodels import PooledOLS</span>
<span class=sd >        &gt;&gt;&gt; mod = PooledOLS(y, x)</span>
<span class=sd >        &gt;&gt;&gt; res = mod.fit(cov_type="clustered", cluster_entity=True)</span>

<span class=sd >        Notes</span>
<span class=sd >        -----</span>
<span class=sd >        Four covariance estimators are supported:</span>

<span class=sd >        * "unadjusted", "homoskedastic" - Assume residual are homoskedastic</span>
<span class=sd >        * "robust", "heteroskedastic" - Control for heteroskedasticity using</span>
<span class=sd >          White's estimator</span>
<span class=sd >        * "clustered` - One- or two-way clustering.  Configuration options are:</span>

<span class=sd >          * ``clusters`` - Input containing 1 or 2 variables.</span>
<span class=sd >            Clusters should be integer values, although other types will</span>
<span class=sd >            be coerced to integer values by treating as categorical variables</span>
<span class=sd >          * ``cluster_entity`` - Boolean flag indicating to use entity</span>
<span class=sd >            clusters</span>
<span class=sd >          * ``cluster_time`` - Boolean indicating to use time clusters</span>

<span class=sd >        * "kernel" - Driscoll-Kraay HAC estimator. Configurations options are:</span>

<span class=sd >          * ``kernel`` - One of the supported kernels (bartlett, parzen, qs).</span>
<span class=sd >            Default is Bartlett's kernel, which is produces a covariance</span>
<span class=sd >            estimator similar to the Newey-West covariance estimator.</span>
<span class=sd >          * ``bandwidth`` - Bandwidth to use when computing the kernel.  If</span>
<span class=sd >            not provided, a naive default is used.</span>
<span class=sd >        """</span>
        <span class=n >y</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >values2d</span>
        <span class=n >x</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >exog</span><span class=o >.</span><span class=n >values2d</span>
        <span class=n >w</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >weights</span><span class=o >.</span><span class=n >values2d</span>
        <span class=n >root_w</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span><span class=n >Float64Array</span><span class=p >,</span> <span class=n >np</span><span class=o >.</span><span class=n >sqrt</span><span class=p >(</span><span class=n >w</span><span class=p >))</span>
        <span class=n >wx</span> <span class=o >=</span> <span class=n >root_w</span> <span class=o >*</span> <span class=n >x</span>
        <span class=n >wy</span> <span class=o >=</span> <span class=n >root_w</span> <span class=o >*</span> <span class=n >y</span>

        <span class=n >params</span> <span class=o >=</span> <span class=n >_lstsq</span><span class=p >(</span><span class=n >wx</span><span class=p >,</span> <span class=n >wy</span><span class=p >,</span> <span class=n >rcond</span><span class=o >=</span><span class=kc >None</span><span class=p >)[</span><span class=mi >0</span><span class=p >]</span>

        <span class=n >nobs</span> <span class=o >=</span> <span class=n >y</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >]</span>
        <span class=n >df_model</span> <span class=o >=</span> <span class=n >x</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >1</span><span class=p >]</span>
        <span class=n >df_resid</span> <span class=o >=</span> <span class=n >nobs</span> <span class=o >-</span> <span class=n >df_model</span>
        <span class=n >cov_config</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_setup_clusters</span><span class=p >(</span><span class=n >cov_config</span><span class=p >)</span>
        <span class=n >extra_df</span> <span class=o >=</span> <span class=mi >0</span>
        <span class=k >if</span> <span class=s2 >"extra_df"</span> <span class=ow >in</span> <span class=n >cov_config</span><span class=p >:</span>
            <span class=n >cov_config</span> <span class=o >=</span> <span class=n >cov_config</span><span class=o >.</span><span class=n >copy</span><span class=p >()</span>
            <span class=n >_extra_df</span> <span class=o >=</span> <span class=n >cov_config</span><span class=o >.</span><span class=n >pop</span><span class=p >(</span><span class=s2 >"extra_df"</span><span class=p >)</span>
            <span class=k >assert</span> <span class=nb >isinstance</span><span class=p >(</span><span class=n >_extra_df</span><span class=p >,</span> <span class=p >(</span><span class=nb >str</span><span class=p >,</span> <span class=nb >int</span><span class=p >))</span>
            <span class=n >extra_df</span> <span class=o >=</span> <span class=nb >int</span><span class=p >(</span><span class=n >_extra_df</span><span class=p >)</span>
        <span class=n >cov</span> <span class=o >=</span> <span class=n >setup_covariance_estimator</span><span class=p >(</span>
            <span class=bp >self</span><span class=o >.</span><span class=n >_cov_estimators</span><span class=p >,</span>
            <span class=n >cov_type</span><span class=p >,</span>
            <span class=n >wy</span><span class=p >,</span>
            <span class=n >wx</span><span class=p >,</span>
            <span class=n >params</span><span class=p >,</span>
            <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >entity_ids</span><span class=p >,</span>
            <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >time_ids</span><span class=p >,</span>
            <span class=n >debiased</span><span class=o >=</span><span class=n >debiased</span><span class=p >,</span>
            <span class=n >extra_df</span><span class=o >=</span><span class=n >extra_df</span><span class=p >,</span>
            <span class=o >**</span><span class=n >cov_config</span><span class=p >,</span>
        <span class=p >)</span>
        <span class=n >weps</span> <span class=o >=</span> <span class=n >wy</span> <span class=o >-</span> <span class=n >wx</span> <span class=o >@</span> <span class=n >params</span>
        <span class=n >index</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >index</span>
        <span class=n >fitted</span> <span class=o >=</span> <span class=n >DataFrame</span><span class=p >(</span><span class=n >x</span> <span class=o >@</span> <span class=n >params</span><span class=p >,</span> <span class=n >index</span><span class=p >,</span> <span class=p >[</span><span class=s2 >"fitted_values"</span><span class=p >])</span>
        <span class=n >effects</span> <span class=o >=</span> <span class=n >DataFrame</span><span class=p >(</span>
            <span class=n >np</span><span class=o >.</span><span class=n >full_like</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >asarray</span><span class=p >(</span><span class=n >fitted</span><span class=p >),</span> <span class=n >np</span><span class=o >.</span><span class=n >nan</span><span class=p >),</span> <span class=n >index</span><span class=p >,</span> <span class=p >[</span><span class=s2 >"estimated_effects"</span><span class=p >]</span>
        <span class=p >)</span>
        <span class=n >eps</span> <span class=o >=</span> <span class=n >y</span> <span class=o >-</span> <span class=n >fitted</span><span class=o >.</span><span class=n >values</span>
        <span class=n >idiosyncratic</span> <span class=o >=</span> <span class=n >DataFrame</span><span class=p >(</span><span class=n >eps</span><span class=p >,</span> <span class=n >index</span><span class=p >,</span> <span class=p >[</span><span class=s2 >"idiosyncratic"</span><span class=p >])</span>
        <span class=n >residual_ss</span> <span class=o >=</span> <span class=nb >float</span><span class=p >(</span><span class=n >weps</span><span class=o >.</span><span class=n >T</span> <span class=o >@</span> <span class=n >weps</span><span class=p >)</span>
        <span class=n >e</span> <span class=o >=</span> <span class=n >y</span>
        <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >_constant</span><span class=p >:</span>
            <span class=n >e</span> <span class=o >=</span> <span class=n >e</span> <span class=o >-</span> <span class=p >(</span><span class=n >w</span> <span class=o >*</span> <span class=n >y</span><span class=p >)</span><span class=o >.</span><span class=n >sum</span><span class=p >()</span> <span class=o >/</span> <span class=n >w</span><span class=o >.</span><span class=n >sum</span><span class=p >()</span>

        <span class=n >total_ss</span> <span class=o >=</span> <span class=nb >float</span><span class=p >(</span><span class=n >w</span><span class=o >.</span><span class=n >T</span> <span class=o >@</span> <span class=p >(</span><span class=n >e</span><span class=o >**</span><span class=mi >2</span><span class=p >))</span>
        <span class=n >r2</span> <span class=o >=</span> <span class=mi >1</span> <span class=o >-</span> <span class=n >residual_ss</span> <span class=o >/</span> <span class=n >total_ss</span>

        <span class=n >res</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_postestimation</span><span class=p >(</span>
            <span class=n >params</span><span class=p >,</span> <span class=n >cov</span><span class=p >,</span> <span class=n >debiased</span><span class=p >,</span> <span class=n >df_resid</span><span class=p >,</span> <span class=n >weps</span><span class=p >,</span> <span class=n >wy</span><span class=p >,</span> <span class=n >wx</span><span class=p >,</span> <span class=n >root_w</span>
        <span class=p >)</span>
        <span class=n >res</span><span class=o >.</span><span class=n >update</span><span class=p >(</span>
            <span class=nb >dict</span><span class=p >(</span>
                <span class=n >df_resid</span><span class=o >=</span><span class=n >df_resid</span><span class=p >,</span>
                <span class=n >df_model</span><span class=o >=</span><span class=n >df_model</span><span class=p >,</span>
                <span class=n >nobs</span><span class=o >=</span><span class=n >y</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >],</span>
                <span class=n >residual_ss</span><span class=o >=</span><span class=n >residual_ss</span><span class=p >,</span>
                <span class=n >total_ss</span><span class=o >=</span><span class=n >total_ss</span><span class=p >,</span>
                <span class=n >r2</span><span class=o >=</span><span class=n >r2</span><span class=p >,</span>
                <span class=n >wresids</span><span class=o >=</span><span class=n >weps</span><span class=p >,</span>
                <span class=n >resids</span><span class=o >=</span><span class=n >eps</span><span class=p >,</span>
                <span class=n >index</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >index</span><span class=p >,</span>
                <span class=n >fitted</span><span class=o >=</span><span class=n >fitted</span><span class=p >,</span>
                <span class=n >effects</span><span class=o >=</span><span class=n >effects</span><span class=p >,</span>
                <span class=n >idiosyncratic</span><span class=o >=</span><span class=n >idiosyncratic</span><span class=p >,</span>
            <span class=p >)</span>
        <span class=p >)</span>

        <span class=k >return</span> <span class=n >PanelResults</span><span class=p >(</span><span class=n >res</span><span class=p >)</span></div>

<div class=viewcode-block  id=PooledOLS.predict ><a class=viewcode-back  href="../../../panel/panel/linearmodels.panel.model.PooledOLS.predict.html#linearmodels.panel.model.PooledOLS.predict">[docs]</a>    <span class=k >def</span> <span class=nf >predict</span><span class=p >(</span>
        <span class=bp >self</span><span class=p >,</span>
        <span class=n >params</span><span class=p >:</span> <span class=n >ArrayLike</span><span class=p >,</span>
        <span class=o >*</span><span class=p >,</span>
        <span class=n >exog</span><span class=p >:</span> <span class=n >PanelDataLike</span> <span class=o >|</span> <span class=kc >None</span> <span class=o >=</span> <span class=kc >None</span><span class=p >,</span>
        <span class=n >data</span><span class=p >:</span> <span class=n >DataFrame</span> <span class=o >|</span> <span class=kc >None</span> <span class=o >=</span> <span class=kc >None</span><span class=p >,</span>
        <span class=n >context</span><span class=p >:</span> <span class=nb >int</span> <span class=o >=</span> <span class=mi >4</span><span class=p >,</span>
    <span class=p >)</span> <span class=o >-&gt;</span> <span class=n >DataFrame</span><span class=p >:</span>
        <span class=sd >"""</span>
<span class=sd >        Predict values for additional data</span>

<span class=sd >        Parameters</span>
<span class=sd >        ----------</span>
<span class=sd >        params : array_like</span>
<span class=sd >            Model parameters (nvar by 1)</span>
<span class=sd >        exog : array_like</span>
<span class=sd >            Exogenous regressors (nobs by nvar)</span>
<span class=sd >        data : DataFrame</span>
<span class=sd >            Values to use when making predictions from a model constructed</span>
<span class=sd >            from a formula</span>
<span class=sd >        context : int</span>
<span class=sd >            Depth to use when evaluating formulas.</span>

<span class=sd >        Returns</span>
<span class=sd >        -------</span>
<span class=sd >        DataFrame</span>
<span class=sd >            Fitted values from supplied data and parameters</span>

<span class=sd >        Notes</span>
<span class=sd >        -----</span>
<span class=sd >        If `data` is not None, then `exog` must be None.</span>
<span class=sd >        Predictions from models constructed using formulas can</span>
<span class=sd >        be computed using either `exog`, which will treat these are</span>
<span class=sd >        arrays of values corresponding to the formula-processed data, or using</span>
<span class=sd >        `data` which will be processed using the formula used to construct the</span>
<span class=sd >        values corresponding to the original model specification.</span>
<span class=sd >        """</span>
        <span class=k >if</span> <span class=n >data</span> <span class=ow >is</span> <span class=ow >not</span> <span class=kc >None</span> <span class=ow >and</span> <span class=bp >self</span><span class=o >.</span><span class=n >formula</span> <span class=ow >is</span> <span class=kc >None</span><span class=p >:</span>
            <span class=k >raise</span> <span class=ne >ValueError</span><span class=p >(</span>
                <span class=s2 >"Unable to use data when the model was not "</span> <span class=s2 >"created using a formula."</span>
            <span class=p >)</span>
        <span class=k >if</span> <span class=n >data</span> <span class=ow >is</span> <span class=ow >not</span> <span class=kc >None</span> <span class=ow >and</span> <span class=n >exog</span> <span class=ow >is</span> <span class=ow >not</span> <span class=kc >None</span><span class=p >:</span>
            <span class=k >raise</span> <span class=ne >ValueError</span><span class=p >(</span>
                <span class=s2 >"Predictions can only be constructed using one "</span>
                <span class=s2 >"of exog or data, but not both."</span>
            <span class=p >)</span>
        <span class=k >if</span> <span class=n >exog</span> <span class=ow >is</span> <span class=ow >not</span> <span class=kc >None</span><span class=p >:</span>
            <span class=n >exog</span> <span class=o >=</span> <span class=n >PanelData</span><span class=p >(</span><span class=n >exog</span><span class=p >)</span><span class=o >.</span><span class=n >dataframe</span>
        <span class=k >else</span><span class=p >:</span>
            <span class=k >assert</span> <span class=bp >self</span><span class=o >.</span><span class=n >_formula</span> <span class=ow >is</span> <span class=ow >not</span> <span class=kc >None</span>
            <span class=k >assert</span> <span class=n >data</span> <span class=ow >is</span> <span class=ow >not</span> <span class=kc >None</span>
            <span class=n >parser</span> <span class=o >=</span> <span class=n >PanelFormulaParser</span><span class=p >(</span><span class=bp >self</span><span class=o >.</span><span class=n >_formula</span><span class=p >,</span> <span class=n >data</span><span class=p >,</span> <span class=n >context</span><span class=o >=</span><span class=n >context</span><span class=p >)</span>
            <span class=n >exog</span> <span class=o >=</span> <span class=n >parser</span><span class=o >.</span><span class=n >exog</span>
        <span class=n >x</span> <span class=o >=</span> <span class=n >exog</span><span class=o >.</span><span class=n >values</span>
        <span class=n >params</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >atleast_2d</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >asarray</span><span class=p >(</span><span class=n >params</span><span class=p >))</span>
        <span class=k >if</span> <span class=n >params</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >]</span> <span class=o >==</span> <span class=mi >1</span><span class=p >:</span>
            <span class=n >params</span> <span class=o >=</span> <span class=n >params</span><span class=o >.</span><span class=n >T</span>
        <span class=k >if</span> <span class=n >x</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >1</span><span class=p >]</span> <span class=o >!=</span> <span class=n >params</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >]:</span>
            <span class=k >raise</span> <span class=ne >ValueError</span><span class=p >(</span>
                <span class=n >EXOG_PREDICT_MSG</span><span class=o >.</span><span class=n >format</span><span class=p >(</span>
                    <span class=n >x_shape</span><span class=o >=</span><span class=n >x</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >1</span><span class=p >],</span> <span class=n >params_shape</span><span class=o >=</span><span class=n >params</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >]</span>
                <span class=p >)</span>
            <span class=p >)</span>
        <span class=n >pred</span> <span class=o >=</span> <span class=n >DataFrame</span><span class=p >(</span><span class=n >x</span> <span class=o >@</span> <span class=n >params</span><span class=p >,</span> <span class=n >index</span><span class=o >=</span><span class=n >exog</span><span class=o >.</span><span class=n >index</span><span class=p >,</span> <span class=n >columns</span><span class=o >=</span><span class=p >[</span><span class=s2 >"predictions"</span><span class=p >])</span>

        <span class=k >return</span> <span class=n >pred</span></div></div>


<div class=viewcode-block  id=PanelOLS ><a class=viewcode-back  href="../../../panel/panel/linearmodels.panel.model.PanelOLS.html#linearmodels.panel.model.PanelOLS">[docs]</a><span class=k >class</span> <span class=nc >PanelOLS</span><span class=p >(</span><span class=n >_PanelModelBase</span><span class=p >):</span>
    <span class=sa >r</span><span class=sd >"""</span>
<span class=sd >    One- and two-way fixed effects estimator for panel data</span>

<span class=sd >    Parameters</span>
<span class=sd >    ----------</span>
<span class=sd >    dependent : array_like</span>
<span class=sd >        Dependent (left-hand-side) variable (time by entity).</span>
<span class=sd >    exog : array_like</span>
<span class=sd >        Exogenous or right-hand-side variables (variable by time by entity).</span>
<span class=sd >    weights : array_like</span>
<span class=sd >        Weights to use in estimation.  Assumes residual variance is</span>
<span class=sd >        proportional to inverse of weight to that the residual time</span>
<span class=sd >        the weight should be homoskedastic.</span>
<span class=sd >    entity_effects : bool</span>
<span class=sd >        Flag whether to include entity (fixed) effects in the model</span>
<span class=sd >    time_effects : bool</span>
<span class=sd >        Flag whether to include time effects in the model</span>
<span class=sd >    other_effects : array_like</span>
<span class=sd >        Category codes to use for any effects that are not entity or time</span>
<span class=sd >        effects. Each variable is treated as an effect.</span>
<span class=sd >    singletons : bool</span>
<span class=sd >        Flag indicating whether to drop singleton observation</span>
<span class=sd >    drop_absorbed : bool</span>
<span class=sd >        Flag indicating whether to drop absorbed variables</span>
<span class=sd >    check_rank : bool</span>
<span class=sd >        Flag indicating whether to perform a rank check on the exogenous</span>
<span class=sd >        variables to ensure that the model is identified. Skipping this</span>
<span class=sd >        check can reduce the time required to validate a model specification.</span>
<span class=sd >        Results may be numerically unstable if this check is skipped and</span>
<span class=sd >        the matrix is not full rank.</span>

<span class=sd >    Notes</span>
<span class=sd >    -----</span>
<span class=sd >    Many models can be estimated. The most common included entity effects and</span>
<span class=sd >    can be described</span>

<span class=sd >    .. math::</span>

<span class=sd >        y_{it} = \alpha_i + \beta^{\prime}x_{it} + \epsilon_{it}</span>

<span class=sd >    where :math:`\alpha_i` is included if ``entity_effects=True``.</span>

<span class=sd >    Time effect are also supported, which leads to a model of the form</span>

<span class=sd >    .. math::</span>

<span class=sd >        y_{it}= \gamma_t + \beta^{\prime}x_{it} + \epsilon_{it}</span>

<span class=sd >    where :math:`\gamma_i` is included if ``time_effects=True``.</span>

<span class=sd >    Both effects can be simultaneously used,</span>

<span class=sd >    .. math::</span>

<span class=sd >        y_{it}=\alpha_i + \gamma_t + \beta^{\prime}x_{it} + \epsilon_{it}</span>

<span class=sd >    Additionally , arbitrary effects can be specified using categorical variables.</span>

<span class=sd >    If both ``entity_effect``  and``time_effects`` are ``False``, and no other</span>
<span class=sd >    effects are included, the model reduces to :class:`PooledOLS`.</span>

<span class=sd >    Model supports at most 2 effects.  These can be entity-time, entity-other, time-other or</span>
<span class=sd >    2 other.</span>
<span class=sd >    """</span>

    <span class=k >def</span> <span class=fm >__init__</span><span class=p >(</span>
        <span class=bp >self</span><span class=p >,</span>
        <span class=n >dependent</span><span class=p >:</span> <span class=n >PanelDataLike</span><span class=p >,</span>
        <span class=n >exog</span><span class=p >:</span> <span class=n >PanelDataLike</span><span class=p >,</span>
        <span class=o >*</span><span class=p >,</span>
        <span class=n >weights</span><span class=p >:</span> <span class=n >PanelDataLike</span> <span class=o >|</span> <span class=kc >None</span> <span class=o >=</span> <span class=kc >None</span><span class=p >,</span>
        <span class=n >entity_effects</span><span class=p >:</span> <span class=nb >bool</span> <span class=o >=</span> <span class=kc >False</span><span class=p >,</span>
        <span class=n >time_effects</span><span class=p >:</span> <span class=nb >bool</span> <span class=o >=</span> <span class=kc >False</span><span class=p >,</span>
        <span class=n >other_effects</span><span class=p >:</span> <span class=n >PanelDataLike</span> <span class=o >|</span> <span class=kc >None</span> <span class=o >=</span> <span class=kc >None</span><span class=p >,</span>
        <span class=n >singletons</span><span class=p >:</span> <span class=nb >bool</span> <span class=o >=</span> <span class=kc >True</span><span class=p >,</span>
        <span class=n >drop_absorbed</span><span class=p >:</span> <span class=nb >bool</span> <span class=o >=</span> <span class=kc >False</span><span class=p >,</span>
        <span class=n >check_rank</span><span class=p >:</span> <span class=nb >bool</span> <span class=o >=</span> <span class=kc >True</span><span class=p >,</span>
    <span class=p >)</span> <span class=o >-&gt;</span> <span class=kc >None</span><span class=p >:</span>
        <span class=nb >super</span><span class=p >()</span><span class=o >.</span><span class=fm >__init__</span><span class=p >(</span><span class=n >dependent</span><span class=p >,</span> <span class=n >exog</span><span class=p >,</span> <span class=n >weights</span><span class=o >=</span><span class=n >weights</span><span class=p >,</span> <span class=n >check_rank</span><span class=o >=</span><span class=n >check_rank</span><span class=p >)</span>

        <span class=bp >self</span><span class=o >.</span><span class=n >_entity_effects</span> <span class=o >=</span> <span class=n >entity_effects</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >_time_effects</span> <span class=o >=</span> <span class=n >time_effects</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >_other_effect_cats</span><span class=p >:</span> <span class=n >PanelData</span> <span class=o >|</span> <span class=kc >None</span> <span class=o >=</span> <span class=kc >None</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >_singletons</span> <span class=o >=</span> <span class=n >singletons</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >_other_effects</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_validate_effects</span><span class=p >(</span><span class=n >other_effects</span><span class=p >)</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >_has_effect</span> <span class=o >=</span> <span class=n >entity_effects</span> <span class=ow >or</span> <span class=n >time_effects</span> <span class=ow >or</span> <span class=bp >self</span><span class=o >.</span><span class=n >other_effects</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >_drop_absorbed</span> <span class=o >=</span> <span class=n >drop_absorbed</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >_singleton_index</span> <span class=o >=</span> <span class=kc >None</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >_drop_singletons</span><span class=p >()</span>

    <span class=k >def</span> <span class=nf >_collect_effects</span><span class=p >(</span><span class=bp >self</span><span class=p >)</span> <span class=o >-&gt;</span> <span class=n >NumericArray</span><span class=p >:</span>
        <span class=k >if</span> <span class=ow >not</span> <span class=bp >self</span><span class=o >.</span><span class=n >_has_effect</span><span class=p >:</span>
            <span class=k >return</span> <span class=n >np</span><span class=o >.</span><span class=n >empty</span><span class=p >((</span><span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >],</span> <span class=mi >0</span><span class=p >))</span>
        <span class=n >effects</span> <span class=o >=</span> <span class=p >[]</span>
        <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >entity_effects</span><span class=p >:</span>
            <span class=n >effects</span><span class=o >.</span><span class=n >append</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >asarray</span><span class=p >(</span><span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >entity_ids</span><span class=p >)</span><span class=o >.</span><span class=n >squeeze</span><span class=p >())</span>
        <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >time_effects</span><span class=p >:</span>
            <span class=n >effects</span><span class=o >.</span><span class=n >append</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >asarray</span><span class=p >(</span><span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >time_ids</span><span class=p >)</span><span class=o >.</span><span class=n >squeeze</span><span class=p >())</span>
        <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >other_effects</span><span class=p >:</span>
            <span class=k >assert</span> <span class=bp >self</span><span class=o >.</span><span class=n >_other_effect_cats</span> <span class=ow >is</span> <span class=ow >not</span> <span class=kc >None</span>
            <span class=n >other</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_other_effect_cats</span><span class=o >.</span><span class=n >dataframe</span>
            <span class=k >for</span> <span class=n >col</span> <span class=ow >in</span> <span class=n >other</span><span class=p >:</span>
                <span class=n >effects</span><span class=o >.</span><span class=n >append</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >asarray</span><span class=p >(</span><span class=n >other</span><span class=p >[</span><span class=n >col</span><span class=p >])</span><span class=o >.</span><span class=n >squeeze</span><span class=p >())</span>
        <span class=k >return</span> <span class=n >np</span><span class=o >.</span><span class=n >column_stack</span><span class=p >(</span><span class=n >effects</span><span class=p >)</span>

    <span class=k >def</span> <span class=nf >_drop_singletons</span><span class=p >(</span><span class=bp >self</span><span class=p >)</span> <span class=o >-&gt;</span> <span class=kc >None</span><span class=p >:</span>
        <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >_singletons</span> <span class=ow >or</span> <span class=ow >not</span> <span class=bp >self</span><span class=o >.</span><span class=n >_has_effect</span><span class=p >:</span>
            <span class=k >return</span>
        <span class=n >effects</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_collect_effects</span><span class=p >()</span>
        <span class=n >retain</span> <span class=o >=</span> <span class=n >in_2core_graph</span><span class=p >(</span><span class=n >effects</span><span class=p >)</span>

        <span class=k >if</span> <span class=n >np</span><span class=o >.</span><span class=n >all</span><span class=p >(</span><span class=n >retain</span><span class=p >):</span>
            <span class=k >return</span>

        <span class=kn >import</span> <span class=nn >warnings</span> <span class=k >as</span> <span class=nn >warn</span>

        <span class=n >nobs</span> <span class=o >=</span> <span class=n >retain</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >]</span>
        <span class=n >ndropped</span> <span class=o >=</span> <span class=n >nobs</span> <span class=o >-</span> <span class=n >retain</span><span class=o >.</span><span class=n >sum</span><span class=p >()</span>
        <span class=n >warn</span><span class=o >.</span><span class=n >warn</span><span class=p >(</span>
            <span class=sa >f</span><span class=s2 >"</span><span class=si >{</span><span class=n >ndropped</span><span class=si >}</span><span class=s2 > singleton observations dropped"</span><span class=p >,</span>
            <span class=n >SingletonWarning</span><span class=p >,</span>
            <span class=n >stacklevel</span><span class=o >=</span><span class=mi >3</span><span class=p >,</span>
        <span class=p >)</span>
        <span class=n >drop</span> <span class=o >=</span> <span class=o >~</span><span class=n >retain</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >_singleton_index</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span><span class=n >BoolArray</span><span class=p >,</span> <span class=n >drop</span><span class=p >)</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >drop</span><span class=p >(</span><span class=n >drop</span><span class=p >)</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >exog</span><span class=o >.</span><span class=n >drop</span><span class=p >(</span><span class=n >drop</span><span class=p >)</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >weights</span><span class=o >.</span><span class=n >drop</span><span class=p >(</span><span class=n >drop</span><span class=p >)</span>
        <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >other_effects</span><span class=p >:</span>
            <span class=k >assert</span> <span class=bp >self</span><span class=o >.</span><span class=n >_other_effect_cats</span> <span class=ow >is</span> <span class=ow >not</span> <span class=kc >None</span>
            <span class=bp >self</span><span class=o >.</span><span class=n >_other_effect_cats</span><span class=o >.</span><span class=n >drop</span><span class=p >(</span><span class=n >drop</span><span class=p >)</span>
        <span class=c1 ># Reverify exog matrix</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >_check_exog_rank</span><span class=p >()</span>

    <span class=k >def</span> <span class=fm >__str__</span><span class=p >(</span><span class=bp >self</span><span class=p >)</span> <span class=o >-&gt;</span> <span class=nb >str</span><span class=p >:</span>
        <span class=n >out</span> <span class=o >=</span> <span class=nb >super</span><span class=p >()</span><span class=o >.</span><span class=fm >__str__</span><span class=p >()</span>
        <span class=n >additional</span> <span class=o >=</span> <span class=p >(</span>
            <span class=s2 >"</span><span class=se >\n</span><span class=s2 >Entity Effects: </span><span class=si >{ee}</span><span class=s2 >, Time Effects: </span><span class=si >{te}</span><span class=s2 >, Num Other Effects: </span><span class=si >{oe}</span><span class=s2 >"</span>
        <span class=p >)</span>
        <span class=n >oe</span> <span class=o >=</span> <span class=mi >0</span>
        <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >other_effects</span><span class=p >:</span>
            <span class=k >assert</span> <span class=bp >self</span><span class=o >.</span><span class=n >_other_effect_cats</span> <span class=ow >is</span> <span class=ow >not</span> <span class=kc >None</span>
            <span class=n >oe</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_other_effect_cats</span><span class=o >.</span><span class=n >nvar</span>
        <span class=n >additional</span> <span class=o >=</span> <span class=n >additional</span><span class=o >.</span><span class=n >format</span><span class=p >(</span>
            <span class=n >ee</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >entity_effects</span><span class=p >,</span> <span class=n >te</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >time_effects</span><span class=p >,</span> <span class=n >oe</span><span class=o >=</span><span class=n >oe</span>
        <span class=p >)</span>
        <span class=n >out</span> <span class=o >+=</span> <span class=n >additional</span>
        <span class=k >return</span> <span class=n >out</span>

    <span class=k >def</span> <span class=nf >_validate_effects</span><span class=p >(</span><span class=bp >self</span><span class=p >,</span> <span class=n >effects</span><span class=p >:</span> <span class=n >PanelDataLike</span> <span class=o >|</span> <span class=kc >None</span><span class=p >)</span> <span class=o >-&gt;</span> <span class=nb >bool</span><span class=p >:</span>
        <span class=sd >"""Check model effects"""</span>
        <span class=k >if</span> <span class=n >effects</span> <span class=ow >is</span> <span class=kc >None</span><span class=p >:</span>
            <span class=k >return</span> <span class=kc >False</span>
        <span class=n >effects</span> <span class=o >=</span> <span class=n >PanelData</span><span class=p >(</span><span class=n >effects</span><span class=p >,</span> <span class=n >var_name</span><span class=o >=</span><span class=s2 >"OtherEffect"</span><span class=p >,</span> <span class=n >convert_dummies</span><span class=o >=</span><span class=kc >False</span><span class=p >)</span>

        <span class=k >if</span> <span class=n >effects</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >1</span><span class=p >:]</span> <span class=o >!=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_original_shape</span><span class=p >[</span><span class=mi >1</span><span class=p >:]:</span>
            <span class=k >raise</span> <span class=ne >ValueError</span><span class=p >(</span>
                <span class=s2 >"other_effects must have the same number of "</span>
                <span class=s2 >"entities and time periods as dependent."</span>
            <span class=p >)</span>

        <span class=n >num_effects</span> <span class=o >=</span> <span class=n >effects</span><span class=o >.</span><span class=n >nvar</span>
        <span class=k >if</span> <span class=n >num_effects</span> <span class=o >+</span> <span class=bp >self</span><span class=o >.</span><span class=n >entity_effects</span> <span class=o >+</span> <span class=bp >self</span><span class=o >.</span><span class=n >time_effects</span> <span class=o >&gt;</span> <span class=mi >2</span><span class=p >:</span>
            <span class=k >raise</span> <span class=ne >ValueError</span><span class=p >(</span><span class=s2 >"At most two effects supported."</span><span class=p >)</span>
        <span class=n >cats</span> <span class=o >=</span> <span class=p >{}</span>
        <span class=n >effects_frame</span> <span class=o >=</span> <span class=n >effects</span><span class=o >.</span><span class=n >dataframe</span>
        <span class=k >for</span> <span class=n >col</span> <span class=ow >in</span> <span class=n >effects_frame</span><span class=p >:</span>
            <span class=n >cat</span> <span class=o >=</span> <span class=n >Categorical</span><span class=p >(</span><span class=n >effects_frame</span><span class=p >[</span><span class=n >col</span><span class=p >])</span>
            <span class=n >cats</span><span class=p >[</span><span class=n >col</span><span class=p >]</span> <span class=o >=</span> <span class=n >cat</span><span class=o >.</span><span class=n >codes</span><span class=o >.</span><span class=n >astype</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >int64</span><span class=p >)</span>
        <span class=n >cats</span> <span class=o >=</span> <span class=n >DataFrame</span><span class=p >(</span><span class=n >cats</span><span class=p >,</span> <span class=n >index</span><span class=o >=</span><span class=n >effects_frame</span><span class=o >.</span><span class=n >index</span><span class=p >)</span>
        <span class=n >cats</span> <span class=o >=</span> <span class=n >cats</span><span class=p >[</span><span class=n >effects_frame</span><span class=o >.</span><span class=n >columns</span><span class=p >]</span>
        <span class=n >other_effects</span> <span class=o >=</span> <span class=n >PanelData</span><span class=p >(</span><span class=n >cats</span><span class=p >)</span>
        <span class=n >other_effects</span><span class=o >.</span><span class=n >drop</span><span class=p >(</span><span class=o >~</span><span class=bp >self</span><span class=o >.</span><span class=n >not_null</span><span class=p >)</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >_other_effect_cats</span> <span class=o >=</span> <span class=n >other_effects</span>
        <span class=n >cats_array</span> <span class=o >=</span> <span class=n >other_effects</span><span class=o >.</span><span class=n >values2d</span>
        <span class=n >nested</span> <span class=o >=</span> <span class=kc >False</span>
        <span class=n >nesting_effect</span> <span class=o >=</span> <span class=s2 >""</span>
        <span class=k >if</span> <span class=n >cats_array</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >1</span><span class=p >]</span> <span class=o >==</span> <span class=mi >2</span><span class=p >:</span>
            <span class=n >nested</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_is_effect_nested</span><span class=p >(</span><span class=n >cats_array</span><span class=p >[:,</span> <span class=p >[</span><span class=mi >0</span><span class=p >]],</span> <span class=n >cats_array</span><span class=p >[:,</span> <span class=p >[</span><span class=mi >1</span><span class=p >]])</span>
            <span class=n >nested</span> <span class=o >|=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_is_effect_nested</span><span class=p >(</span><span class=n >cats_array</span><span class=p >[:,</span> <span class=p >[</span><span class=mi >1</span><span class=p >]],</span> <span class=n >cats_array</span><span class=p >[:,</span> <span class=p >[</span><span class=mi >0</span><span class=p >]])</span>
            <span class=n >nesting_effect</span> <span class=o >=</span> <span class=s2 >"other effects"</span>
        <span class=k >elif</span> <span class=bp >self</span><span class=o >.</span><span class=n >entity_effects</span><span class=p >:</span>
            <span class=n >nested</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_is_effect_nested</span><span class=p >(</span>
                <span class=n >cats_array</span><span class=p >[:,</span> <span class=p >[</span><span class=mi >0</span><span class=p >]],</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >entity_ids</span>
            <span class=p >)</span>
            <span class=n >nested</span> <span class=o >|=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_is_effect_nested</span><span class=p >(</span>
                <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >entity_ids</span><span class=p >,</span> <span class=n >cats_array</span><span class=p >[:,</span> <span class=p >[</span><span class=mi >0</span><span class=p >]]</span>
            <span class=p >)</span>
            <span class=n >nesting_effect</span> <span class=o >=</span> <span class=s2 >"entity effects"</span>
        <span class=k >elif</span> <span class=bp >self</span><span class=o >.</span><span class=n >time_effects</span><span class=p >:</span>
            <span class=n >nested</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_is_effect_nested</span><span class=p >(</span><span class=n >cats_array</span><span class=p >[:,</span> <span class=p >[</span><span class=mi >0</span><span class=p >]],</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >time_ids</span><span class=p >)</span>
            <span class=n >nested</span> <span class=o >|=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_is_effect_nested</span><span class=p >(</span>
                <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >time_ids</span><span class=p >,</span> <span class=n >cats_array</span><span class=p >[:,</span> <span class=p >[</span><span class=mi >0</span><span class=p >]]</span>
            <span class=p >)</span>
            <span class=n >nesting_effect</span> <span class=o >=</span> <span class=s2 >"time effects"</span>
        <span class=k >if</span> <span class=n >nested</span><span class=p >:</span>
            <span class=k >raise</span> <span class=ne >ValueError</span><span class=p >(</span>
                <span class=s2 >"Included other effects nest or are nested "</span>
                <span class=s2 >"by </span><span class=si >{effect}</span><span class=s2 >"</span><span class=o >.</span><span class=n >format</span><span class=p >(</span><span class=n >effect</span><span class=o >=</span><span class=n >nesting_effect</span><span class=p >)</span>
            <span class=p >)</span>

        <span class=k >return</span> <span class=kc >True</span>

    <span class=nd >@property</span>
    <span class=k >def</span> <span class=nf >entity_effects</span><span class=p >(</span><span class=bp >self</span><span class=p >)</span> <span class=o >-&gt;</span> <span class=nb >bool</span><span class=p >:</span>
        <span class=sd >"""Flag indicating whether entity effects are included"""</span>
        <span class=k >return</span> <span class=bp >self</span><span class=o >.</span><span class=n >_entity_effects</span>

    <span class=nd >@property</span>
    <span class=k >def</span> <span class=nf >time_effects</span><span class=p >(</span><span class=bp >self</span><span class=p >)</span> <span class=o >-&gt;</span> <span class=nb >bool</span><span class=p >:</span>
        <span class=sd >"""Flag indicating whether time effects are included"""</span>
        <span class=k >return</span> <span class=bp >self</span><span class=o >.</span><span class=n >_time_effects</span>

    <span class=nd >@property</span>
    <span class=k >def</span> <span class=nf >other_effects</span><span class=p >(</span><span class=bp >self</span><span class=p >)</span> <span class=o >-&gt;</span> <span class=nb >bool</span><span class=p >:</span>
        <span class=sd >"""Flag indicating whether other (generic) effects are included"""</span>
        <span class=k >return</span> <span class=bp >self</span><span class=o >.</span><span class=n >_other_effects</span>

<div class=viewcode-block  id=PanelOLS.from_formula ><a class=viewcode-back  href="../../../panel/panel/linearmodels.panel.model.PanelOLS.from_formula.html#linearmodels.panel.model.PanelOLS.from_formula">[docs]</a>    <span class=nd >@classmethod</span>
    <span class=k >def</span> <span class=nf >from_formula</span><span class=p >(</span>
        <span class=bp >cls</span><span class=p >,</span>
        <span class=n >formula</span><span class=p >:</span> <span class=nb >str</span><span class=p >,</span>
        <span class=n >data</span><span class=p >:</span> <span class=n >PanelDataLike</span><span class=p >,</span>
        <span class=o >*</span><span class=p >,</span>
        <span class=n >weights</span><span class=p >:</span> <span class=n >PanelDataLike</span> <span class=o >|</span> <span class=kc >None</span> <span class=o >=</span> <span class=kc >None</span><span class=p >,</span>
        <span class=n >other_effects</span><span class=p >:</span> <span class=n >PanelDataLike</span> <span class=o >|</span> <span class=kc >None</span> <span class=o >=</span> <span class=kc >None</span><span class=p >,</span>
        <span class=n >singletons</span><span class=p >:</span> <span class=nb >bool</span> <span class=o >=</span> <span class=kc >True</span><span class=p >,</span>
        <span class=n >drop_absorbed</span><span class=p >:</span> <span class=nb >bool</span> <span class=o >=</span> <span class=kc >False</span><span class=p >,</span>
        <span class=n >check_rank</span><span class=p >:</span> <span class=nb >bool</span> <span class=o >=</span> <span class=kc >True</span><span class=p >,</span>
    <span class=p >)</span> <span class=o >-&gt;</span> <span class=n >PanelOLS</span><span class=p >:</span>
        <span class=sd >"""</span>
<span class=sd >        Create a model from a formula</span>

<span class=sd >        Parameters</span>
<span class=sd >        ----------</span>
<span class=sd >        formula : str</span>
<span class=sd >            Formula to transform into model. Conforms to formulaic formula</span>
<span class=sd >            rules with two special variable names, EntityEffects and</span>
<span class=sd >            TimeEffects which can be used to specify that the model should</span>
<span class=sd >            contain an entity effect or a time effect, respectively. See</span>
<span class=sd >            Examples.</span>
<span class=sd >        data : array_like</span>
<span class=sd >            Data structure that can be coerced into a PanelData.  In most</span>
<span class=sd >            cases, this should be a multi-index DataFrame where the level 0</span>
<span class=sd >            index contains the entities and the level 1 contains the time.</span>
<span class=sd >        weights: array_like</span>
<span class=sd >            Weights to use in estimation.  Assumes residual variance is</span>
<span class=sd >            proportional to inverse of weight to that the residual time</span>
<span class=sd >            the weight should be homoskedastic.</span>
<span class=sd >        other_effects : array_like</span>
<span class=sd >            Category codes to use for any effects that are not entity or time</span>
<span class=sd >            effects. Each variable is treated as an effect.</span>
<span class=sd >        singletons : bool</span>
<span class=sd >            Flag indicating whether to drop singleton observation</span>
<span class=sd >        drop_absorbed : bool</span>
<span class=sd >            Flag indicating whether to drop absorbed variables</span>
<span class=sd >        check_rank : bool</span>
<span class=sd >            Flag indicating whether to perform a rank check on the exogenous</span>
<span class=sd >            variables to ensure that the model is identified. Skipping this</span>
<span class=sd >            check can reduce the time required to validate a model</span>
<span class=sd >            specification. Results may be numerically unstable if this check</span>
<span class=sd >            is skipped and the matrix is not full rank.</span>

<span class=sd >        Returns</span>
<span class=sd >        -------</span>
<span class=sd >        PanelOLS</span>
<span class=sd >            Model specified using the formula</span>

<span class=sd >        Examples</span>
<span class=sd >        --------</span>
<span class=sd >        &gt;&gt;&gt; from linearmodels import PanelOLS</span>
<span class=sd >        &gt;&gt;&gt; from linearmodels.panel import generate_panel_data</span>
<span class=sd >        &gt;&gt;&gt; panel_data = generate_panel_data()</span>
<span class=sd >        &gt;&gt;&gt; mod = PanelOLS.from_formula("y ~ 1 + x1 + EntityEffects", panel_data.data)</span>
<span class=sd >        &gt;&gt;&gt; res = mod.fit(cov_type="clustered", cluster_entity=True)</span>
<span class=sd >        """</span>
        <span class=n >parser</span> <span class=o >=</span> <span class=n >PanelFormulaParser</span><span class=p >(</span><span class=n >formula</span><span class=p >,</span> <span class=n >data</span><span class=p >)</span>
        <span class=n >entity_effect</span> <span class=o >=</span> <span class=n >parser</span><span class=o >.</span><span class=n >entity_effect</span>
        <span class=n >time_effect</span> <span class=o >=</span> <span class=n >parser</span><span class=o >.</span><span class=n >time_effect</span>
        <span class=n >dependent</span><span class=p >,</span> <span class=n >exog</span> <span class=o >=</span> <span class=n >parser</span><span class=o >.</span><span class=n >data</span>
        <span class=n >mod</span> <span class=o >=</span> <span class=bp >cls</span><span class=p >(</span>
            <span class=n >dependent</span><span class=p >,</span>
            <span class=n >exog</span><span class=p >,</span>
            <span class=n >entity_effects</span><span class=o >=</span><span class=n >entity_effect</span><span class=p >,</span>
            <span class=n >time_effects</span><span class=o >=</span><span class=n >time_effect</span><span class=p >,</span>
            <span class=n >weights</span><span class=o >=</span><span class=n >weights</span><span class=p >,</span>
            <span class=n >other_effects</span><span class=o >=</span><span class=n >other_effects</span><span class=p >,</span>
            <span class=n >singletons</span><span class=o >=</span><span class=n >singletons</span><span class=p >,</span>
            <span class=n >drop_absorbed</span><span class=o >=</span><span class=n >drop_absorbed</span><span class=p >,</span>
            <span class=n >check_rank</span><span class=o >=</span><span class=n >check_rank</span><span class=p >,</span>
        <span class=p >)</span>
        <span class=n >mod</span><span class=o >.</span><span class=n >formula</span> <span class=o >=</span> <span class=n >formula</span>
        <span class=k >return</span> <span class=n >mod</span></div>

    <span class=k >def</span> <span class=nf >_lsmr_path</span><span class=p >(</span>
        <span class=bp >self</span><span class=p >,</span>
    <span class=p >)</span> <span class=o >-&gt;</span> <span class=nb >tuple</span><span class=p >[</span><span class=n >Float64Array</span><span class=p >,</span> <span class=n >Float64Array</span><span class=p >,</span> <span class=n >Float64Array</span><span class=p >,</span> <span class=n >Float64Array</span><span class=p >,</span> <span class=n >Float64Array</span><span class=p >]:</span>
        <span class=sd >"""Sparse implementation, works for all scenarios"""</span>
        <span class=n >y</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span><span class=n >Float64Array</span><span class=p >,</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >values2d</span><span class=p >)</span>
        <span class=n >x</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span><span class=n >Float64Array</span><span class=p >,</span> <span class=bp >self</span><span class=o >.</span><span class=n >exog</span><span class=o >.</span><span class=n >values2d</span><span class=p >)</span>
        <span class=n >w</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span><span class=n >Float64Array</span><span class=p >,</span> <span class=bp >self</span><span class=o >.</span><span class=n >weights</span><span class=o >.</span><span class=n >values2d</span><span class=p >)</span>
        <span class=n >root_w</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >sqrt</span><span class=p >(</span><span class=n >w</span><span class=p >)</span>
        <span class=n >wybar</span> <span class=o >=</span> <span class=n >root_w</span> <span class=o >*</span> <span class=p >(</span><span class=n >w</span><span class=o >.</span><span class=n >T</span> <span class=o >@</span> <span class=n >y</span> <span class=o >/</span> <span class=n >w</span><span class=o >.</span><span class=n >sum</span><span class=p >())</span>
        <span class=n >wy</span> <span class=o >=</span> <span class=n >root_w</span> <span class=o >*</span> <span class=n >y</span>
        <span class=n >wx</span> <span class=o >=</span> <span class=n >root_w</span> <span class=o >*</span> <span class=n >x</span>
        <span class=k >if</span> <span class=ow >not</span> <span class=bp >self</span><span class=o >.</span><span class=n >_has_effect</span><span class=p >:</span>
            <span class=n >y_effect</span><span class=p >,</span> <span class=n >x_effect</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >zeros_like</span><span class=p >(</span><span class=n >wy</span><span class=p >),</span> <span class=n >np</span><span class=o >.</span><span class=n >zeros_like</span><span class=p >(</span><span class=n >wx</span><span class=p >)</span>
            <span class=k >return</span> <span class=n >wy</span><span class=p >,</span> <span class=n >wx</span><span class=p >,</span> <span class=n >wybar</span><span class=p >,</span> <span class=n >y_effect</span><span class=p >,</span> <span class=n >x_effect</span>

        <span class=n >wy_gm</span> <span class=o >=</span> <span class=n >wybar</span>
        <span class=n >wx_gm</span> <span class=o >=</span> <span class=n >root_w</span> <span class=o >*</span> <span class=p >(</span><span class=n >w</span><span class=o >.</span><span class=n >T</span> <span class=o >@</span> <span class=n >x</span> <span class=o >/</span> <span class=n >w</span><span class=o >.</span><span class=n >sum</span><span class=p >())</span>
        <span class=n >root_w_sparse</span> <span class=o >=</span> <span class=n >csc_matrix</span><span class=p >(</span><span class=n >root_w</span><span class=p >)</span>

        <span class=n >cats_l</span><span class=p >:</span> <span class=nb >list</span><span class=p >[</span><span class=n >IntArray</span> <span class=o >|</span> <span class=n >Float64Array</span><span class=p >]</span> <span class=o >=</span> <span class=p >[]</span>
        <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >entity_effects</span><span class=p >:</span>
            <span class=n >cats_l</span><span class=o >.</span><span class=n >append</span><span class=p >(</span><span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >entity_ids</span><span class=p >)</span>
        <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >time_effects</span><span class=p >:</span>
            <span class=n >cats_l</span><span class=o >.</span><span class=n >append</span><span class=p >(</span><span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >time_ids</span><span class=p >)</span>
        <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >other_effects</span><span class=p >:</span>
            <span class=k >assert</span> <span class=bp >self</span><span class=o >.</span><span class=n >_other_effect_cats</span> <span class=ow >is</span> <span class=ow >not</span> <span class=kc >None</span>
            <span class=n >cats_l</span><span class=o >.</span><span class=n >append</span><span class=p >(</span><span class=bp >self</span><span class=o >.</span><span class=n >_other_effect_cats</span><span class=o >.</span><span class=n >values2d</span><span class=p >)</span>
        <span class=n >cats</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >concatenate</span><span class=p >(</span><span class=n >cats_l</span><span class=p >,</span> <span class=mi >1</span><span class=p >)</span>

        <span class=n >wd</span><span class=p >,</span> <span class=n >cond</span> <span class=o >=</span> <span class=n >dummy_matrix</span><span class=p >(</span><span class=n >cats</span><span class=p >,</span> <span class=n >precondition</span><span class=o >=</span><span class=kc >True</span><span class=p >)</span>
        <span class=k >assert</span> <span class=nb >isinstance</span><span class=p >(</span><span class=n >wd</span><span class=p >,</span> <span class=n >csc_matrix</span><span class=p >)</span>
        <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >_is_weighted</span><span class=p >:</span>
            <span class=n >wd</span> <span class=o >=</span> <span class=n >wd</span><span class=o >.</span><span class=n >multiply</span><span class=p >(</span><span class=n >root_w_sparse</span><span class=p >)</span>

        <span class=n >wx_mean_l</span> <span class=o >=</span> <span class=p >[]</span>
        <span class=k >for</span> <span class=n >i</span> <span class=ow >in</span> <span class=nb >range</span><span class=p >(</span><span class=n >x</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >1</span><span class=p >]):</span>
            <span class=n >cond_mean</span> <span class=o >=</span> <span class=n >lsmr</span><span class=p >(</span><span class=n >wd</span><span class=p >,</span> <span class=n >wx</span><span class=p >[:,</span> <span class=n >i</span><span class=p >],</span> <span class=n >atol</span><span class=o >=</span><span class=mf >1e-8</span><span class=p >,</span> <span class=n >btol</span><span class=o >=</span><span class=mf >1e-8</span><span class=p >)[</span><span class=mi >0</span><span class=p >]</span>
            <span class=n >cond_mean</span> <span class=o >/=</span> <span class=n >cond</span>
            <span class=n >wx_mean_l</span><span class=o >.</span><span class=n >append</span><span class=p >(</span><span class=n >cond_mean</span><span class=p >)</span>
        <span class=n >wx_mean</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >column_stack</span><span class=p >(</span><span class=n >wx_mean_l</span><span class=p >)</span>
        <span class=n >wy_mean</span> <span class=o >=</span> <span class=n >lsmr</span><span class=p >(</span><span class=n >wd</span><span class=p >,</span> <span class=n >wy</span><span class=p >,</span> <span class=n >atol</span><span class=o >=</span><span class=mf >1e-8</span><span class=p >,</span> <span class=n >btol</span><span class=o >=</span><span class=mf >1e-8</span><span class=p >)[</span><span class=mi >0</span><span class=p >]</span>
        <span class=n >wy_mean</span> <span class=o >/=</span> <span class=n >cond</span>
        <span class=n >wy_mean</span> <span class=o >=</span> <span class=n >wy_mean</span><span class=p >[:,</span> <span class=kc >None</span><span class=p >]</span>

        <span class=n >wx_mean</span> <span class=o >=</span> <span class=n >csc_matrix</span><span class=p >(</span><span class=n >wx_mean</span><span class=p >)</span>
        <span class=n >wy_mean</span> <span class=o >=</span> <span class=n >csc_matrix</span><span class=p >(</span><span class=n >wy_mean</span><span class=p >)</span>

        <span class=c1 ># Purge fitted, weighted values</span>
        <span class=n >sp_cond</span> <span class=o >=</span> <span class=n >diags</span><span class=p >(</span><span class=n >cond</span><span class=p >,</span> <span class=nb >format</span><span class=o >=</span><span class=s2 >"csc"</span><span class=p >)</span>
        <span class=n >wx</span> <span class=o >=</span> <span class=n >wx</span> <span class=o >-</span> <span class=p >(</span><span class=n >wd</span> <span class=o >@</span> <span class=n >sp_cond</span> <span class=o >@</span> <span class=n >wx_mean</span><span class=p >)</span><span class=o >.</span><span class=n >A</span>
        <span class=n >wy</span> <span class=o >=</span> <span class=n >wy</span> <span class=o >-</span> <span class=p >(</span><span class=n >wd</span> <span class=o >@</span> <span class=n >sp_cond</span> <span class=o >@</span> <span class=n >wy_mean</span><span class=p >)</span><span class=o >.</span><span class=n >A</span>

        <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >has_constant</span><span class=p >:</span>
            <span class=n >wy</span> <span class=o >+=</span> <span class=n >wy_gm</span>
            <span class=n >wx</span> <span class=o >+=</span> <span class=n >wx_gm</span>
        <span class=k >else</span><span class=p >:</span>
            <span class=n >wybar</span> <span class=o >=</span> <span class=mi >0</span>

        <span class=n >y_effects</span> <span class=o >=</span> <span class=n >y</span> <span class=o >-</span> <span class=n >wy</span> <span class=o >/</span> <span class=n >root_w</span>
        <span class=n >x_effects</span> <span class=o >=</span> <span class=n >x</span> <span class=o >-</span> <span class=n >wx</span> <span class=o >/</span> <span class=n >root_w</span>

        <span class=k >return</span> <span class=n >wy</span><span class=p >,</span> <span class=n >wx</span><span class=p >,</span> <span class=n >wybar</span><span class=p >,</span> <span class=n >y_effects</span><span class=p >,</span> <span class=n >x_effects</span>

    <span class=k >def</span> <span class=nf >_slow_path</span><span class=p >(</span>
        <span class=bp >self</span><span class=p >,</span>
    <span class=p >)</span> <span class=o >-&gt;</span> <span class=nb >tuple</span><span class=p >[</span><span class=n >Float64Array</span><span class=p >,</span> <span class=n >Float64Array</span><span class=p >,</span> <span class=n >Float64Array</span><span class=p >,</span> <span class=n >Float64Array</span><span class=p >,</span> <span class=n >Float64Array</span><span class=p >]:</span>
        <span class=sd >"""Frisch-Waugh-Lovell implementation, works for all scenarios"""</span>
        <span class=n >w</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span><span class=n >Float64Array</span><span class=p >,</span> <span class=bp >self</span><span class=o >.</span><span class=n >weights</span><span class=o >.</span><span class=n >values2d</span><span class=p >)</span>
        <span class=n >root_w</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >sqrt</span><span class=p >(</span><span class=n >w</span><span class=p >)</span>

        <span class=n >y</span> <span class=o >=</span> <span class=n >root_w</span> <span class=o >*</span> <span class=n >cast</span><span class=p >(</span><span class=n >Float64Array</span><span class=p >,</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >values2d</span><span class=p >)</span>
        <span class=n >x</span> <span class=o >=</span> <span class=n >root_w</span> <span class=o >*</span> <span class=n >cast</span><span class=p >(</span><span class=n >Float64Array</span><span class=p >,</span> <span class=bp >self</span><span class=o >.</span><span class=n >exog</span><span class=o >.</span><span class=n >values2d</span><span class=p >)</span>
        <span class=k >if</span> <span class=ow >not</span> <span class=bp >self</span><span class=o >.</span><span class=n >_has_effect</span><span class=p >:</span>
            <span class=n >ybar</span> <span class=o >=</span> <span class=n >root_w</span> <span class=o >@</span> <span class=n >_lstsq</span><span class=p >(</span><span class=n >root_w</span><span class=p >,</span> <span class=n >y</span><span class=p >,</span> <span class=n >rcond</span><span class=o >=</span><span class=kc >None</span><span class=p >)[</span><span class=mi >0</span><span class=p >]</span>
            <span class=n >y_effect</span><span class=p >,</span> <span class=n >x_effect</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >zeros_like</span><span class=p >(</span><span class=n >y</span><span class=p >),</span> <span class=n >np</span><span class=o >.</span><span class=n >zeros_like</span><span class=p >(</span><span class=n >x</span><span class=p >)</span>
            <span class=k >return</span> <span class=n >y</span><span class=p >,</span> <span class=n >x</span><span class=p >,</span> <span class=n >ybar</span><span class=p >,</span> <span class=n >y_effect</span><span class=p >,</span> <span class=n >x_effect</span>

        <span class=n >drop_first</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_constant</span>
        <span class=n >d_l</span> <span class=o >=</span> <span class=p >[]</span>
        <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >entity_effects</span><span class=p >:</span>
            <span class=n >d_l</span><span class=o >.</span><span class=n >append</span><span class=p >(</span><span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >dummies</span><span class=p >(</span><span class=s2 >"entity"</span><span class=p >,</span> <span class=n >drop_first</span><span class=o >=</span><span class=n >drop_first</span><span class=p >)</span><span class=o >.</span><span class=n >values</span><span class=p >)</span>
            <span class=n >drop_first</span> <span class=o >=</span> <span class=kc >True</span>
        <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >time_effects</span><span class=p >:</span>
            <span class=n >d_l</span><span class=o >.</span><span class=n >append</span><span class=p >(</span><span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >dummies</span><span class=p >(</span><span class=s2 >"time"</span><span class=p >,</span> <span class=n >drop_first</span><span class=o >=</span><span class=n >drop_first</span><span class=p >)</span><span class=o >.</span><span class=n >values</span><span class=p >)</span>
            <span class=n >drop_first</span> <span class=o >=</span> <span class=kc >True</span>
        <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >other_effects</span><span class=p >:</span>
            <span class=k >assert</span> <span class=bp >self</span><span class=o >.</span><span class=n >_other_effect_cats</span> <span class=ow >is</span> <span class=ow >not</span> <span class=kc >None</span>
            <span class=n >oe</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_other_effect_cats</span><span class=o >.</span><span class=n >dataframe</span>
            <span class=k >for</span> <span class=n >c</span> <span class=ow >in</span> <span class=n >oe</span><span class=p >:</span>
                <span class=n >dummies</span> <span class=o >=</span> <span class=n >get_dummies</span><span class=p >(</span><span class=n >oe</span><span class=p >[</span><span class=n >c</span><span class=p >],</span> <span class=n >drop_first</span><span class=o >=</span><span class=n >drop_first</span><span class=p >)</span><span class=o >.</span><span class=n >astype</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >float64</span><span class=p >)</span>
                <span class=n >d_l</span><span class=o >.</span><span class=n >append</span><span class=p >(</span><span class=n >dummies</span><span class=o >.</span><span class=n >values</span><span class=p >)</span>
                <span class=n >drop_first</span> <span class=o >=</span> <span class=kc >True</span>

        <span class=n >d</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >column_stack</span><span class=p >(</span><span class=n >d_l</span><span class=p >)</span>
        <span class=n >wd</span> <span class=o >=</span> <span class=n >root_w</span> <span class=o >*</span> <span class=n >d</span>
        <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >has_constant</span><span class=p >:</span>
            <span class=n >wd</span> <span class=o >-=</span> <span class=n >root_w</span> <span class=o >*</span> <span class=p >(</span><span class=n >w</span><span class=o >.</span><span class=n >T</span> <span class=o >@</span> <span class=n >d</span> <span class=o >/</span> <span class=n >w</span><span class=o >.</span><span class=n >sum</span><span class=p >())</span>
            <span class=n >z</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >ones_like</span><span class=p >(</span><span class=n >root_w</span><span class=p >)</span>
            <span class=n >d</span> <span class=o >-=</span> <span class=n >z</span> <span class=o >*</span> <span class=p >(</span><span class=n >z</span><span class=o >.</span><span class=n >T</span> <span class=o >@</span> <span class=n >d</span> <span class=o >/</span> <span class=n >z</span><span class=o >.</span><span class=n >sum</span><span class=p >())</span>

        <span class=n >x_mean</span> <span class=o >=</span> <span class=n >_lstsq</span><span class=p >(</span><span class=n >wd</span><span class=p >,</span> <span class=n >x</span><span class=p >,</span> <span class=n >rcond</span><span class=o >=</span><span class=kc >None</span><span class=p >)[</span><span class=mi >0</span><span class=p >]</span>
        <span class=n >y_mean</span> <span class=o >=</span> <span class=n >_lstsq</span><span class=p >(</span><span class=n >wd</span><span class=p >,</span> <span class=n >y</span><span class=p >,</span> <span class=n >rcond</span><span class=o >=</span><span class=kc >None</span><span class=p >)[</span><span class=mi >0</span><span class=p >]</span>

        <span class=c1 ># Save fitted unweighted effects to use in eps calculation</span>
        <span class=n >x_effects</span> <span class=o >=</span> <span class=n >d</span> <span class=o >@</span> <span class=n >x_mean</span>
        <span class=n >y_effects</span> <span class=o >=</span> <span class=n >d</span> <span class=o >@</span> <span class=n >y_mean</span>

        <span class=c1 ># Purge fitted, weighted values</span>
        <span class=n >x</span> <span class=o >=</span> <span class=n >x</span> <span class=o >-</span> <span class=n >wd</span> <span class=o >@</span> <span class=n >x_mean</span>
        <span class=n >y</span> <span class=o >=</span> <span class=n >y</span> <span class=o >-</span> <span class=n >wd</span> <span class=o >@</span> <span class=n >y_mean</span>

        <span class=n >ybar</span> <span class=o >=</span> <span class=n >root_w</span> <span class=o >@</span> <span class=n >_lstsq</span><span class=p >(</span><span class=n >root_w</span><span class=p >,</span> <span class=n >y</span><span class=p >,</span> <span class=n >rcond</span><span class=o >=</span><span class=kc >None</span><span class=p >)[</span><span class=mi >0</span><span class=p >]</span>
        <span class=k >return</span> <span class=n >y</span><span class=p >,</span> <span class=n >x</span><span class=p >,</span> <span class=n >ybar</span><span class=p >,</span> <span class=n >y_effects</span><span class=p >,</span> <span class=n >x_effects</span>

    <span class=k >def</span> <span class=nf >_choose_twoway_algo</span><span class=p >(</span><span class=bp >self</span><span class=p >)</span> <span class=o >-&gt;</span> <span class=nb >bool</span><span class=p >:</span>
        <span class=k >if</span> <span class=ow >not</span> <span class=p >(</span><span class=bp >self</span><span class=o >.</span><span class=n >entity_effects</span> <span class=ow >and</span> <span class=bp >self</span><span class=o >.</span><span class=n >time_effects</span><span class=p >):</span>
            <span class=k >return</span> <span class=kc >False</span>
        <span class=n >nentity</span><span class=p >,</span> <span class=n >nobs</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >nentity</span><span class=p >,</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >nobs</span>
        <span class=n >nreg</span> <span class=o >=</span> <span class=nb >min</span><span class=p >(</span><span class=n >nentity</span><span class=p >,</span> <span class=n >nobs</span><span class=p >)</span>
        <span class=k >if</span> <span class=n >nreg</span> <span class=o >&lt;</span> <span class=bp >self</span><span class=o >.</span><span class=n >exog</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >1</span><span class=p >]:</span>
            <span class=k >return</span> <span class=kc >False</span>
        <span class=c1 ># MiB</span>
        <span class=n >reg_size</span> <span class=o >=</span> <span class=mi >8</span> <span class=o >*</span> <span class=n >nentity</span> <span class=o >*</span> <span class=n >nobs</span> <span class=o >*</span> <span class=n >nreg</span> <span class=o >//</span> <span class=mi >2</span><span class=o >**</span><span class=mi >20</span>
        <span class=n >low_memory</span> <span class=o >=</span> <span class=n >reg_size</span> <span class=o >&gt;</span> <span class=mi >2</span><span class=o >**</span><span class=mi >10</span>
        <span class=k >if</span> <span class=n >low_memory</span><span class=p >:</span>
            <span class=kn >import</span> <span class=nn >warnings</span>

            <span class=n >warnings</span><span class=o >.</span><span class=n >warn</span><span class=p >(</span>
                <span class=s2 >"Using low-memory algorithm to estimate two-way model. Explicitly set "</span>
                <span class=s2 >"low_memory=True to silence this message.  Set low_memory=False to use "</span>
                <span class=s2 >"the standard algorithm that creates dummy variables for the smaller of "</span>
                <span class=s2 >"the number of entities or number of time periods."</span><span class=p >,</span>
                <span class=n >MemoryWarning</span><span class=p >,</span>
                <span class=n >stacklevel</span><span class=o >=</span><span class=mi >3</span><span class=p >,</span>
            <span class=p >)</span>
        <span class=k >return</span> <span class=n >low_memory</span>

    <span class=k >def</span> <span class=nf >_fast_path</span><span class=p >(</span>
        <span class=bp >self</span><span class=p >,</span> <span class=n >low_memory</span><span class=p >:</span> <span class=nb >bool</span>
    <span class=p >)</span> <span class=o >-&gt;</span> <span class=nb >tuple</span><span class=p >[</span><span class=n >Float64Array</span><span class=p >,</span> <span class=n >Float64Array</span><span class=p >,</span> <span class=n >Float64Array</span><span class=p >]:</span>
        <span class=sd >"""Dummy-variable free estimation without weights"""</span>
        <span class=n >_y</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >values2d</span>
        <span class=n >_x</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >exog</span><span class=o >.</span><span class=n >values2d</span>
        <span class=n >ybar</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >asarray</span><span class=p >(</span><span class=n >_y</span><span class=o >.</span><span class=n >mean</span><span class=p >(</span><span class=mi >0</span><span class=p >))</span>

        <span class=k >if</span> <span class=ow >not</span> <span class=bp >self</span><span class=o >.</span><span class=n >_has_effect</span><span class=p >:</span>
            <span class=k >return</span> <span class=n >_y</span><span class=p >,</span> <span class=n >_x</span><span class=p >,</span> <span class=n >ybar</span>

        <span class=n >y_gm</span> <span class=o >=</span> <span class=n >ybar</span>
        <span class=n >x_gm</span> <span class=o >=</span> <span class=n >_x</span><span class=o >.</span><span class=n >mean</span><span class=p >(</span><span class=mi >0</span><span class=p >)</span>

        <span class=n >y</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span>
        <span class=n >x</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >exog</span>

        <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >other_effects</span><span class=p >:</span>
            <span class=k >assert</span> <span class=bp >self</span><span class=o >.</span><span class=n >_other_effect_cats</span> <span class=ow >is</span> <span class=ow >not</span> <span class=kc >None</span>
            <span class=n >groups</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_other_effect_cats</span>
            <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >entity_effects</span> <span class=ow >or</span> <span class=bp >self</span><span class=o >.</span><span class=n >time_effects</span><span class=p >:</span>
                <span class=n >groups</span> <span class=o >=</span> <span class=n >groups</span><span class=o >.</span><span class=n >copy</span><span class=p >()</span>
                <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >entity_effects</span><span class=p >:</span>
                    <span class=n >effect</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >entity_ids</span>
                <span class=k >else</span><span class=p >:</span>
                    <span class=n >effect</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >time_ids</span>
                <span class=n >col</span> <span class=o >=</span> <span class=n >ensure_unique_column</span><span class=p >(</span><span class=s2 >"additional.effect"</span><span class=p >,</span> <span class=n >groups</span><span class=o >.</span><span class=n >dataframe</span><span class=p >)</span>
                <span class=n >groups</span><span class=o >.</span><span class=n >dataframe</span><span class=p >[</span><span class=n >col</span><span class=p >]</span> <span class=o >=</span> <span class=n >effect</span>
            <span class=n >y</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span><span class=n >PanelData</span><span class=p >,</span> <span class=n >y</span><span class=o >.</span><span class=n >general_demean</span><span class=p >(</span><span class=n >groups</span><span class=p >))</span>
            <span class=n >x</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span><span class=n >PanelData</span><span class=p >,</span> <span class=n >x</span><span class=o >.</span><span class=n >general_demean</span><span class=p >(</span><span class=n >groups</span><span class=p >))</span>
        <span class=k >elif</span> <span class=bp >self</span><span class=o >.</span><span class=n >entity_effects</span> <span class=ow >and</span> <span class=bp >self</span><span class=o >.</span><span class=n >time_effects</span><span class=p >:</span>
            <span class=n >y</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span><span class=n >PanelData</span><span class=p >,</span> <span class=n >y</span><span class=o >.</span><span class=n >demean</span><span class=p >(</span><span class=s2 >"both"</span><span class=p >,</span> <span class=n >low_memory</span><span class=o >=</span><span class=n >low_memory</span><span class=p >))</span>
            <span class=n >x</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span><span class=n >PanelData</span><span class=p >,</span> <span class=n >x</span><span class=o >.</span><span class=n >demean</span><span class=p >(</span><span class=s2 >"both"</span><span class=p >,</span> <span class=n >low_memory</span><span class=o >=</span><span class=n >low_memory</span><span class=p >))</span>
        <span class=k >elif</span> <span class=bp >self</span><span class=o >.</span><span class=n >entity_effects</span><span class=p >:</span>
            <span class=n >y</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span><span class=n >PanelData</span><span class=p >,</span> <span class=n >y</span><span class=o >.</span><span class=n >demean</span><span class=p >(</span><span class=s2 >"entity"</span><span class=p >))</span>
            <span class=n >x</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span><span class=n >PanelData</span><span class=p >,</span> <span class=n >x</span><span class=o >.</span><span class=n >demean</span><span class=p >(</span><span class=s2 >"entity"</span><span class=p >))</span>
        <span class=k >else</span><span class=p >:</span>  <span class=c1 ># self.time_effects</span>
            <span class=n >y</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span><span class=n >PanelData</span><span class=p >,</span> <span class=n >y</span><span class=o >.</span><span class=n >demean</span><span class=p >(</span><span class=s2 >"time"</span><span class=p >))</span>
            <span class=n >x</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span><span class=n >PanelData</span><span class=p >,</span> <span class=n >x</span><span class=o >.</span><span class=n >demean</span><span class=p >(</span><span class=s2 >"time"</span><span class=p >))</span>

        <span class=n >y_arr</span> <span class=o >=</span> <span class=n >y</span><span class=o >.</span><span class=n >values2d</span>
        <span class=n >x_arr</span> <span class=o >=</span> <span class=n >x</span><span class=o >.</span><span class=n >values2d</span>

        <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >has_constant</span><span class=p >:</span>
            <span class=n >y_arr</span> <span class=o >=</span> <span class=n >y_arr</span> <span class=o >+</span> <span class=n >y_gm</span>
            <span class=n >x_arr</span> <span class=o >=</span> <span class=n >x_arr</span> <span class=o >+</span> <span class=n >x_gm</span>
        <span class=k >else</span><span class=p >:</span>
            <span class=n >ybar</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >asarray</span><span class=p >(</span><span class=mf >0.0</span><span class=p >)</span>

        <span class=k >return</span> <span class=n >y_arr</span><span class=p >,</span> <span class=n >x_arr</span><span class=p >,</span> <span class=n >ybar</span>

    <span class=k >def</span> <span class=nf >_weighted_fast_path</span><span class=p >(</span>
        <span class=bp >self</span><span class=p >,</span> <span class=n >low_memory</span><span class=p >:</span> <span class=nb >bool</span>
    <span class=p >)</span> <span class=o >-&gt;</span> <span class=nb >tuple</span><span class=p >[</span><span class=n >Float64Array</span><span class=p >,</span> <span class=n >Float64Array</span><span class=p >,</span> <span class=n >Float64Array</span><span class=p >,</span> <span class=n >Float64Array</span><span class=p >,</span> <span class=n >Float64Array</span><span class=p >]:</span>
        <span class=sd >"""Dummy-variable free estimation with weights"""</span>
        <span class=n >y_arr</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >values2d</span>
        <span class=n >x_arr</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >exog</span><span class=o >.</span><span class=n >values2d</span>
        <span class=n >w</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >weights</span><span class=o >.</span><span class=n >values2d</span>
        <span class=n >root_w</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span><span class=n >Float64Array</span><span class=p >,</span> <span class=n >np</span><span class=o >.</span><span class=n >sqrt</span><span class=p >(</span><span class=n >w</span><span class=p >))</span>
        <span class=n >wybar</span> <span class=o >=</span> <span class=n >root_w</span> <span class=o >*</span> <span class=p >(</span><span class=n >w</span><span class=o >.</span><span class=n >T</span> <span class=o >@</span> <span class=n >y_arr</span> <span class=o >/</span> <span class=n >w</span><span class=o >.</span><span class=n >sum</span><span class=p >())</span>

        <span class=k >if</span> <span class=ow >not</span> <span class=bp >self</span><span class=o >.</span><span class=n >_has_effect</span><span class=p >:</span>
            <span class=n >wy_arr</span> <span class=o >=</span> <span class=n >root_w</span> <span class=o >*</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >values2d</span>
            <span class=n >wx_arr</span> <span class=o >=</span> <span class=n >root_w</span> <span class=o >*</span> <span class=bp >self</span><span class=o >.</span><span class=n >exog</span><span class=o >.</span><span class=n >values2d</span>
            <span class=n >y_effect</span><span class=p >,</span> <span class=n >x_effect</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >zeros_like</span><span class=p >(</span><span class=n >wy_arr</span><span class=p >),</span> <span class=n >np</span><span class=o >.</span><span class=n >zeros_like</span><span class=p >(</span><span class=n >wx_arr</span><span class=p >)</span>
            <span class=k >return</span> <span class=n >wy_arr</span><span class=p >,</span> <span class=n >wx_arr</span><span class=p >,</span> <span class=n >wybar</span><span class=p >,</span> <span class=n >y_effect</span><span class=p >,</span> <span class=n >x_effect</span>

        <span class=n >wy_gm</span> <span class=o >=</span> <span class=n >wybar</span>
        <span class=n >wx_gm</span> <span class=o >=</span> <span class=n >root_w</span> <span class=o >*</span> <span class=p >(</span><span class=n >w</span><span class=o >.</span><span class=n >T</span> <span class=o >@</span> <span class=n >x_arr</span> <span class=o >/</span> <span class=n >w</span><span class=o >.</span><span class=n >sum</span><span class=p >())</span>

        <span class=n >y</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span>
        <span class=n >x</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >exog</span>

        <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >other_effects</span><span class=p >:</span>
            <span class=k >assert</span> <span class=bp >self</span><span class=o >.</span><span class=n >_other_effect_cats</span> <span class=ow >is</span> <span class=ow >not</span> <span class=kc >None</span>
            <span class=n >groups</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_other_effect_cats</span>
            <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >entity_effects</span> <span class=ow >or</span> <span class=bp >self</span><span class=o >.</span><span class=n >time_effects</span><span class=p >:</span>
                <span class=n >groups</span> <span class=o >=</span> <span class=n >groups</span><span class=o >.</span><span class=n >copy</span><span class=p >()</span>
                <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >entity_effects</span><span class=p >:</span>
                    <span class=n >effect</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >entity_ids</span>
                <span class=k >else</span><span class=p >:</span>
                    <span class=n >effect</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >time_ids</span>
                <span class=n >col</span> <span class=o >=</span> <span class=n >ensure_unique_column</span><span class=p >(</span><span class=s2 >"additional.effect"</span><span class=p >,</span> <span class=n >groups</span><span class=o >.</span><span class=n >dataframe</span><span class=p >)</span>
                <span class=n >groups</span><span class=o >.</span><span class=n >dataframe</span><span class=p >[</span><span class=n >col</span><span class=p >]</span> <span class=o >=</span> <span class=n >effect</span>
            <span class=n >wy</span> <span class=o >=</span> <span class=n >y</span><span class=o >.</span><span class=n >general_demean</span><span class=p >(</span><span class=n >groups</span><span class=p >,</span> <span class=n >weights</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >weights</span><span class=p >)</span>
            <span class=n >wx</span> <span class=o >=</span> <span class=n >x</span><span class=o >.</span><span class=n >general_demean</span><span class=p >(</span><span class=n >groups</span><span class=p >,</span> <span class=n >weights</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >weights</span><span class=p >)</span>
        <span class=k >elif</span> <span class=bp >self</span><span class=o >.</span><span class=n >entity_effects</span> <span class=ow >and</span> <span class=bp >self</span><span class=o >.</span><span class=n >time_effects</span><span class=p >:</span>
            <span class=n >wy</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span>
                <span class=n >PanelData</span><span class=p >,</span> <span class=n >y</span><span class=o >.</span><span class=n >demean</span><span class=p >(</span><span class=s2 >"both"</span><span class=p >,</span> <span class=n >weights</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >weights</span><span class=p >,</span> <span class=n >low_memory</span><span class=o >=</span><span class=n >low_memory</span><span class=p >)</span>
            <span class=p >)</span>
            <span class=n >wx</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span>
                <span class=n >PanelData</span><span class=p >,</span> <span class=n >x</span><span class=o >.</span><span class=n >demean</span><span class=p >(</span><span class=s2 >"both"</span><span class=p >,</span> <span class=n >weights</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >weights</span><span class=p >,</span> <span class=n >low_memory</span><span class=o >=</span><span class=n >low_memory</span><span class=p >)</span>
            <span class=p >)</span>
        <span class=k >elif</span> <span class=bp >self</span><span class=o >.</span><span class=n >entity_effects</span><span class=p >:</span>
            <span class=n >wy</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span><span class=n >PanelData</span><span class=p >,</span> <span class=n >y</span><span class=o >.</span><span class=n >demean</span><span class=p >(</span><span class=s2 >"entity"</span><span class=p >,</span> <span class=n >weights</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >weights</span><span class=p >))</span>
            <span class=n >wx</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span><span class=n >PanelData</span><span class=p >,</span> <span class=n >x</span><span class=o >.</span><span class=n >demean</span><span class=p >(</span><span class=s2 >"entity"</span><span class=p >,</span> <span class=n >weights</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >weights</span><span class=p >))</span>
        <span class=k >else</span><span class=p >:</span>  <span class=c1 ># self.time_effects</span>
            <span class=n >wy</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span><span class=n >PanelData</span><span class=p >,</span> <span class=n >y</span><span class=o >.</span><span class=n >demean</span><span class=p >(</span><span class=s2 >"time"</span><span class=p >,</span> <span class=n >weights</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >weights</span><span class=p >))</span>
            <span class=n >wx</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span><span class=n >PanelData</span><span class=p >,</span> <span class=n >x</span><span class=o >.</span><span class=n >demean</span><span class=p >(</span><span class=s2 >"time"</span><span class=p >,</span> <span class=n >weights</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >weights</span><span class=p >))</span>

        <span class=n >wy_arr</span> <span class=o >=</span> <span class=n >wy</span><span class=o >.</span><span class=n >values2d</span>
        <span class=n >wx_arr</span> <span class=o >=</span> <span class=n >wx</span><span class=o >.</span><span class=n >values2d</span>

        <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >has_constant</span><span class=p >:</span>
            <span class=n >wy_arr</span> <span class=o >+=</span> <span class=n >wy_gm</span>
            <span class=n >wx_arr</span> <span class=o >+=</span> <span class=n >wx_gm</span>
        <span class=k >else</span><span class=p >:</span>
            <span class=n >wybar</span> <span class=o >=</span> <span class=mi >0</span>

        <span class=n >wy_effects</span> <span class=o >=</span> <span class=n >y</span><span class=o >.</span><span class=n >values2d</span> <span class=o >-</span> <span class=n >wy_arr</span> <span class=o >/</span> <span class=n >root_w</span>
        <span class=n >wx_effects</span> <span class=o >=</span> <span class=n >x</span><span class=o >.</span><span class=n >values2d</span> <span class=o >-</span> <span class=n >wx_arr</span> <span class=o >/</span> <span class=n >root_w</span>

        <span class=k >return</span> <span class=n >wy_arr</span><span class=p >,</span> <span class=n >wx_arr</span><span class=p >,</span> <span class=n >wybar</span><span class=p >,</span> <span class=n >wy_effects</span><span class=p >,</span> <span class=n >wx_effects</span>

    <span class=k >def</span> <span class=nf >_info</span><span class=p >(</span><span class=bp >self</span><span class=p >)</span> <span class=o >-&gt;</span> <span class=nb >tuple</span><span class=p >[</span><span class=n >Series</span><span class=p >,</span> <span class=n >Series</span><span class=p >,</span> <span class=n >DataFrame</span><span class=p >]:</span>
        <span class=sd >"""Information about model effects and panel structure"""</span>

        <span class=n >entity_info</span><span class=p >,</span> <span class=n >time_info</span><span class=p >,</span> <span class=n >other_info</span> <span class=o >=</span> <span class=nb >super</span><span class=p >()</span><span class=o >.</span><span class=n >_info</span><span class=p >()</span>

        <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >other_effects</span><span class=p >:</span>
            <span class=n >other_info</span> <span class=o >=</span> <span class=p >[]</span>
            <span class=k >assert</span> <span class=bp >self</span><span class=o >.</span><span class=n >_other_effect_cats</span> <span class=ow >is</span> <span class=ow >not</span> <span class=kc >None</span>
            <span class=n >oe</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_other_effect_cats</span><span class=o >.</span><span class=n >dataframe</span>
            <span class=k >for</span> <span class=n >c</span> <span class=ow >in</span> <span class=n >oe</span><span class=p >:</span>
                <span class=n >name</span> <span class=o >=</span> <span class=s2 >"Observations per group ("</span> <span class=o >+</span> <span class=nb >str</span><span class=p >(</span><span class=n >c</span><span class=p >)</span> <span class=o >+</span> <span class=s2 >")"</span>
                <span class=n >other_info</span><span class=o >.</span><span class=n >append</span><span class=p >(</span>
                    <span class=n >panel_structure_stats</span><span class=p >(</span><span class=n >oe</span><span class=p >[</span><span class=n >c</span><span class=p >]</span><span class=o >.</span><span class=n >values</span><span class=o >.</span><span class=n >astype</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >int32</span><span class=p >),</span> <span class=n >name</span><span class=p >)</span>
                <span class=p >)</span>
            <span class=n >other_info</span> <span class=o >=</span> <span class=n >DataFrame</span><span class=p >(</span><span class=n >other_info</span><span class=p >)</span>

        <span class=k >return</span> <span class=n >entity_info</span><span class=p >,</span> <span class=n >time_info</span><span class=p >,</span> <span class=n >other_info</span>

    <span class=nd >@staticmethod</span>
    <span class=k >def</span> <span class=nf >_is_effect_nested</span><span class=p >(</span><span class=n >effects</span><span class=p >:</span> <span class=n >NumericArray</span><span class=p >,</span> <span class=n >clusters</span><span class=p >:</span> <span class=n >NumericArray</span><span class=p >)</span> <span class=o >-&gt;</span> <span class=nb >bool</span><span class=p >:</span>
        <span class=sd >"""Determine whether an effect is nested by the covariance clusters"""</span>
        <span class=n >is_nested</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >zeros</span><span class=p >(</span><span class=n >effects</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >1</span><span class=p >],</span> <span class=n >dtype</span><span class=o >=</span><span class=nb >bool</span><span class=p >)</span>
        <span class=k >for</span> <span class=n >i</span><span class=p >,</span> <span class=n >e</span> <span class=ow >in</span> <span class=nb >enumerate</span><span class=p >(</span><span class=n >effects</span><span class=o >.</span><span class=n >T</span><span class=p >):</span>
            <span class=n >e</span> <span class=o >=</span> <span class=p >(</span><span class=n >e</span> <span class=o >-</span> <span class=n >e</span><span class=o >.</span><span class=n >min</span><span class=p >())</span><span class=o >.</span><span class=n >astype</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >int64</span><span class=p >)</span>
            <span class=n >e_count</span> <span class=o >=</span> <span class=nb >len</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >unique</span><span class=p >(</span><span class=n >e</span><span class=p >))</span>
            <span class=k >for</span> <span class=n >c</span> <span class=ow >in</span> <span class=n >clusters</span><span class=o >.</span><span class=n >T</span><span class=p >:</span>
                <span class=n >c</span> <span class=o >=</span> <span class=p >(</span><span class=n >c</span> <span class=o >-</span> <span class=n >c</span><span class=o >.</span><span class=n >min</span><span class=p >())</span><span class=o >.</span><span class=n >astype</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >int64</span><span class=p >)</span>
                <span class=n >cmax</span> <span class=o >=</span> <span class=n >c</span><span class=o >.</span><span class=n >max</span><span class=p >()</span>
                <span class=n >ec</span> <span class=o >=</span> <span class=n >e</span> <span class=o >*</span> <span class=p >(</span><span class=n >cmax</span> <span class=o >+</span> <span class=mi >1</span><span class=p >)</span> <span class=o >+</span> <span class=n >c</span>
                <span class=n >is_nested</span><span class=p >[</span><span class=n >i</span><span class=p >]</span> <span class=o >=</span> <span class=nb >len</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >unique</span><span class=p >(</span><span class=n >ec</span><span class=p >))</span> <span class=o >==</span> <span class=n >e_count</span>
        <span class=k >return</span> <span class=nb >bool</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >all</span><span class=p >(</span><span class=n >is_nested</span><span class=p >))</span>

    <span class=k >def</span> <span class=nf >_determine_df_adjustment</span><span class=p >(</span>
        <span class=bp >self</span><span class=p >,</span>
        <span class=n >cov_type</span><span class=p >:</span> <span class=nb >str</span><span class=p >,</span>
        <span class=o >**</span><span class=n >cov_config</span><span class=p >:</span> <span class=nb >bool</span> <span class=o >|</span> <span class=nb >float</span> <span class=o >|</span> <span class=nb >str</span> <span class=o >|</span> <span class=n >IntArray</span> <span class=o >|</span> <span class=n >DataFrame</span> <span class=o >|</span> <span class=n >PanelData</span><span class=p >,</span>
    <span class=p >)</span> <span class=o >-&gt;</span> <span class=nb >bool</span><span class=p >:</span>
        <span class=k >if</span> <span class=n >cov_type</span> <span class=o >!=</span> <span class=s2 >"clustered"</span> <span class=ow >or</span> <span class=ow >not</span> <span class=bp >self</span><span class=o >.</span><span class=n >_has_effect</span><span class=p >:</span>
            <span class=k >return</span> <span class=kc >True</span>
        <span class=n >num_effects</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >entity_effects</span> <span class=o >+</span> <span class=bp >self</span><span class=o >.</span><span class=n >time_effects</span>
        <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >other_effects</span><span class=p >:</span>
            <span class=k >assert</span> <span class=bp >self</span><span class=o >.</span><span class=n >_other_effect_cats</span> <span class=ow >is</span> <span class=ow >not</span> <span class=kc >None</span>
            <span class=n >num_effects</span> <span class=o >+=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_other_effect_cats</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >1</span><span class=p >]</span>

        <span class=n >clusters</span> <span class=o >=</span> <span class=n >cov_config</span><span class=o >.</span><span class=n >get</span><span class=p >(</span><span class=s2 >"clusters"</span><span class=p >,</span> <span class=kc >None</span><span class=p >)</span>
        <span class=k >if</span> <span class=n >clusters</span> <span class=ow >is</span> <span class=kc >None</span><span class=p >:</span>  <span class=c1 ># No clusters</span>
            <span class=k >return</span> <span class=kc >True</span>

        <span class=n >effects</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_collect_effects</span><span class=p >()</span>
        <span class=k >if</span> <span class=n >num_effects</span> <span class=o >==</span> <span class=mi >1</span><span class=p >:</span>
            <span class=k >return</span> <span class=ow >not</span> <span class=bp >self</span><span class=o >.</span><span class=n >_is_effect_nested</span><span class=p >(</span><span class=n >effects</span><span class=p >,</span> <span class=n >cast</span><span class=p >(</span><span class=n >IntArray</span><span class=p >,</span> <span class=n >clusters</span><span class=p >))</span>
        <span class=k >return</span> <span class=kc >True</span>  <span class=c1 ># Default case for 2-way -- not completely clear</span>

<div class=viewcode-block  id=PanelOLS.fit ><a class=viewcode-back  href="../../../panel/panel/linearmodels.panel.model.PanelOLS.fit.html#linearmodels.panel.model.PanelOLS.fit">[docs]</a>    <span class=k >def</span> <span class=nf >fit</span><span class=p >(</span>
        <span class=bp >self</span><span class=p >,</span>
        <span class=o >*</span><span class=p >,</span>
        <span class=n >use_lsdv</span><span class=p >:</span> <span class=nb >bool</span> <span class=o >=</span> <span class=kc >False</span><span class=p >,</span>
        <span class=n >use_lsmr</span><span class=p >:</span> <span class=nb >bool</span> <span class=o >=</span> <span class=kc >False</span><span class=p >,</span>
        <span class=n >low_memory</span><span class=p >:</span> <span class=nb >bool</span> <span class=o >|</span> <span class=kc >None</span> <span class=o >=</span> <span class=kc >None</span><span class=p >,</span>
        <span class=n >cov_type</span><span class=p >:</span> <span class=nb >str</span> <span class=o >=</span> <span class=s2 >"unadjusted"</span><span class=p >,</span>
        <span class=n >debiased</span><span class=p >:</span> <span class=nb >bool</span> <span class=o >=</span> <span class=kc >True</span><span class=p >,</span>
        <span class=n >auto_df</span><span class=p >:</span> <span class=nb >bool</span> <span class=o >=</span> <span class=kc >True</span><span class=p >,</span>
        <span class=n >count_effects</span><span class=p >:</span> <span class=nb >bool</span> <span class=o >=</span> <span class=kc >True</span><span class=p >,</span>
        <span class=o >**</span><span class=n >cov_config</span><span class=p >:</span> <span class=nb >bool</span> <span class=o >|</span> <span class=nb >float</span> <span class=o >|</span> <span class=nb >str</span> <span class=o >|</span> <span class=n >IntArray</span> <span class=o >|</span> <span class=n >DataFrame</span> <span class=o >|</span> <span class=n >PanelData</span><span class=p >,</span>
    <span class=p >)</span> <span class=o >-&gt;</span> <span class=n >PanelEffectsResults</span><span class=p >:</span>
        <span class=sd >"""</span>
<span class=sd >        Estimate model parameters</span>

<span class=sd >        Parameters</span>
<span class=sd >        ----------</span>
<span class=sd >        use_lsdv : bool</span>
<span class=sd >            Flag indicating to use the Least Squares Dummy Variable estimator</span>
<span class=sd >            to eliminate effects.  The default value uses only means and does</span>
<span class=sd >            note require constructing dummy variables for each effect.</span>
<span class=sd >        use_lsmr : bool</span>
<span class=sd >            Flag indicating to use LSDV with the Sparse Equations and Least</span>
<span class=sd >            Squares estimator to eliminate the fixed effects.</span>
<span class=sd >        low_memory : {bool, None}</span>
<span class=sd >            Flag indicating whether to use a low-memory algorithm when a model</span>
<span class=sd >            contains two-way fixed effects. If `None`, the choice is taken</span>
<span class=sd >            automatically, and the low memory algorithm is used if the</span>
<span class=sd >            required dummy variable array is both larger than then array of</span>
<span class=sd >            regressors in the model and requires more than 1 GiB .</span>
<span class=sd >        cov_type : str</span>
<span class=sd >            Name of covariance estimator. See Notes.</span>
<span class=sd >        debiased : bool</span>
<span class=sd >            Flag indicating whether to debiased the covariance estimator using</span>
<span class=sd >            a degree of freedom adjustment.</span>
<span class=sd >        auto_df : bool</span>
<span class=sd >            Flag indicating that the treatment of estimated effects in degree</span>
<span class=sd >            of freedom adjustment is automatically handled. This is useful</span>
<span class=sd >            since clustered standard errors that are clustered using the same</span>
<span class=sd >            variable as an effect do not require degree of freedom correction</span>
<span class=sd >            while other estimators such as the unadjusted covariance do.</span>
<span class=sd >        count_effects : bool</span>
<span class=sd >            Flag indicating that the covariance estimator should be adjusted</span>
<span class=sd >            to account for the estimation of effects in the model. Only used</span>
<span class=sd >            if ``auto_df=False``.</span>
<span class=sd >        **cov_config</span>
<span class=sd >            Additional covariance-specific options.  See Notes.</span>

<span class=sd >        Returns</span>
<span class=sd >        -------</span>
<span class=sd >        PanelEffectsResults</span>
<span class=sd >            Estimation results</span>

<span class=sd >        Examples</span>
<span class=sd >        --------</span>
<span class=sd >        &gt;&gt;&gt; from linearmodels import PanelOLS</span>
<span class=sd >        &gt;&gt;&gt; mod = PanelOLS(y, x, entity_effects=True)</span>
<span class=sd >        &gt;&gt;&gt; res = mod.fit(cov_type="clustered", cluster_entity=True)</span>

<span class=sd >        Notes</span>
<span class=sd >        -----</span>
<span class=sd >        Three covariance estimators are supported:</span>

<span class=sd >        * "unadjusted", "homoskedastic" - Assume residual are homoskedastic</span>
<span class=sd >        * "robust", "heteroskedastic" - Control for heteroskedasticity using</span>
<span class=sd >          White's estimator</span>
<span class=sd >        * "clustered` - One- or two-way clustering.  Configuration options are:</span>

<span class=sd >          * ``clusters`` - Input containing 1 or 2 variables.</span>
<span class=sd >            Clusters should be integer valued, although other types will</span>
<span class=sd >            be coerced to integer values by treating as categorical variables</span>
<span class=sd >          * ``cluster_entity`` - Boolean flag indicating to use entity</span>
<span class=sd >            clusters</span>
<span class=sd >          * ``cluster_time`` - Boolean indicating to use time clusters</span>

<span class=sd >        * "kernel" - Driscoll-Kraay HAC estimator. Configurations options are:</span>

<span class=sd >          * ``kernel`` - One of the supported kernels (bartlett, parzen, qs).</span>
<span class=sd >            Default is Bartlett's kernel, which is produces a covariance</span>
<span class=sd >            estimator similar to the Newey-West covariance estimator.</span>
<span class=sd >          * ``bandwidth`` - Bandwidth to use when computing the kernel.  If</span>
<span class=sd >            not provided, a naive default is used.</span>
<span class=sd >        """</span>

        <span class=n >weighted</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >any</span><span class=p >(</span><span class=bp >self</span><span class=o >.</span><span class=n >weights</span><span class=o >.</span><span class=n >values2d</span> <span class=o >!=</span> <span class=mf >1.0</span><span class=p >)</span>

        <span class=k >if</span> <span class=n >use_lsmr</span><span class=p >:</span>
            <span class=n >y</span><span class=p >,</span> <span class=n >x</span><span class=p >,</span> <span class=n >ybar</span><span class=p >,</span> <span class=n >y_effects</span><span class=p >,</span> <span class=n >x_effects</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_lsmr_path</span><span class=p >()</span>
        <span class=k >elif</span> <span class=n >use_lsdv</span><span class=p >:</span>
            <span class=n >y</span><span class=p >,</span> <span class=n >x</span><span class=p >,</span> <span class=n >ybar</span><span class=p >,</span> <span class=n >y_effects</span><span class=p >,</span> <span class=n >x_effects</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_slow_path</span><span class=p >()</span>
        <span class=k >else</span><span class=p >:</span>
            <span class=n >low_memory</span> <span class=o >=</span> <span class=p >(</span>
                <span class=bp >self</span><span class=o >.</span><span class=n >_choose_twoway_algo</span><span class=p >()</span> <span class=k >if</span> <span class=n >low_memory</span> <span class=ow >is</span> <span class=kc >None</span> <span class=k >else</span> <span class=n >low_memory</span>
            <span class=p >)</span>
            <span class=k >if</span> <span class=ow >not</span> <span class=n >weighted</span><span class=p >:</span>
                <span class=n >y</span><span class=p >,</span> <span class=n >x</span><span class=p >,</span> <span class=n >ybar</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_fast_path</span><span class=p >(</span><span class=n >low_memory</span><span class=o >=</span><span class=n >low_memory</span><span class=p >)</span>
                <span class=n >y_effects</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >array</span><span class=p >([</span><span class=mf >0.0</span><span class=p >])</span>
                <span class=n >x_effects</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >zeros</span><span class=p >(</span><span class=n >x</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >1</span><span class=p >])</span>
            <span class=k >else</span><span class=p >:</span>
                <span class=n >y</span><span class=p >,</span> <span class=n >x</span><span class=p >,</span> <span class=n >ybar</span><span class=p >,</span> <span class=n >y_effects</span><span class=p >,</span> <span class=n >x_effects</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_weighted_fast_path</span><span class=p >(</span>
                    <span class=n >low_memory</span><span class=o >=</span><span class=n >low_memory</span>
                <span class=p >)</span>

        <span class=n >neffects</span> <span class=o >=</span> <span class=mi >0</span>
        <span class=n >drop_first</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >has_constant</span>
        <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >entity_effects</span><span class=p >:</span>
            <span class=n >neffects</span> <span class=o >+=</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >nentity</span> <span class=o >-</span> <span class=n >drop_first</span>
            <span class=n >drop_first</span> <span class=o >=</span> <span class=kc >True</span>
        <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >time_effects</span><span class=p >:</span>
            <span class=n >neffects</span> <span class=o >+=</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >nobs</span> <span class=o >-</span> <span class=n >drop_first</span>
            <span class=n >drop_first</span> <span class=o >=</span> <span class=kc >True</span>
        <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >other_effects</span><span class=p >:</span>
            <span class=k >assert</span> <span class=bp >self</span><span class=o >.</span><span class=n >_other_effect_cats</span> <span class=ow >is</span> <span class=ow >not</span> <span class=kc >None</span>
            <span class=n >oe</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_other_effect_cats</span><span class=o >.</span><span class=n >dataframe</span>
            <span class=k >for</span> <span class=n >c</span> <span class=ow >in</span> <span class=n >oe</span><span class=p >:</span>
                <span class=n >neffects</span> <span class=o >+=</span> <span class=n >oe</span><span class=p >[</span><span class=n >c</span><span class=p >]</span><span class=o >.</span><span class=n >nunique</span><span class=p >()</span> <span class=o >-</span> <span class=n >drop_first</span>
                <span class=n >drop_first</span> <span class=o >=</span> <span class=kc >True</span>

        <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >entity_effects</span> <span class=ow >or</span> <span class=bp >self</span><span class=o >.</span><span class=n >time_effects</span> <span class=ow >or</span> <span class=bp >self</span><span class=o >.</span><span class=n >other_effects</span><span class=p >:</span>
            <span class=k >if</span> <span class=ow >not</span> <span class=bp >self</span><span class=o >.</span><span class=n >_drop_absorbed</span><span class=p >:</span>
                <span class=n >check_absorbed</span><span class=p >(</span><span class=n >x</span><span class=p >,</span> <span class=p >[</span><span class=nb >str</span><span class=p >(</span><span class=n >var</span><span class=p >)</span> <span class=k >for</span> <span class=n >var</span> <span class=ow >in</span> <span class=bp >self</span><span class=o >.</span><span class=n >exog</span><span class=o >.</span><span class=n >vars</span><span class=p >])</span>
            <span class=k >else</span><span class=p >:</span>
                <span class=c1 ># TODO: Need to special case the constant here when determining which to retain</span>
                <span class=c1 ># since we always want to retain the constant if present</span>
                <span class=n >retain</span> <span class=o >=</span> <span class=n >not_absorbed</span><span class=p >(</span><span class=n >x</span><span class=p >,</span> <span class=bp >self</span><span class=o >.</span><span class=n >_constant</span><span class=p >,</span> <span class=bp >self</span><span class=o >.</span><span class=n >_constant_index</span><span class=p >)</span>
                <span class=k >if</span> <span class=ow >not</span> <span class=n >retain</span><span class=p >:</span>
                    <span class=k >raise</span> <span class=ne >ValueError</span><span class=p >(</span>
                        <span class=s2 >"All columns in exog have been fully absorbed by the included"</span>
                        <span class=s2 >" effects. This model cannot be estimated."</span>
                    <span class=p >)</span>
                <span class=k >if</span> <span class=nb >len</span><span class=p >(</span><span class=n >retain</span><span class=p >)</span> <span class=o >!=</span> <span class=n >x</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >1</span><span class=p >]:</span>
                    <span class=n >drop</span> <span class=o >=</span> <span class=nb >set</span><span class=p >(</span><span class=nb >range</span><span class=p >(</span><span class=n >x</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >1</span><span class=p >]))</span><span class=o >.</span><span class=n >difference</span><span class=p >(</span><span class=n >retain</span><span class=p >)</span>
                    <span class=n >dropped</span> <span class=o >=</span> <span class=s2 >", "</span><span class=o >.</span><span class=n >join</span><span class=p >([</span><span class=nb >str</span><span class=p >(</span><span class=bp >self</span><span class=o >.</span><span class=n >exog</span><span class=o >.</span><span class=n >vars</span><span class=p >[</span><span class=n >i</span><span class=p >])</span> <span class=k >for</span> <span class=n >i</span> <span class=ow >in</span> <span class=n >drop</span><span class=p >])</span>
                    <span class=kn >import</span> <span class=nn >warnings</span>

                    <span class=n >warnings</span><span class=o >.</span><span class=n >warn</span><span class=p >(</span>
                        <span class=n >absorbing_warn_msg</span><span class=o >.</span><span class=n >format</span><span class=p >(</span><span class=n >absorbed_variables</span><span class=o >=</span><span class=n >dropped</span><span class=p >),</span>
                        <span class=n >AbsorbingEffectWarning</span><span class=p >,</span>
                        <span class=n >stacklevel</span><span class=o >=</span><span class=mi >2</span><span class=p >,</span>
                    <span class=p >)</span>
                    <span class=n >x</span> <span class=o >=</span> <span class=n >x</span><span class=p >[:,</span> <span class=n >retain</span><span class=p >]</span>
                    <span class=c1 ># Update constant index loc</span>
                    <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >_constant</span><span class=p >:</span>
                        <span class=k >assert</span> <span class=nb >isinstance</span><span class=p >(</span><span class=bp >self</span><span class=o >.</span><span class=n >_constant_index</span><span class=p >,</span> <span class=nb >int</span><span class=p >)</span>
                        <span class=bp >self</span><span class=o >.</span><span class=n >_constant_index</span> <span class=o >=</span> <span class=nb >int</span><span class=p >(</span>
                            <span class=n >np</span><span class=o >.</span><span class=n >argwhere</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >array</span><span class=p >(</span><span class=n >retain</span><span class=p >)</span> <span class=o >==</span> <span class=bp >self</span><span class=o >.</span><span class=n >_constant_index</span><span class=p >)</span>
                        <span class=p >)</span>

                    <span class=c1 ># Adjust exog</span>
                    <span class=bp >self</span><span class=o >.</span><span class=n >exog</span> <span class=o >=</span> <span class=n >PanelData</span><span class=p >(</span><span class=bp >self</span><span class=o >.</span><span class=n >exog</span><span class=o >.</span><span class=n >dataframe</span><span class=o >.</span><span class=n >iloc</span><span class=p >[:,</span> <span class=n >retain</span><span class=p >])</span>
                    <span class=n >x_effects</span> <span class=o >=</span> <span class=n >x_effects</span><span class=p >[</span><span class=n >retain</span><span class=p >]</span>

        <span class=n >params</span> <span class=o >=</span> <span class=n >_lstsq</span><span class=p >(</span><span class=n >x</span><span class=p >,</span> <span class=n >y</span><span class=p >,</span> <span class=n >rcond</span><span class=o >=</span><span class=kc >None</span><span class=p >)[</span><span class=mi >0</span><span class=p >]</span>
        <span class=n >nobs</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >dataframe</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >]</span>
        <span class=n >df_model</span> <span class=o >=</span> <span class=n >x</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >1</span><span class=p >]</span> <span class=o >+</span> <span class=n >neffects</span>
        <span class=n >df_resid</span> <span class=o >=</span> <span class=n >nobs</span> <span class=o >-</span> <span class=n >df_model</span>
        <span class=c1 ># Check clusters if singletons were removed</span>
        <span class=n >cov_config</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_setup_clusters</span><span class=p >(</span><span class=n >cov_config</span><span class=p >)</span>
        <span class=k >if</span> <span class=n >auto_df</span><span class=p >:</span>
            <span class=n >count_effects</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_determine_df_adjustment</span><span class=p >(</span><span class=n >cov_type</span><span class=p >,</span> <span class=o >**</span><span class=n >cov_config</span><span class=p >)</span>
        <span class=n >extra_df</span> <span class=o >=</span> <span class=n >neffects</span> <span class=k >if</span> <span class=n >count_effects</span> <span class=k >else</span> <span class=mi >0</span>
        <span class=n >cov</span> <span class=o >=</span> <span class=n >setup_covariance_estimator</span><span class=p >(</span>
            <span class=bp >self</span><span class=o >.</span><span class=n >_cov_estimators</span><span class=p >,</span>
            <span class=n >cov_type</span><span class=p >,</span>
            <span class=n >y</span><span class=p >,</span>
            <span class=n >x</span><span class=p >,</span>
            <span class=n >params</span><span class=p >,</span>
            <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >entity_ids</span><span class=p >,</span>
            <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >time_ids</span><span class=p >,</span>
            <span class=n >debiased</span><span class=o >=</span><span class=n >debiased</span><span class=p >,</span>
            <span class=n >extra_df</span><span class=o >=</span><span class=n >extra_df</span><span class=p >,</span>
            <span class=o >**</span><span class=n >cov_config</span><span class=p >,</span>
        <span class=p >)</span>

        <span class=n >weps</span> <span class=o >=</span> <span class=n >y</span> <span class=o >-</span> <span class=n >x</span> <span class=o >@</span> <span class=n >params</span>
        <span class=n >eps</span> <span class=o >=</span> <span class=n >weps</span>
        <span class=n >_y</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >values2d</span>
        <span class=n >_x</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >exog</span><span class=o >.</span><span class=n >values2d</span>
        <span class=k >if</span> <span class=n >weighted</span><span class=p >:</span>
            <span class=n >eps</span> <span class=o >=</span> <span class=p >(</span><span class=n >_y</span> <span class=o >-</span> <span class=n >y_effects</span><span class=p >)</span> <span class=o >-</span> <span class=p >(</span><span class=n >_x</span> <span class=o >-</span> <span class=n >x_effects</span><span class=p >)</span> <span class=o >@</span> <span class=n >params</span>
            <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >has_constant</span><span class=p >:</span>
                <span class=c1 ># Correction since y_effects and x_effects @ params add mean</span>
                <span class=n >w</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >weights</span><span class=o >.</span><span class=n >values2d</span>
                <span class=n >eps</span> <span class=o >-=</span> <span class=p >(</span><span class=n >w</span> <span class=o >*</span> <span class=n >eps</span><span class=p >)</span><span class=o >.</span><span class=n >sum</span><span class=p >()</span> <span class=o >/</span> <span class=n >w</span><span class=o >.</span><span class=n >sum</span><span class=p >()</span>
        <span class=n >index</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >index</span>
        <span class=n >fitted</span> <span class=o >=</span> <span class=n >DataFrame</span><span class=p >(</span><span class=n >_x</span> <span class=o >@</span> <span class=n >params</span><span class=p >,</span> <span class=n >index</span><span class=p >,</span> <span class=p >[</span><span class=s2 >"fitted_values"</span><span class=p >])</span>
        <span class=n >idiosyncratic</span> <span class=o >=</span> <span class=n >DataFrame</span><span class=p >(</span><span class=n >eps</span><span class=p >,</span> <span class=n >index</span><span class=p >,</span> <span class=p >[</span><span class=s2 >"idiosyncratic"</span><span class=p >])</span>
        <span class=n >eps_effects</span> <span class=o >=</span> <span class=n >_y</span> <span class=o >-</span> <span class=n >fitted</span><span class=o >.</span><span class=n >values</span>

        <span class=n >sigma2_tot</span> <span class=o >=</span> <span class=nb >float</span><span class=p >(</span><span class=n >eps_effects</span><span class=o >.</span><span class=n >T</span> <span class=o >@</span> <span class=n >eps_effects</span> <span class=o >/</span> <span class=n >nobs</span><span class=p >)</span>
        <span class=n >sigma2_eps</span> <span class=o >=</span> <span class=nb >float</span><span class=p >(</span><span class=n >eps</span><span class=o >.</span><span class=n >T</span> <span class=o >@</span> <span class=n >eps</span> <span class=o >/</span> <span class=n >nobs</span><span class=p >)</span>
        <span class=n >sigma2_effects</span> <span class=o >=</span> <span class=n >sigma2_tot</span> <span class=o >-</span> <span class=n >sigma2_eps</span>
        <span class=n >rho</span> <span class=o >=</span> <span class=n >sigma2_effects</span> <span class=o >/</span> <span class=n >sigma2_tot</span> <span class=k >if</span> <span class=n >sigma2_tot</span> <span class=o >&gt;</span> <span class=mf >0.0</span> <span class=k >else</span> <span class=mf >0.0</span>

        <span class=n >resid_ss</span> <span class=o >=</span> <span class=nb >float</span><span class=p >(</span><span class=n >weps</span><span class=o >.</span><span class=n >T</span> <span class=o >@</span> <span class=n >weps</span><span class=p >)</span>
        <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >has_constant</span><span class=p >:</span>
            <span class=n >mu</span> <span class=o >=</span> <span class=n >ybar</span>
        <span class=k >else</span><span class=p >:</span>
            <span class=n >mu</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >array</span><span class=p >([</span><span class=mf >0.0</span><span class=p >])</span>
        <span class=n >total_ss</span> <span class=o >=</span> <span class=nb >float</span><span class=p >((</span><span class=n >y</span> <span class=o >-</span> <span class=n >mu</span><span class=p >)</span><span class=o >.</span><span class=n >T</span> <span class=o >@</span> <span class=p >(</span><span class=n >y</span> <span class=o >-</span> <span class=n >mu</span><span class=p >))</span>
        <span class=n >r2</span> <span class=o >=</span> <span class=mi >1</span> <span class=o >-</span> <span class=n >resid_ss</span> <span class=o >/</span> <span class=n >total_ss</span> <span class=k >if</span> <span class=n >total_ss</span> <span class=o >&gt;</span> <span class=mf >0.0</span> <span class=k >else</span> <span class=mf >0.0</span>

        <span class=n >root_w</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span><span class=n >Float64Array</span><span class=p >,</span> <span class=n >np</span><span class=o >.</span><span class=n >sqrt</span><span class=p >(</span><span class=bp >self</span><span class=o >.</span><span class=n >weights</span><span class=o >.</span><span class=n >values2d</span><span class=p >))</span>
        <span class=n >y_ex</span> <span class=o >=</span> <span class=n >root_w</span> <span class=o >*</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >values2d</span>
        <span class=n >mu_ex</span> <span class=o >=</span> <span class=mi >0</span>
        <span class=k >if</span> <span class=p >(</span>
            <span class=bp >self</span><span class=o >.</span><span class=n >has_constant</span>
            <span class=ow >or</span> <span class=bp >self</span><span class=o >.</span><span class=n >entity_effects</span>
            <span class=ow >or</span> <span class=bp >self</span><span class=o >.</span><span class=n >time_effects</span>
            <span class=ow >or</span> <span class=bp >self</span><span class=o >.</span><span class=n >other_effects</span>
        <span class=p >):</span>
            <span class=n >mu_ex</span> <span class=o >=</span> <span class=n >root_w</span> <span class=o >*</span> <span class=p >((</span><span class=n >root_w</span><span class=o >.</span><span class=n >T</span> <span class=o >@</span> <span class=n >y_ex</span><span class=p >)</span> <span class=o >/</span> <span class=p >(</span><span class=n >root_w</span><span class=o >.</span><span class=n >T</span> <span class=o >@</span> <span class=n >root_w</span><span class=p >))</span>
        <span class=n >total_ss_ex_effect</span> <span class=o >=</span> <span class=nb >float</span><span class=p >((</span><span class=n >y_ex</span> <span class=o >-</span> <span class=n >mu_ex</span><span class=p >)</span><span class=o >.</span><span class=n >T</span> <span class=o >@</span> <span class=p >(</span><span class=n >y_ex</span> <span class=o >-</span> <span class=n >mu_ex</span><span class=p >))</span>
        <span class=n >r2_ex_effects</span> <span class=o >=</span> <span class=p >(</span>
            <span class=mi >1</span> <span class=o >-</span> <span class=n >resid_ss</span> <span class=o >/</span> <span class=n >total_ss_ex_effect</span> <span class=k >if</span> <span class=n >total_ss_ex_effect</span> <span class=o >&gt;</span> <span class=mf >0.0</span> <span class=k >else</span> <span class=mf >0.0</span>
        <span class=p >)</span>

        <span class=n >res</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_postestimation</span><span class=p >(</span><span class=n >params</span><span class=p >,</span> <span class=n >cov</span><span class=p >,</span> <span class=n >debiased</span><span class=p >,</span> <span class=n >df_resid</span><span class=p >,</span> <span class=n >weps</span><span class=p >,</span> <span class=n >y</span><span class=p >,</span> <span class=n >x</span><span class=p >,</span> <span class=n >root_w</span><span class=p >)</span>
        <span class=c1 >######################################</span>
        <span class=c1 ># Pooled f-stat</span>
        <span class=c1 >######################################</span>
        <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >entity_effects</span> <span class=ow >or</span> <span class=bp >self</span><span class=o >.</span><span class=n >time_effects</span> <span class=ow >or</span> <span class=bp >self</span><span class=o >.</span><span class=n >other_effects</span><span class=p >:</span>
            <span class=n >wy</span><span class=p >,</span> <span class=n >wx</span> <span class=o >=</span> <span class=n >root_w</span> <span class=o >*</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >values2d</span><span class=p >,</span> <span class=n >root_w</span> <span class=o >*</span> <span class=bp >self</span><span class=o >.</span><span class=n >exog</span><span class=o >.</span><span class=n >values2d</span>
            <span class=n >df_num</span><span class=p >,</span> <span class=n >df_denom</span> <span class=o >=</span> <span class=p >(</span><span class=n >df_model</span> <span class=o >-</span> <span class=n >wx</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >1</span><span class=p >]),</span> <span class=n >df_resid</span>
            <span class=k >if</span> <span class=ow >not</span> <span class=bp >self</span><span class=o >.</span><span class=n >has_constant</span><span class=p >:</span>
                <span class=c1 ># Correction for when models does not have explicit constant</span>
                <span class=n >wy</span> <span class=o >-=</span> <span class=n >root_w</span> <span class=o >*</span> <span class=n >_lstsq</span><span class=p >(</span><span class=n >root_w</span><span class=p >,</span> <span class=n >wy</span><span class=p >,</span> <span class=n >rcond</span><span class=o >=</span><span class=kc >None</span><span class=p >)[</span><span class=mi >0</span><span class=p >]</span>
                <span class=n >wx</span> <span class=o >-=</span> <span class=n >root_w</span> <span class=o >*</span> <span class=n >_lstsq</span><span class=p >(</span><span class=n >root_w</span><span class=p >,</span> <span class=n >wx</span><span class=p >,</span> <span class=n >rcond</span><span class=o >=</span><span class=kc >None</span><span class=p >)[</span><span class=mi >0</span><span class=p >]</span>
                <span class=n >df_num</span> <span class=o >-=</span> <span class=mi >1</span>
            <span class=n >weps_pooled</span> <span class=o >=</span> <span class=n >wy</span> <span class=o >-</span> <span class=n >wx</span> <span class=o >@</span> <span class=n >_lstsq</span><span class=p >(</span><span class=n >wx</span><span class=p >,</span> <span class=n >wy</span><span class=p >,</span> <span class=n >rcond</span><span class=o >=</span><span class=kc >None</span><span class=p >)[</span><span class=mi >0</span><span class=p >]</span>
            <span class=n >resid_ss_pooled</span> <span class=o >=</span> <span class=nb >float</span><span class=p >(</span><span class=n >weps_pooled</span><span class=o >.</span><span class=n >T</span> <span class=o >@</span> <span class=n >weps_pooled</span><span class=p >)</span>
            <span class=n >num</span> <span class=o >=</span> <span class=p >(</span><span class=n >resid_ss_pooled</span> <span class=o >-</span> <span class=n >resid_ss</span><span class=p >)</span> <span class=o >/</span> <span class=n >df_num</span>

            <span class=n >denom</span> <span class=o >=</span> <span class=n >resid_ss</span> <span class=o >/</span> <span class=n >df_denom</span>
            <span class=n >stat</span> <span class=o >=</span> <span class=n >num</span> <span class=o >/</span> <span class=n >denom</span>
            <span class=n >f_pooled</span> <span class=o >=</span> <span class=n >WaldTestStatistic</span><span class=p >(</span>
                <span class=n >stat</span><span class=p >,</span>
                <span class=s2 >"Effects are zero"</span><span class=p >,</span>
                <span class=n >df_num</span><span class=p >,</span>
                <span class=n >df_denom</span><span class=o >=</span><span class=n >df_denom</span><span class=p >,</span>
                <span class=n >name</span><span class=o >=</span><span class=s2 >"Pooled F-statistic"</span><span class=p >,</span>
            <span class=p >)</span>
            <span class=n >res</span><span class=o >.</span><span class=n >update</span><span class=p >(</span><span class=n >f_pooled</span><span class=o >=</span><span class=n >f_pooled</span><span class=p >)</span>
            <span class=n >effects</span> <span class=o >=</span> <span class=n >DataFrame</span><span class=p >(</span>
                <span class=n >eps_effects</span> <span class=o >-</span> <span class=n >eps</span><span class=p >,</span>
                <span class=n >columns</span><span class=o >=</span><span class=p >[</span><span class=s2 >"estimated_effects"</span><span class=p >],</span>
                <span class=n >index</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >index</span><span class=p >,</span>
            <span class=p >)</span>
        <span class=k >else</span><span class=p >:</span>
            <span class=n >effects</span> <span class=o >=</span> <span class=n >DataFrame</span><span class=p >(</span>
                <span class=n >np</span><span class=o >.</span><span class=n >zeros_like</span><span class=p >(</span><span class=n >eps</span><span class=p >),</span>
                <span class=n >columns</span><span class=o >=</span><span class=p >[</span><span class=s2 >"estimated_effects"</span><span class=p >],</span>
                <span class=n >index</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >index</span><span class=p >,</span>
            <span class=p >)</span>

        <span class=n >res</span><span class=o >.</span><span class=n >update</span><span class=p >(</span>
            <span class=nb >dict</span><span class=p >(</span>
                <span class=n >df_resid</span><span class=o >=</span><span class=n >df_resid</span><span class=p >,</span>
                <span class=n >df_model</span><span class=o >=</span><span class=n >df_model</span><span class=p >,</span>
                <span class=n >nobs</span><span class=o >=</span><span class=n >y</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >],</span>
                <span class=n >residual_ss</span><span class=o >=</span><span class=n >resid_ss</span><span class=p >,</span>
                <span class=n >total_ss</span><span class=o >=</span><span class=n >total_ss</span><span class=p >,</span>
                <span class=n >wresids</span><span class=o >=</span><span class=n >weps</span><span class=p >,</span>
                <span class=n >resids</span><span class=o >=</span><span class=n >eps</span><span class=p >,</span>
                <span class=n >r2</span><span class=o >=</span><span class=n >r2</span><span class=p >,</span>
                <span class=n >entity_effects</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >entity_effects</span><span class=p >,</span>
                <span class=n >time_effects</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >time_effects</span><span class=p >,</span>
                <span class=n >other_effects</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >other_effects</span><span class=p >,</span>
                <span class=n >sigma2_eps</span><span class=o >=</span><span class=n >sigma2_eps</span><span class=p >,</span>
                <span class=n >sigma2_effects</span><span class=o >=</span><span class=n >sigma2_effects</span><span class=p >,</span>
                <span class=n >rho</span><span class=o >=</span><span class=n >rho</span><span class=p >,</span>
                <span class=n >r2_ex_effects</span><span class=o >=</span><span class=n >r2_ex_effects</span><span class=p >,</span>
                <span class=n >effects</span><span class=o >=</span><span class=n >effects</span><span class=p >,</span>
                <span class=n >fitted</span><span class=o >=</span><span class=n >fitted</span><span class=p >,</span>
                <span class=n >idiosyncratic</span><span class=o >=</span><span class=n >idiosyncratic</span><span class=p >,</span>
            <span class=p >)</span>
        <span class=p >)</span>

        <span class=k >return</span> <span class=n >PanelEffectsResults</span><span class=p >(</span><span class=n >res</span><span class=p >)</span></div></div>


<div class=viewcode-block  id=BetweenOLS ><a class=viewcode-back  href="../../../panel/panel/linearmodels.panel.model.BetweenOLS.html#linearmodels.panel.model.BetweenOLS">[docs]</a><span class=k >class</span> <span class=nc >BetweenOLS</span><span class=p >(</span><span class=n >_PanelModelBase</span><span class=p >):</span>
    <span class=sa >r</span><span class=sd >"""</span>
<span class=sd >    Between estimator for panel data</span>

<span class=sd >    Parameters</span>
<span class=sd >    ----------</span>
<span class=sd >    dependent : array_like</span>
<span class=sd >        Dependent (left-hand-side) variable (time by entity)</span>
<span class=sd >    exog : array_like</span>
<span class=sd >        Exogenous or right-hand-side variables (variable by time by entity).</span>
<span class=sd >    weights : array_like</span>
<span class=sd >        Weights to use in estimation.  Assumes residual variance is</span>
<span class=sd >        proportional to inverse of weight to that the residual time</span>
<span class=sd >        the weight should be homoskedastic.</span>

<span class=sd >    Notes</span>
<span class=sd >    -----</span>
<span class=sd >    The model is given by</span>

<span class=sd >    .. math::</span>

<span class=sd >        \bar{y}_{i}=  \beta^{\prime}\bar{x}_{i}+\bar{\epsilon}_{i}</span>

<span class=sd >    where :math:`\bar{z}` is the time-average.</span>
<span class=sd >    """</span>

    <span class=k >def</span> <span class=fm >__init__</span><span class=p >(</span>
        <span class=bp >self</span><span class=p >,</span>
        <span class=n >dependent</span><span class=p >:</span> <span class=n >PanelDataLike</span><span class=p >,</span>
        <span class=n >exog</span><span class=p >:</span> <span class=n >PanelDataLike</span><span class=p >,</span>
        <span class=o >*</span><span class=p >,</span>
        <span class=n >weights</span><span class=p >:</span> <span class=n >PanelDataLike</span> <span class=o >|</span> <span class=kc >None</span> <span class=o >=</span> <span class=kc >None</span><span class=p >,</span>
        <span class=n >check_rank</span><span class=p >:</span> <span class=nb >bool</span> <span class=o >=</span> <span class=kc >True</span><span class=p >,</span>
    <span class=p >)</span> <span class=o >-&gt;</span> <span class=kc >None</span><span class=p >:</span>
        <span class=nb >super</span><span class=p >()</span><span class=o >.</span><span class=fm >__init__</span><span class=p >(</span><span class=n >dependent</span><span class=p >,</span> <span class=n >exog</span><span class=p >,</span> <span class=n >weights</span><span class=o >=</span><span class=n >weights</span><span class=p >,</span> <span class=n >check_rank</span><span class=o >=</span><span class=n >check_rank</span><span class=p >)</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >_cov_estimators</span> <span class=o >=</span> <span class=n >CovarianceManager</span><span class=p >(</span>
            <span class=bp >self</span><span class=o >.</span><span class=vm >__class__</span><span class=o >.</span><span class=vm >__name__</span><span class=p >,</span>
            <span class=n >HomoskedasticCovariance</span><span class=p >,</span>
            <span class=n >HeteroskedasticCovariance</span><span class=p >,</span>
            <span class=n >ClusteredCovariance</span><span class=p >,</span>
        <span class=p >)</span>

    <span class=k >def</span> <span class=nf >_setup_clusters</span><span class=p >(</span>
        <span class=bp >self</span><span class=p >,</span> <span class=n >cov_config</span><span class=p >:</span> <span class=nb >dict</span><span class=p >[</span><span class=nb >str</span><span class=p >,</span> <span class=nb >bool</span> <span class=o >|</span> <span class=nb >float</span> <span class=o >|</span> <span class=nb >str</span> <span class=o >|</span> <span class=n >PanelDataLike</span><span class=p >]</span>
    <span class=p >)</span> <span class=o >-&gt;</span> <span class=nb >dict</span><span class=p >[</span><span class=nb >str</span><span class=p >,</span> <span class=nb >bool</span> <span class=o >|</span> <span class=nb >float</span> <span class=o >|</span> <span class=nb >str</span> <span class=o >|</span> <span class=n >IntArray</span> <span class=o >|</span> <span class=n >DataFrame</span> <span class=o >|</span> <span class=n >PanelData</span><span class=p >]:</span>
        <span class=sd >"""Return covariance estimator reformat clusters"""</span>
        <span class=n >cov_config_upd</span> <span class=o >=</span> <span class=n >cov_config</span><span class=o >.</span><span class=n >copy</span><span class=p >()</span>
        <span class=k >if</span> <span class=s2 >"clusters"</span> <span class=ow >not</span> <span class=ow >in</span> <span class=n >cov_config</span><span class=p >:</span>
            <span class=k >return</span> <span class=n >cov_config_upd</span>

        <span class=n >clusters</span> <span class=o >=</span> <span class=n >cov_config</span><span class=o >.</span><span class=n >get</span><span class=p >(</span><span class=s2 >"clusters"</span><span class=p >,</span> <span class=kc >None</span><span class=p >)</span>
        <span class=k >if</span> <span class=n >clusters</span> <span class=ow >is</span> <span class=ow >not</span> <span class=kc >None</span><span class=p >:</span>
            <span class=n >clusters_panel</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >reformat_clusters</span><span class=p >(</span><span class=n >clusters</span><span class=p >)</span>
            <span class=n >cluster_max</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >nanmax</span><span class=p >(</span><span class=n >clusters_panel</span><span class=o >.</span><span class=n >values3d</span><span class=p >,</span> <span class=n >axis</span><span class=o >=</span><span class=mi >1</span><span class=p >)</span>
            <span class=n >delta</span> <span class=o >=</span> <span class=n >cluster_max</span> <span class=o >-</span> <span class=n >np</span><span class=o >.</span><span class=n >nanmin</span><span class=p >(</span><span class=n >clusters_panel</span><span class=o >.</span><span class=n >values3d</span><span class=p >,</span> <span class=n >axis</span><span class=o >=</span><span class=mi >1</span><span class=p >)</span>
            <span class=k >if</span> <span class=n >np</span><span class=o >.</span><span class=n >any</span><span class=p >(</span><span class=n >delta</span> <span class=o >!=</span> <span class=mi >0</span><span class=p >):</span>
                <span class=k >raise</span> <span class=ne >ValueError</span><span class=p >(</span><span class=s2 >"clusters must not vary within an entity"</span><span class=p >)</span>

            <span class=n >index</span> <span class=o >=</span> <span class=n >clusters_panel</span><span class=o >.</span><span class=n >panel</span><span class=o >.</span><span class=n >minor_axis</span>
            <span class=n >reindex</span> <span class=o >=</span> <span class=n >clusters_panel</span><span class=o >.</span><span class=n >entities</span>
            <span class=n >clusters_frame</span> <span class=o >=</span> <span class=n >DataFrame</span><span class=p >(</span>
                <span class=n >cluster_max</span><span class=o >.</span><span class=n >T</span><span class=p >,</span> <span class=n >index</span><span class=o >=</span><span class=n >index</span><span class=p >,</span> <span class=n >columns</span><span class=o >=</span><span class=n >clusters_panel</span><span class=o >.</span><span class=n >vars</span>
            <span class=p >)</span>
            <span class=n >clusters_frame</span> <span class=o >=</span> <span class=n >clusters_frame</span><span class=o >.</span><span class=n >loc</span><span class=p >[</span><span class=n >reindex</span><span class=p >]</span><span class=o >.</span><span class=n >astype</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >int64</span><span class=p >)</span>
            <span class=n >cov_config_upd</span><span class=p >[</span><span class=s2 >"clusters"</span><span class=p >]</span> <span class=o >=</span> <span class=n >clusters_frame</span>

        <span class=k >return</span> <span class=n >cov_config_upd</span>

<div class=viewcode-block  id=BetweenOLS.fit ><a class=viewcode-back  href="../../../panel/panel/linearmodels.panel.model.BetweenOLS.fit.html#linearmodels.panel.model.BetweenOLS.fit">[docs]</a>    <span class=k >def</span> <span class=nf >fit</span><span class=p >(</span>
        <span class=bp >self</span><span class=p >,</span>
        <span class=o >*</span><span class=p >,</span>
        <span class=n >reweight</span><span class=p >:</span> <span class=nb >bool</span> <span class=o >=</span> <span class=kc >False</span><span class=p >,</span>
        <span class=n >cov_type</span><span class=p >:</span> <span class=nb >str</span> <span class=o >=</span> <span class=s2 >"unadjusted"</span><span class=p >,</span>
        <span class=n >debiased</span><span class=p >:</span> <span class=nb >bool</span> <span class=o >=</span> <span class=kc >True</span><span class=p >,</span>
        <span class=o >**</span><span class=n >cov_config</span><span class=p >:</span> <span class=nb >bool</span> <span class=o >|</span> <span class=nb >float</span> <span class=o >|</span> <span class=nb >str</span> <span class=o >|</span> <span class=n >IntArray</span> <span class=o >|</span> <span class=n >DataFrame</span> <span class=o >|</span> <span class=n >PanelData</span><span class=p >,</span>
    <span class=p >)</span> <span class=o >-&gt;</span> <span class=n >PanelResults</span><span class=p >:</span>
        <span class=sd >"""</span>
<span class=sd >        Estimate model parameters</span>

<span class=sd >        Parameters</span>
<span class=sd >        ----------</span>
<span class=sd >        reweight : bool</span>
<span class=sd >            Flag indicating to reweight observations if the input data is</span>
<span class=sd >            unbalanced using a WLS estimator.  If weights are provided, these</span>
<span class=sd >            are accounted for when reweighting. Has no effect on balanced data.</span>
<span class=sd >        cov_type : str</span>
<span class=sd >            Name of covariance estimator. See Notes.</span>
<span class=sd >        debiased : bool</span>
<span class=sd >            Flag indicating whether to debiased the covariance estimator using</span>
<span class=sd >            a degree of freedom adjustment.</span>
<span class=sd >        **cov_config</span>
<span class=sd >            Additional covariance-specific options.  See Notes.</span>

<span class=sd >        Returns</span>
<span class=sd >        -------</span>
<span class=sd >        PanelResults</span>
<span class=sd >            Estimation results</span>

<span class=sd >        Examples</span>
<span class=sd >        --------</span>
<span class=sd >        &gt;&gt;&gt; from linearmodels import BetweenOLS</span>
<span class=sd >        &gt;&gt;&gt; mod = BetweenOLS(y, x)</span>
<span class=sd >        &gt;&gt;&gt; res = mod.fit(cov_type='robust')</span>

<span class=sd >        Notes</span>
<span class=sd >        -----</span>
<span class=sd >        Three covariance estimators are supported:</span>

<span class=sd >        * "unadjusted", "homoskedastic" - Assume residual are homoskedastic</span>
<span class=sd >        * "robust", "heteroskedastic" - Control for heteroskedasticity using</span>
<span class=sd >          White's estimator</span>
<span class=sd >        * "clustered` - One- or two-way clustering.  Configuration options are:</span>

<span class=sd >          * ``clusters`` - Input containing 1 or 2 variables.</span>
<span class=sd >            Clusters should be integer values, although other types will</span>
<span class=sd >            be coerced to integer values by treating as categorical variables</span>

<span class=sd >        When using a clustered covariance estimator, all cluster ids must be</span>
<span class=sd >        identical within an entity.</span>
<span class=sd >        """</span>
        <span class=n >y</span><span class=p >,</span> <span class=n >x</span><span class=p >,</span> <span class=n >w</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_prepare_between</span><span class=p >()</span>
        <span class=k >if</span> <span class=n >np</span><span class=o >.</span><span class=n >all</span><span class=p >(</span><span class=bp >self</span><span class=o >.</span><span class=n >weights</span><span class=o >.</span><span class=n >values2d</span> <span class=o >==</span> <span class=mf >1.0</span><span class=p >)</span> <span class=ow >and</span> <span class=ow >not</span> <span class=n >reweight</span><span class=p >:</span>
            <span class=n >w</span> <span class=o >=</span> <span class=n >root_w</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >ones_like</span><span class=p >(</span><span class=n >y</span><span class=p >)</span>
        <span class=k >else</span><span class=p >:</span>
            <span class=n >root_w</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span><span class=n >Float64Array</span><span class=p >,</span> <span class=n >np</span><span class=o >.</span><span class=n >sqrt</span><span class=p >(</span><span class=n >w</span><span class=p >))</span>

        <span class=n >wx</span> <span class=o >=</span> <span class=n >root_w</span> <span class=o >*</span> <span class=n >x</span>
        <span class=n >wy</span> <span class=o >=</span> <span class=n >root_w</span> <span class=o >*</span> <span class=n >y</span>
        <span class=n >params</span> <span class=o >=</span> <span class=n >_lstsq</span><span class=p >(</span><span class=n >wx</span><span class=p >,</span> <span class=n >wy</span><span class=p >,</span> <span class=n >rcond</span><span class=o >=</span><span class=kc >None</span><span class=p >)[</span><span class=mi >0</span><span class=p >]</span>

        <span class=n >df_resid</span> <span class=o >=</span> <span class=n >y</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >]</span> <span class=o >-</span> <span class=n >x</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >1</span><span class=p >]</span>
        <span class=n >df_model</span> <span class=o >=</span> <span class=p >(</span><span class=n >x</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >1</span><span class=p >],)</span>
        <span class=n >nobs</span> <span class=o >=</span> <span class=n >y</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >]</span>
        <span class=n >cov_config</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_setup_clusters</span><span class=p >(</span><span class=n >cov_config</span><span class=p >)</span>
        <span class=n >extra_df</span> <span class=o >=</span> <span class=mi >0</span>
        <span class=k >if</span> <span class=s2 >"extra_df"</span> <span class=ow >in</span> <span class=n >cov_config</span><span class=p >:</span>
            <span class=n >cov_config</span> <span class=o >=</span> <span class=n >cov_config</span><span class=o >.</span><span class=n >copy</span><span class=p >()</span>
            <span class=n >_extra_df</span> <span class=o >=</span> <span class=n >cov_config</span><span class=o >.</span><span class=n >pop</span><span class=p >(</span><span class=s2 >"extra_df"</span><span class=p >)</span>
            <span class=k >assert</span> <span class=nb >isinstance</span><span class=p >(</span><span class=n >_extra_df</span><span class=p >,</span> <span class=p >(</span><span class=nb >str</span><span class=p >,</span> <span class=nb >int</span><span class=p >))</span>
            <span class=n >extra_df</span> <span class=o >=</span> <span class=nb >int</span><span class=p >(</span><span class=n >_extra_df</span><span class=p >)</span>
        <span class=n >cov</span> <span class=o >=</span> <span class=n >setup_covariance_estimator</span><span class=p >(</span>
            <span class=bp >self</span><span class=o >.</span><span class=n >_cov_estimators</span><span class=p >,</span>
            <span class=n >cov_type</span><span class=p >,</span>
            <span class=n >wy</span><span class=p >,</span>
            <span class=n >wx</span><span class=p >,</span>
            <span class=n >params</span><span class=p >,</span>
            <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >entity_ids</span><span class=p >,</span>
            <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >time_ids</span><span class=p >,</span>
            <span class=n >debiased</span><span class=o >=</span><span class=n >debiased</span><span class=p >,</span>
            <span class=n >extra_df</span><span class=o >=</span><span class=n >extra_df</span><span class=p >,</span>
            <span class=o >**</span><span class=n >cov_config</span><span class=p >,</span>
        <span class=p >)</span>
        <span class=n >weps</span> <span class=o >=</span> <span class=n >wy</span> <span class=o >-</span> <span class=n >wx</span> <span class=o >@</span> <span class=n >params</span>
        <span class=n >index</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >index</span>
        <span class=n >fitted</span> <span class=o >=</span> <span class=n >DataFrame</span><span class=p >(</span><span class=bp >self</span><span class=o >.</span><span class=n >exog</span><span class=o >.</span><span class=n >values2d</span> <span class=o >@</span> <span class=n >params</span><span class=p >,</span> <span class=n >index</span><span class=p >,</span> <span class=p >[</span><span class=s2 >"fitted_values"</span><span class=p >])</span>
        <span class=n >eps</span> <span class=o >=</span> <span class=n >y</span> <span class=o >-</span> <span class=n >x</span> <span class=o >@</span> <span class=n >params</span>
        <span class=n >effects</span> <span class=o >=</span> <span class=n >DataFrame</span><span class=p >(</span><span class=n >eps</span><span class=p >,</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >entities</span><span class=p >,</span> <span class=p >[</span><span class=s2 >"estimated_effects"</span><span class=p >])</span>
        <span class=n >idx</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span><span class=n >MultiIndex</span><span class=p >,</span> <span class=n >fitted</span><span class=o >.</span><span class=n >index</span><span class=p >)</span>
        <span class=n >entities</span> <span class=o >=</span> <span class=n >idx</span><span class=o >.</span><span class=n >levels</span><span class=p >[</span><span class=mi >0</span><span class=p >][</span><span class=n >idx</span><span class=o >.</span><span class=n >codes</span><span class=p >[</span><span class=mi >0</span><span class=p >]]</span>
        <span class=n >effects</span> <span class=o >=</span> <span class=n >effects</span><span class=o >.</span><span class=n >loc</span><span class=p >[</span><span class=n >entities</span><span class=p >]</span>
        <span class=n >effects</span><span class=o >.</span><span class=n >index</span> <span class=o >=</span> <span class=n >idx</span>
        <span class=n >dep</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >dataframe</span>
        <span class=n >fitted</span> <span class=o >=</span> <span class=n >fitted</span><span class=o >.</span><span class=n >reindex</span><span class=p >(</span><span class=n >dep</span><span class=o >.</span><span class=n >index</span><span class=p >)</span>
        <span class=n >effects</span> <span class=o >=</span> <span class=n >effects</span><span class=o >.</span><span class=n >reindex</span><span class=p >(</span><span class=n >dep</span><span class=o >.</span><span class=n >index</span><span class=p >)</span>
        <span class=n >idiosyncratic</span> <span class=o >=</span> <span class=n >DataFrame</span><span class=p >(</span>
            <span class=n >np</span><span class=o >.</span><span class=n >asarray</span><span class=p >(</span><span class=n >dep</span><span class=p >)</span> <span class=o >-</span> <span class=n >np</span><span class=o >.</span><span class=n >asarray</span><span class=p >(</span><span class=n >fitted</span><span class=p >)</span> <span class=o >-</span> <span class=n >np</span><span class=o >.</span><span class=n >asarray</span><span class=p >(</span><span class=n >effects</span><span class=p >),</span>
            <span class=n >dep</span><span class=o >.</span><span class=n >index</span><span class=p >,</span>
            <span class=p >[</span><span class=s2 >"idiosyncratic"</span><span class=p >],</span>
        <span class=p >)</span>

        <span class=n >residual_ss</span> <span class=o >=</span> <span class=nb >float</span><span class=p >(</span><span class=n >weps</span><span class=o >.</span><span class=n >T</span> <span class=o >@</span> <span class=n >weps</span><span class=p >)</span>
        <span class=n >e</span> <span class=o >=</span> <span class=n >y</span>
        <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >_constant</span><span class=p >:</span>
            <span class=n >e</span> <span class=o >=</span> <span class=n >y</span> <span class=o >-</span> <span class=p >(</span><span class=n >w</span> <span class=o >*</span> <span class=n >y</span><span class=p >)</span><span class=o >.</span><span class=n >sum</span><span class=p >()</span> <span class=o >/</span> <span class=n >w</span><span class=o >.</span><span class=n >sum</span><span class=p >()</span>

        <span class=n >total_ss</span> <span class=o >=</span> <span class=nb >float</span><span class=p >(</span><span class=n >w</span><span class=o >.</span><span class=n >T</span> <span class=o >@</span> <span class=p >(</span><span class=n >e</span><span class=o >**</span><span class=mi >2</span><span class=p >))</span>
        <span class=n >r2</span> <span class=o >=</span> <span class=mi >1</span> <span class=o >-</span> <span class=n >residual_ss</span> <span class=o >/</span> <span class=n >total_ss</span>

        <span class=n >res</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_postestimation</span><span class=p >(</span>
            <span class=n >params</span><span class=p >,</span> <span class=n >cov</span><span class=p >,</span> <span class=n >debiased</span><span class=p >,</span> <span class=n >df_resid</span><span class=p >,</span> <span class=n >weps</span><span class=p >,</span> <span class=n >wy</span><span class=p >,</span> <span class=n >wx</span><span class=p >,</span> <span class=n >root_w</span>
        <span class=p >)</span>
        <span class=n >res</span><span class=o >.</span><span class=n >update</span><span class=p >(</span>
            <span class=nb >dict</span><span class=p >(</span>
                <span class=n >df_resid</span><span class=o >=</span><span class=n >df_resid</span><span class=p >,</span>
                <span class=n >df_model</span><span class=o >=</span><span class=n >df_model</span><span class=p >,</span>
                <span class=n >nobs</span><span class=o >=</span><span class=n >nobs</span><span class=p >,</span>
                <span class=n >residual_ss</span><span class=o >=</span><span class=n >residual_ss</span><span class=p >,</span>
                <span class=n >total_ss</span><span class=o >=</span><span class=n >total_ss</span><span class=p >,</span>
                <span class=n >r2</span><span class=o >=</span><span class=n >r2</span><span class=p >,</span>
                <span class=n >wresids</span><span class=o >=</span><span class=n >weps</span><span class=p >,</span>
                <span class=n >resids</span><span class=o >=</span><span class=n >eps</span><span class=p >,</span>
                <span class=n >index</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >entities</span><span class=p >,</span>
                <span class=n >fitted</span><span class=o >=</span><span class=n >fitted</span><span class=p >,</span>
                <span class=n >effects</span><span class=o >=</span><span class=n >effects</span><span class=p >,</span>
                <span class=n >idiosyncratic</span><span class=o >=</span><span class=n >idiosyncratic</span><span class=p >,</span>
            <span class=p >)</span>
        <span class=p >)</span>

        <span class=k >return</span> <span class=n >PanelResults</span><span class=p >(</span><span class=n >res</span><span class=p >)</span></div>

<div class=viewcode-block  id=BetweenOLS.from_formula ><a class=viewcode-back  href="../../../panel/panel/linearmodels.panel.model.BetweenOLS.from_formula.html#linearmodels.panel.model.BetweenOLS.from_formula">[docs]</a>    <span class=nd >@classmethod</span>
    <span class=k >def</span> <span class=nf >from_formula</span><span class=p >(</span>
        <span class=bp >cls</span><span class=p >,</span>
        <span class=n >formula</span><span class=p >:</span> <span class=nb >str</span><span class=p >,</span>
        <span class=n >data</span><span class=p >:</span> <span class=n >PanelDataLike</span><span class=p >,</span>
        <span class=o >*</span><span class=p >,</span>
        <span class=n >weights</span><span class=p >:</span> <span class=n >PanelDataLike</span> <span class=o >|</span> <span class=kc >None</span> <span class=o >=</span> <span class=kc >None</span><span class=p >,</span>
        <span class=n >check_rank</span><span class=p >:</span> <span class=nb >bool</span> <span class=o >=</span> <span class=kc >True</span><span class=p >,</span>
    <span class=p >)</span> <span class=o >-&gt;</span> <span class=n >BetweenOLS</span><span class=p >:</span>
        <span class=sd >"""</span>
<span class=sd >        Create a model from a formula</span>

<span class=sd >        Parameters</span>
<span class=sd >        ----------</span>
<span class=sd >        formula : str</span>
<span class=sd >            Formula to transform into model. Conforms to formulaic formula</span>
<span class=sd >            rules.</span>
<span class=sd >        data : array_like</span>
<span class=sd >            Data structure that can be coerced into a PanelData.  In most</span>
<span class=sd >            cases, this should be a multi-index DataFrame where the level 0</span>
<span class=sd >            index contains the entities and the level 1 contains the time.</span>
<span class=sd >        weights: array_like</span>
<span class=sd >            Weights to use in estimation.  Assumes residual variance is</span>
<span class=sd >            proportional to inverse of weight to that the residual times</span>
<span class=sd >            the weight should be homoskedastic.</span>
<span class=sd >        check_rank : bool</span>
<span class=sd >            Flag indicating whether to perform a rank check on the exogenous</span>
<span class=sd >            variables to ensure that the model is identified. Skipping this</span>
<span class=sd >            check can reduce the time required to validate a model</span>
<span class=sd >            specification. Results may be numerically unstable if this check</span>
<span class=sd >            is skipped and the matrix is not full rank.</span>

<span class=sd >        Returns</span>
<span class=sd >        -------</span>
<span class=sd >        BetweenOLS</span>
<span class=sd >            Model specified using the formula</span>

<span class=sd >        Notes</span>
<span class=sd >        -----</span>
<span class=sd >        Unlike standard  formula syntax, it is necessary to explicitly include</span>
<span class=sd >        a constant using the constant indicator (1)</span>

<span class=sd >        Examples</span>
<span class=sd >        --------</span>
<span class=sd >        &gt;&gt;&gt; from linearmodels import BetweenOLS</span>
<span class=sd >        &gt;&gt;&gt; from linearmodels.panel import generate_panel_data</span>
<span class=sd >        &gt;&gt;&gt; panel_data = generate_panel_data()</span>
<span class=sd >        &gt;&gt;&gt; mod = BetweenOLS.from_formula("y ~ 1 + x1", panel_data.data)</span>
<span class=sd >        &gt;&gt;&gt; res = mod.fit()</span>
<span class=sd >        """</span>
        <span class=n >parser</span> <span class=o >=</span> <span class=n >PanelFormulaParser</span><span class=p >(</span><span class=n >formula</span><span class=p >,</span> <span class=n >data</span><span class=p >)</span>
        <span class=n >dependent</span><span class=p >,</span> <span class=n >exog</span> <span class=o >=</span> <span class=n >parser</span><span class=o >.</span><span class=n >data</span>
        <span class=n >mod</span> <span class=o >=</span> <span class=bp >cls</span><span class=p >(</span><span class=n >dependent</span><span class=p >,</span> <span class=n >exog</span><span class=p >,</span> <span class=n >weights</span><span class=o >=</span><span class=n >weights</span><span class=p >,</span> <span class=n >check_rank</span><span class=o >=</span><span class=n >check_rank</span><span class=p >)</span>
        <span class=n >mod</span><span class=o >.</span><span class=n >formula</span> <span class=o >=</span> <span class=n >formula</span>
        <span class=k >return</span> <span class=n >mod</span></div></div>


<div class=viewcode-block  id=FirstDifferenceOLS ><a class=viewcode-back  href="../../../panel/panel/linearmodels.panel.model.FirstDifferenceOLS.html#linearmodels.panel.model.FirstDifferenceOLS">[docs]</a><span class=k >class</span> <span class=nc >FirstDifferenceOLS</span><span class=p >(</span><span class=n >_PanelModelBase</span><span class=p >):</span>
    <span class=sa >r</span><span class=sd >"""</span>
<span class=sd >    First difference model for panel data</span>

<span class=sd >    Parameters</span>
<span class=sd >    ----------</span>
<span class=sd >    dependent : array_like</span>
<span class=sd >        Dependent (left-hand-side) variable (time by entity)</span>
<span class=sd >    exog : array_like</span>
<span class=sd >        Exogenous or right-hand-side variables (variable by time by entity).</span>
<span class=sd >    weights : array_like</span>
<span class=sd >        Weights to use in estimation.  Assumes residual variance is</span>
<span class=sd >        proportional to inverse of weight to that the residual time</span>
<span class=sd >        the weight should be homoskedastic.</span>

<span class=sd >    Notes</span>
<span class=sd >    -----</span>
<span class=sd >    The model is given by</span>

<span class=sd >    .. math::</span>

<span class=sd >        \Delta y_{it}=\beta^{\prime}\Delta x_{it}+\Delta\epsilon_{it}</span>
<span class=sd >    """</span>

    <span class=k >def</span> <span class=fm >__init__</span><span class=p >(</span>
        <span class=bp >self</span><span class=p >,</span>
        <span class=n >dependent</span><span class=p >:</span> <span class=n >PanelDataLike</span><span class=p >,</span>
        <span class=n >exog</span><span class=p >:</span> <span class=n >PanelDataLike</span><span class=p >,</span>
        <span class=o >*</span><span class=p >,</span>
        <span class=n >weights</span><span class=p >:</span> <span class=n >PanelDataLike</span> <span class=o >|</span> <span class=kc >None</span> <span class=o >=</span> <span class=kc >None</span><span class=p >,</span>
        <span class=n >check_rank</span><span class=p >:</span> <span class=nb >bool</span> <span class=o >=</span> <span class=kc >True</span><span class=p >,</span>
    <span class=p >):</span>
        <span class=nb >super</span><span class=p >()</span><span class=o >.</span><span class=fm >__init__</span><span class=p >(</span><span class=n >dependent</span><span class=p >,</span> <span class=n >exog</span><span class=p >,</span> <span class=n >weights</span><span class=o >=</span><span class=n >weights</span><span class=p >,</span> <span class=n >check_rank</span><span class=o >=</span><span class=n >check_rank</span><span class=p >)</span>
        <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >_constant</span><span class=p >:</span>
            <span class=k >raise</span> <span class=ne >ValueError</span><span class=p >(</span>
                <span class=s2 >"Constants are not allowed in first difference regressions."</span>
            <span class=p >)</span>
        <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >nobs</span> <span class=o >&lt;</span> <span class=mi >2</span><span class=p >:</span>
            <span class=k >raise</span> <span class=ne >ValueError</span><span class=p >(</span><span class=s2 >"Panel must have at least 2 time periods"</span><span class=p >)</span>

    <span class=k >def</span> <span class=nf >_setup_clusters</span><span class=p >(</span>
        <span class=bp >self</span><span class=p >,</span> <span class=n >cov_config</span><span class=p >:</span> <span class=nb >dict</span><span class=p >[</span><span class=nb >str</span><span class=p >,</span> <span class=nb >bool</span> <span class=o >|</span> <span class=nb >float</span> <span class=o >|</span> <span class=nb >str</span> <span class=o >|</span> <span class=n >PanelDataLike</span><span class=p >]</span>
    <span class=p >)</span> <span class=o >-&gt;</span> <span class=nb >dict</span><span class=p >[</span><span class=nb >str</span><span class=p >,</span> <span class=nb >bool</span> <span class=o >|</span> <span class=nb >float</span> <span class=o >|</span> <span class=nb >str</span> <span class=o >|</span> <span class=n >DataFrame</span><span class=p >]:</span>
        <span class=n >cov_config_upd</span> <span class=o >=</span> <span class=n >cov_config</span><span class=o >.</span><span class=n >copy</span><span class=p >()</span>
        <span class=n >cluster_types</span> <span class=o >=</span> <span class=p >(</span><span class=s2 >"clusters"</span><span class=p >,</span> <span class=s2 >"cluster_entity"</span><span class=p >)</span>
        <span class=n >common</span> <span class=o >=</span> <span class=nb >set</span><span class=p >(</span><span class=n >cov_config</span><span class=o >.</span><span class=n >keys</span><span class=p >())</span><span class=o >.</span><span class=n >intersection</span><span class=p >(</span><span class=n >cluster_types</span><span class=p >)</span>
        <span class=k >if</span> <span class=ow >not</span> <span class=n >common</span><span class=p >:</span>
            <span class=k >return</span> <span class=n >cov_config_upd</span>

        <span class=n >clusters</span> <span class=o >=</span> <span class=n >cov_config</span><span class=o >.</span><span class=n >get</span><span class=p >(</span><span class=s2 >"clusters"</span><span class=p >,</span> <span class=kc >None</span><span class=p >)</span>
        <span class=n >clusters_frame</span><span class=p >:</span> <span class=n >DataFrame</span> <span class=o >|</span> <span class=kc >None</span> <span class=o >=</span> <span class=kc >None</span>
        <span class=k >if</span> <span class=n >clusters</span> <span class=ow >is</span> <span class=ow >not</span> <span class=kc >None</span><span class=p >:</span>
            <span class=n >clusters_panel</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >reformat_clusters</span><span class=p >(</span><span class=n >clusters</span><span class=p >)</span>
            <span class=n >fd</span> <span class=o >=</span> <span class=n >clusters_panel</span><span class=o >.</span><span class=n >first_difference</span><span class=p >()</span>
            <span class=n >fd_array</span> <span class=o >=</span> <span class=n >fd</span><span class=o >.</span><span class=n >values2d</span>
            <span class=k >if</span> <span class=n >np</span><span class=o >.</span><span class=n >any</span><span class=p >(</span><span class=n >fd_array</span><span class=o >.</span><span class=n >flat</span><span class=p >[</span><span class=n >np</span><span class=o >.</span><span class=n >isfinite</span><span class=p >(</span><span class=n >fd_array</span><span class=o >.</span><span class=n >flat</span><span class=p >)]</span> <span class=o >!=</span> <span class=mi >0</span><span class=p >):</span>
                <span class=k >raise</span> <span class=ne >ValueError</span><span class=p >(</span>
                    <span class=s2 >"clusters must be identical for values used "</span>
                    <span class=s2 >"to compute the first difference"</span>
                <span class=p >)</span>
            <span class=n >clusters_frame</span> <span class=o >=</span> <span class=n >clusters_panel</span><span class=o >.</span><span class=n >dataframe</span><span class=o >.</span><span class=n >copy</span><span class=p >()</span>

        <span class=n >cluster_entity</span> <span class=o >=</span> <span class=n >cov_config_upd</span><span class=o >.</span><span class=n >pop</span><span class=p >(</span><span class=s2 >"cluster_entity"</span><span class=p >,</span> <span class=kc >False</span><span class=p >)</span>
        <span class=k >if</span> <span class=n >cluster_entity</span><span class=p >:</span>
            <span class=n >group_ids</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >entity_ids</span><span class=o >.</span><span class=n >squeeze</span><span class=p >()</span>
            <span class=n >name</span> <span class=o >=</span> <span class=s2 >"cov.cluster.entity"</span>
            <span class=n >group_ids</span> <span class=o >=</span> <span class=n >Series</span><span class=p >(</span><span class=n >group_ids</span><span class=p >,</span> <span class=n >index</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >index</span><span class=p >,</span> <span class=n >name</span><span class=o >=</span><span class=n >name</span><span class=p >)</span>
            <span class=k >if</span> <span class=n >clusters_frame</span> <span class=ow >is</span> <span class=ow >not</span> <span class=kc >None</span><span class=p >:</span>
                <span class=n >clusters_frame</span><span class=p >[</span><span class=n >name</span><span class=p >]</span> <span class=o >=</span> <span class=n >group_ids</span>
            <span class=k >else</span><span class=p >:</span>
                <span class=n >clusters_frame</span> <span class=o >=</span> <span class=n >DataFrame</span><span class=p >(</span><span class=n >group_ids</span><span class=p >)</span>
        <span class=n >cluster_data</span> <span class=o >=</span> <span class=n >PanelData</span><span class=p >(</span><span class=n >clusters_frame</span><span class=p >)</span>
        <span class=n >values</span> <span class=o >=</span> <span class=n >cluster_data</span><span class=o >.</span><span class=n >values3d</span><span class=p >[:,</span> <span class=mi >1</span><span class=p >:]</span>
        <span class=n >cluster_frame</span> <span class=o >=</span> <span class=n >panel_to_frame</span><span class=p >(</span>
            <span class=n >values</span><span class=p >,</span>
            <span class=n >cluster_data</span><span class=o >.</span><span class=n >panel</span><span class=o >.</span><span class=n >items</span><span class=p >,</span>
            <span class=n >cluster_data</span><span class=o >.</span><span class=n >panel</span><span class=o >.</span><span class=n >major_axis</span><span class=p >[</span><span class=mi >1</span><span class=p >:],</span>
            <span class=n >cluster_data</span><span class=o >.</span><span class=n >panel</span><span class=o >.</span><span class=n >minor_axis</span><span class=p >,</span>
            <span class=kc >True</span><span class=p >,</span>
        <span class=p >)</span>
        <span class=n >cluster_frame</span> <span class=o >=</span> <span class=n >PanelData</span><span class=p >(</span><span class=n >cluster_frame</span><span class=p >)</span><span class=o >.</span><span class=n >dataframe</span>
        <span class=n >cluster_frame</span> <span class=o >=</span> <span class=n >cluster_frame</span><span class=o >.</span><span class=n >loc</span><span class=p >[</span><span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >first_difference</span><span class=p >()</span><span class=o >.</span><span class=n >index</span><span class=p >]</span>
        <span class=n >cluster_frame</span> <span class=o >=</span> <span class=n >cluster_frame</span><span class=o >.</span><span class=n >astype</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >int64</span><span class=p >)</span>

        <span class=n >cov_config_upd</span><span class=p >[</span><span class=s2 >"clusters"</span><span class=p >]</span> <span class=o >=</span> <span class=p >(</span>
            <span class=n >cluster_frame</span><span class=o >.</span><span class=n >values</span> <span class=k >if</span> <span class=n >cluster_frame</span> <span class=ow >is</span> <span class=ow >not</span> <span class=kc >None</span> <span class=k >else</span> <span class=kc >None</span>
        <span class=p >)</span>

        <span class=k >return</span> <span class=n >cov_config_upd</span>

<div class=viewcode-block  id=FirstDifferenceOLS.fit ><a class=viewcode-back  href="../../../panel/panel/linearmodels.panel.model.FirstDifferenceOLS.fit.html#linearmodels.panel.model.FirstDifferenceOLS.fit">[docs]</a>    <span class=k >def</span> <span class=nf >fit</span><span class=p >(</span>
        <span class=bp >self</span><span class=p >,</span>
        <span class=o >*</span><span class=p >,</span>
        <span class=n >cov_type</span><span class=p >:</span> <span class=nb >str</span> <span class=o >=</span> <span class=s2 >"unadjusted"</span><span class=p >,</span>
        <span class=n >debiased</span><span class=p >:</span> <span class=nb >bool</span> <span class=o >=</span> <span class=kc >True</span><span class=p >,</span>
        <span class=o >**</span><span class=n >cov_config</span><span class=p >:</span> <span class=nb >bool</span> <span class=o >|</span> <span class=nb >float</span> <span class=o >|</span> <span class=nb >str</span> <span class=o >|</span> <span class=n >IntArray</span> <span class=o >|</span> <span class=n >DataFrame</span> <span class=o >|</span> <span class=n >PanelData</span><span class=p >,</span>
    <span class=p >)</span> <span class=o >-&gt;</span> <span class=n >PanelResults</span><span class=p >:</span>
        <span class=sd >"""</span>
<span class=sd >        Estimate model parameters</span>

<span class=sd >        Parameters</span>
<span class=sd >        ----------</span>
<span class=sd >        cov_type : str</span>
<span class=sd >            Name of covariance estimator. See Notes.</span>
<span class=sd >        debiased : bool</span>
<span class=sd >            Flag indicating whether to debiased the covariance estimator using</span>
<span class=sd >            a degree of freedom adjustment.</span>
<span class=sd >        **cov_config</span>
<span class=sd >            Additional covariance-specific options.  See Notes.</span>

<span class=sd >        Returns</span>
<span class=sd >        -------</span>
<span class=sd >        PanelResults</span>
<span class=sd >            Estimation results</span>

<span class=sd >        Examples</span>
<span class=sd >        --------</span>
<span class=sd >        &gt;&gt;&gt; from linearmodels import FirstDifferenceOLS</span>
<span class=sd >        &gt;&gt;&gt; mod = FirstDifferenceOLS(y, x)</span>
<span class=sd >        &gt;&gt;&gt; robust = mod.fit(cov_type="robust")</span>
<span class=sd >        &gt;&gt;&gt; clustered = mod.fit(cov_type="clustered", cluster_entity=True)</span>

<span class=sd >        Notes</span>
<span class=sd >        -----</span>
<span class=sd >        Three covariance estimators are supported:</span>

<span class=sd >        * "unadjusted", "homoskedastic" - Assume residual are homoskedastic</span>
<span class=sd >        * "robust", "heteroskedastic" - Control for heteroskedasticity using</span>
<span class=sd >          White's estimator</span>
<span class=sd >        * "clustered` - White's.  Configuration options are:</span>

<span class=sd >          * ``clusters`` - Input containing 1 or 2 variables.</span>
<span class=sd >            Clusters should be integer values, although other types will</span>
<span class=sd >            be coerced to integer values by treating as categorical variables</span>
<span class=sd >          * ``cluster_entity`` - Boolean flag indicating to use entity</span>
<span class=sd >            clusters</span>

<span class=sd >        * "kernel" - Driscoll-Kraay HAC estimator. Configurations options are:</span>

<span class=sd >          * ``kernel`` - One of the supported kernels (bartlett, parzen, qs).</span>
<span class=sd >            Default is Bartlett's kernel, which is produces a covariance</span>
<span class=sd >            estimator similar to the Newey-West covariance estimator.</span>
<span class=sd >          * ``bandwidth`` - Bandwidth to use when computing the kernel.  If</span>
<span class=sd >            not provided, a naive default is used.</span>

<span class=sd >        When using a clustered covariance estimator, all cluster ids must be</span>
<span class=sd >        identical within a first difference.  In most scenarios, this requires</span>
<span class=sd >        ids to be identical within an entity.</span>
<span class=sd >        """</span>
        <span class=n >y_fd</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >first_difference</span><span class=p >()</span>
        <span class=n >time_ids</span> <span class=o >=</span> <span class=n >y_fd</span><span class=o >.</span><span class=n >time_ids</span>
        <span class=n >entity_ids</span> <span class=o >=</span> <span class=n >y_fd</span><span class=o >.</span><span class=n >entity_ids</span>
        <span class=n >index</span> <span class=o >=</span> <span class=n >y_fd</span><span class=o >.</span><span class=n >index</span>
        <span class=n >y</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span><span class=n >Float64Array</span><span class=p >,</span> <span class=n >y_fd</span><span class=o >.</span><span class=n >values2d</span><span class=p >)</span>
        <span class=n >x</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span><span class=n >Float64Array</span><span class=p >,</span> <span class=bp >self</span><span class=o >.</span><span class=n >exog</span><span class=o >.</span><span class=n >first_difference</span><span class=p >()</span><span class=o >.</span><span class=n >values2d</span><span class=p >)</span>

        <span class=k >if</span> <span class=n >np</span><span class=o >.</span><span class=n >all</span><span class=p >(</span><span class=bp >self</span><span class=o >.</span><span class=n >weights</span><span class=o >.</span><span class=n >values2d</span> <span class=o >==</span> <span class=mf >1.0</span><span class=p >):</span>
            <span class=n >w</span> <span class=o >=</span> <span class=n >root_w</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >ones_like</span><span class=p >(</span><span class=n >y</span><span class=p >)</span>
        <span class=k >else</span><span class=p >:</span>
            <span class=n >w</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span><span class=n >Float64Array</span><span class=p >,</span> <span class=mf >1.0</span> <span class=o >/</span> <span class=bp >self</span><span class=o >.</span><span class=n >weights</span><span class=o >.</span><span class=n >values3d</span><span class=p >)</span>
            <span class=n >w</span> <span class=o >=</span> <span class=n >w</span><span class=p >[:,</span> <span class=p >:</span><span class=o >-</span><span class=mi >1</span><span class=p >]</span> <span class=o >+</span> <span class=n >w</span><span class=p >[:,</span> <span class=mi >1</span><span class=p >:]</span>
            <span class=n >w</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span><span class=n >Float64Array</span><span class=p >,</span> <span class=mf >1.0</span> <span class=o >/</span> <span class=n >w</span><span class=p >)</span>
            <span class=n >w_frame</span> <span class=o >=</span> <span class=n >panel_to_frame</span><span class=p >(</span>
                <span class=n >w</span><span class=p >,</span>
                <span class=bp >self</span><span class=o >.</span><span class=n >weights</span><span class=o >.</span><span class=n >panel</span><span class=o >.</span><span class=n >items</span><span class=p >,</span>
                <span class=bp >self</span><span class=o >.</span><span class=n >weights</span><span class=o >.</span><span class=n >panel</span><span class=o >.</span><span class=n >major_axis</span><span class=p >[</span><span class=mi >1</span><span class=p >:],</span>
                <span class=bp >self</span><span class=o >.</span><span class=n >weights</span><span class=o >.</span><span class=n >panel</span><span class=o >.</span><span class=n >minor_axis</span><span class=p >,</span>
                <span class=kc >True</span><span class=p >,</span>
            <span class=p >)</span>
            <span class=n >w_frame</span> <span class=o >=</span> <span class=n >w_frame</span><span class=o >.</span><span class=n >reindex</span><span class=p >(</span><span class=bp >self</span><span class=o >.</span><span class=n >weights</span><span class=o >.</span><span class=n >index</span><span class=p >)</span><span class=o >.</span><span class=n >dropna</span><span class=p >(</span><span class=n >how</span><span class=o >=</span><span class=s2 >"any"</span><span class=p >)</span>
            <span class=n >index</span> <span class=o >=</span> <span class=n >w_frame</span><span class=o >.</span><span class=n >index</span>
            <span class=n >w</span> <span class=o >=</span> <span class=n >w_frame</span><span class=o >.</span><span class=n >to_numpy</span><span class=p >()</span>

            <span class=n >w</span> <span class=o >/=</span> <span class=n >w</span><span class=o >.</span><span class=n >mean</span><span class=p >()</span>
            <span class=n >root_w</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span><span class=n >Float64Array</span><span class=p >,</span> <span class=n >np</span><span class=o >.</span><span class=n >sqrt</span><span class=p >(</span><span class=n >w</span><span class=p >))</span>

        <span class=n >wx</span> <span class=o >=</span> <span class=n >root_w</span> <span class=o >*</span> <span class=n >x</span>
        <span class=n >wy</span> <span class=o >=</span> <span class=n >root_w</span> <span class=o >*</span> <span class=n >y</span>
        <span class=n >params</span> <span class=o >=</span> <span class=n >_lstsq</span><span class=p >(</span><span class=n >wx</span><span class=p >,</span> <span class=n >wy</span><span class=p >,</span> <span class=n >rcond</span><span class=o >=</span><span class=kc >None</span><span class=p >)[</span><span class=mi >0</span><span class=p >]</span>
        <span class=n >df_resid</span> <span class=o >=</span> <span class=n >y</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >]</span> <span class=o >-</span> <span class=n >x</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >1</span><span class=p >]</span>
        <span class=n >cov_config</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_setup_clusters</span><span class=p >(</span><span class=n >cov_config</span><span class=p >)</span>
        <span class=n >extra_df</span> <span class=o >=</span> <span class=mi >0</span>
        <span class=k >if</span> <span class=s2 >"extra_df"</span> <span class=ow >in</span> <span class=n >cov_config</span><span class=p >:</span>
            <span class=n >cov_config</span> <span class=o >=</span> <span class=n >cov_config</span><span class=o >.</span><span class=n >copy</span><span class=p >()</span>
            <span class=n >_extra_df</span> <span class=o >=</span> <span class=n >cov_config</span><span class=o >.</span><span class=n >pop</span><span class=p >(</span><span class=s2 >"extra_df"</span><span class=p >)</span>
            <span class=k >assert</span> <span class=nb >isinstance</span><span class=p >(</span><span class=n >_extra_df</span><span class=p >,</span> <span class=p >(</span><span class=nb >str</span><span class=p >,</span> <span class=nb >int</span><span class=p >))</span>
            <span class=n >extra_df</span> <span class=o >=</span> <span class=nb >int</span><span class=p >(</span><span class=n >_extra_df</span><span class=p >)</span>
        <span class=n >cov</span> <span class=o >=</span> <span class=n >setup_covariance_estimator</span><span class=p >(</span>
            <span class=bp >self</span><span class=o >.</span><span class=n >_cov_estimators</span><span class=p >,</span>
            <span class=n >cov_type</span><span class=p >,</span>
            <span class=n >wy</span><span class=p >,</span>
            <span class=n >wx</span><span class=p >,</span>
            <span class=n >params</span><span class=p >,</span>
            <span class=n >entity_ids</span><span class=p >,</span>
            <span class=n >time_ids</span><span class=p >,</span>
            <span class=n >debiased</span><span class=o >=</span><span class=n >debiased</span><span class=p >,</span>
            <span class=n >extra_df</span><span class=o >=</span><span class=n >extra_df</span><span class=p >,</span>
            <span class=o >**</span><span class=n >cov_config</span><span class=p >,</span>
        <span class=p >)</span>

        <span class=n >weps</span> <span class=o >=</span> <span class=n >wy</span> <span class=o >-</span> <span class=n >wx</span> <span class=o >@</span> <span class=n >params</span>
        <span class=n >fitted</span> <span class=o >=</span> <span class=n >DataFrame</span><span class=p >(</span>
            <span class=bp >self</span><span class=o >.</span><span class=n >exog</span><span class=o >.</span><span class=n >values2d</span> <span class=o >@</span> <span class=n >params</span><span class=p >,</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >index</span><span class=p >,</span> <span class=p >[</span><span class=s2 >"fitted_values"</span><span class=p >]</span>
        <span class=p >)</span>
        <span class=n >idiosyncratic</span> <span class=o >=</span> <span class=n >DataFrame</span><span class=p >(</span>
            <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >values2d</span> <span class=o >-</span> <span class=n >fitted</span><span class=o >.</span><span class=n >values</span><span class=p >,</span>
            <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >index</span><span class=p >,</span>
            <span class=p >[</span><span class=s2 >"idiosyncratic"</span><span class=p >],</span>
        <span class=p >)</span>
        <span class=n >effects</span> <span class=o >=</span> <span class=n >DataFrame</span><span class=p >(</span>
            <span class=n >np</span><span class=o >.</span><span class=n >full_like</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >asarray</span><span class=p >(</span><span class=n >fitted</span><span class=p >),</span> <span class=n >np</span><span class=o >.</span><span class=n >nan</span><span class=p >),</span>
            <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >index</span><span class=p >,</span>
            <span class=p >[</span><span class=s2 >"estimated_effects"</span><span class=p >],</span>
        <span class=p >)</span>
        <span class=n >eps</span> <span class=o >=</span> <span class=n >y</span> <span class=o >-</span> <span class=n >x</span> <span class=o >@</span> <span class=n >params</span>

        <span class=n >residual_ss</span> <span class=o >=</span> <span class=nb >float</span><span class=p >(</span><span class=n >weps</span><span class=o >.</span><span class=n >T</span> <span class=o >@</span> <span class=n >weps</span><span class=p >)</span>
        <span class=n >total_ss</span> <span class=o >=</span> <span class=nb >float</span><span class=p >(</span><span class=n >w</span><span class=o >.</span><span class=n >T</span> <span class=o >@</span> <span class=p >(</span><span class=n >y</span><span class=o >**</span><span class=mi >2</span><span class=p >))</span>
        <span class=n >r2</span> <span class=o >=</span> <span class=mi >1</span> <span class=o >-</span> <span class=n >residual_ss</span> <span class=o >/</span> <span class=n >total_ss</span>

        <span class=n >res</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_postestimation</span><span class=p >(</span>
            <span class=n >params</span><span class=p >,</span> <span class=n >cov</span><span class=p >,</span> <span class=n >debiased</span><span class=p >,</span> <span class=n >df_resid</span><span class=p >,</span> <span class=n >weps</span><span class=p >,</span> <span class=n >wy</span><span class=p >,</span> <span class=n >wx</span><span class=p >,</span> <span class=n >root_w</span>
        <span class=p >)</span>
        <span class=n >res</span><span class=o >.</span><span class=n >update</span><span class=p >(</span>
            <span class=nb >dict</span><span class=p >(</span>
                <span class=n >df_resid</span><span class=o >=</span><span class=n >df_resid</span><span class=p >,</span>
                <span class=n >df_model</span><span class=o >=</span><span class=n >x</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >1</span><span class=p >],</span>
                <span class=n >nobs</span><span class=o >=</span><span class=n >y</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >],</span>
                <span class=n >residual_ss</span><span class=o >=</span><span class=n >residual_ss</span><span class=p >,</span>
                <span class=n >total_ss</span><span class=o >=</span><span class=n >total_ss</span><span class=p >,</span>
                <span class=n >r2</span><span class=o >=</span><span class=n >r2</span><span class=p >,</span>
                <span class=n >resids</span><span class=o >=</span><span class=n >eps</span><span class=p >,</span>
                <span class=n >wresids</span><span class=o >=</span><span class=n >weps</span><span class=p >,</span>
                <span class=n >index</span><span class=o >=</span><span class=n >index</span><span class=p >,</span>
                <span class=n >fitted</span><span class=o >=</span><span class=n >fitted</span><span class=p >,</span>
                <span class=n >effects</span><span class=o >=</span><span class=n >effects</span><span class=p >,</span>
                <span class=n >idiosyncratic</span><span class=o >=</span><span class=n >idiosyncratic</span><span class=p >,</span>
            <span class=p >)</span>
        <span class=p >)</span>

        <span class=k >return</span> <span class=n >PanelResults</span><span class=p >(</span><span class=n >res</span><span class=p >)</span></div>

<div class=viewcode-block  id=FirstDifferenceOLS.from_formula ><a class=viewcode-back  href="../../../panel/panel/linearmodels.panel.model.FirstDifferenceOLS.from_formula.html#linearmodels.panel.model.FirstDifferenceOLS.from_formula">[docs]</a>    <span class=nd >@classmethod</span>
    <span class=k >def</span> <span class=nf >from_formula</span><span class=p >(</span>
        <span class=bp >cls</span><span class=p >,</span>
        <span class=n >formula</span><span class=p >:</span> <span class=nb >str</span><span class=p >,</span>
        <span class=n >data</span><span class=p >:</span> <span class=n >PanelDataLike</span><span class=p >,</span>
        <span class=o >*</span><span class=p >,</span>
        <span class=n >weights</span><span class=p >:</span> <span class=n >PanelDataLike</span> <span class=o >|</span> <span class=kc >None</span> <span class=o >=</span> <span class=kc >None</span><span class=p >,</span>
        <span class=n >check_rank</span><span class=p >:</span> <span class=nb >bool</span> <span class=o >=</span> <span class=kc >True</span><span class=p >,</span>
    <span class=p >)</span> <span class=o >-&gt;</span> <span class=n >FirstDifferenceOLS</span><span class=p >:</span>
        <span class=sd >"""</span>
<span class=sd >        Create a model from a formula</span>

<span class=sd >        Parameters</span>
<span class=sd >        ----------</span>
<span class=sd >        formula : str</span>
<span class=sd >            Formula to transform into model. Conforms to formulaic formula</span>
<span class=sd >            rules.</span>
<span class=sd >        data : array_like</span>
<span class=sd >            Data structure that can be coerced into a PanelData.  In most</span>
<span class=sd >            cases, this should be a multi-index DataFrame where the level 0</span>
<span class=sd >            index contains the entities and the level 1 contains the time.</span>
<span class=sd >        weights: array_like</span>
<span class=sd >            Weights to use in estimation.  Assumes residual variance is</span>
<span class=sd >            proportional to inverse of weight to that the residual times</span>
<span class=sd >            the weight should be homoskedastic.</span>
<span class=sd >        check_rank : bool</span>
<span class=sd >            Flag indicating whether to perform a rank check on the exogenous</span>
<span class=sd >            variables to ensure that the model is identified. Skipping this</span>
<span class=sd >            check can reduce the time required to validate a model</span>
<span class=sd >            specification. Results may be numerically unstable if this check</span>
<span class=sd >            is skipped and the matrix is not full rank.</span>

<span class=sd >        Returns</span>
<span class=sd >        -------</span>
<span class=sd >        FirstDifferenceOLS</span>
<span class=sd >            Model specified using the formula</span>

<span class=sd >        Notes</span>
<span class=sd >        -----</span>
<span class=sd >        Unlike standard  formula syntax, it is necessary to explicitly include</span>
<span class=sd >        a constant using the constant indicator (1)</span>

<span class=sd >        Examples</span>
<span class=sd >        --------</span>
<span class=sd >        &gt;&gt;&gt; from linearmodels import FirstDifferenceOLS</span>
<span class=sd >        &gt;&gt;&gt; from linearmodels.panel import generate_panel_data</span>
<span class=sd >        &gt;&gt;&gt; panel_data = generate_panel_data()</span>
<span class=sd >        &gt;&gt;&gt; mod = FirstDifferenceOLS.from_formula("y ~ x1", panel_data.data)</span>
<span class=sd >        &gt;&gt;&gt; res = mod.fit()</span>
<span class=sd >        """</span>
        <span class=n >parser</span> <span class=o >=</span> <span class=n >PanelFormulaParser</span><span class=p >(</span><span class=n >formula</span><span class=p >,</span> <span class=n >data</span><span class=p >)</span>
        <span class=n >dependent</span><span class=p >,</span> <span class=n >exog</span> <span class=o >=</span> <span class=n >parser</span><span class=o >.</span><span class=n >data</span>
        <span class=n >mod</span> <span class=o >=</span> <span class=bp >cls</span><span class=p >(</span><span class=n >dependent</span><span class=p >,</span> <span class=n >exog</span><span class=p >,</span> <span class=n >weights</span><span class=o >=</span><span class=n >weights</span><span class=p >,</span> <span class=n >check_rank</span><span class=o >=</span><span class=n >check_rank</span><span class=p >)</span>
        <span class=n >mod</span><span class=o >.</span><span class=n >formula</span> <span class=o >=</span> <span class=n >formula</span>
        <span class=k >return</span> <span class=n >mod</span></div></div>


<div class=viewcode-block  id=RandomEffects ><a class=viewcode-back  href="../../../panel/panel/linearmodels.panel.model.RandomEffects.html#linearmodels.panel.model.RandomEffects">[docs]</a><span class=k >class</span> <span class=nc >RandomEffects</span><span class=p >(</span><span class=n >_PanelModelBase</span><span class=p >):</span>
    <span class=sa >r</span><span class=sd >"""</span>
<span class=sd >    One-way Random Effects model for panel data</span>

<span class=sd >    Parameters</span>
<span class=sd >    ----------</span>
<span class=sd >    dependent : array_like</span>
<span class=sd >        Dependent (left-hand-side) variable (time by entity)</span>
<span class=sd >    exog : array_like</span>
<span class=sd >        Exogenous or right-hand-side variables (variable by time by entity).</span>
<span class=sd >    weights : array_like</span>
<span class=sd >        Weights to use in estimation.  Assumes residual variance is</span>
<span class=sd >        proportional to inverse of weight to that the residual time</span>
<span class=sd >        the weight should be homoskedastic.</span>

<span class=sd >    Notes</span>
<span class=sd >    -----</span>
<span class=sd >    The model is given by</span>

<span class=sd >    .. math::</span>

<span class=sd >        y_{it} = \beta^{\prime}x_{it} + u_i + \epsilon_{it}</span>

<span class=sd >    where :math:`u_i` is a shock that is independent of :math:`x_{it}` but</span>
<span class=sd >    common to all entities i.</span>
<span class=sd >    """</span>

    <span class=k >def</span> <span class=fm >__init__</span><span class=p >(</span>
        <span class=bp >self</span><span class=p >,</span>
        <span class=n >dependent</span><span class=p >:</span> <span class=n >PanelDataLike</span><span class=p >,</span>
        <span class=n >exog</span><span class=p >:</span> <span class=n >PanelDataLike</span><span class=p >,</span>
        <span class=o >*</span><span class=p >,</span>
        <span class=n >weights</span><span class=p >:</span> <span class=n >PanelDataLike</span> <span class=o >|</span> <span class=kc >None</span> <span class=o >=</span> <span class=kc >None</span><span class=p >,</span>
        <span class=n >check_rank</span><span class=p >:</span> <span class=nb >bool</span> <span class=o >=</span> <span class=kc >True</span><span class=p >,</span>
    <span class=p >)</span> <span class=o >-&gt;</span> <span class=kc >None</span><span class=p >:</span>
        <span class=nb >super</span><span class=p >()</span><span class=o >.</span><span class=fm >__init__</span><span class=p >(</span><span class=n >dependent</span><span class=p >,</span> <span class=n >exog</span><span class=p >,</span> <span class=n >weights</span><span class=o >=</span><span class=n >weights</span><span class=p >,</span> <span class=n >check_rank</span><span class=o >=</span><span class=n >check_rank</span><span class=p >)</span>

<div class=viewcode-block  id=RandomEffects.from_formula ><a class=viewcode-back  href="../../../panel/panel/linearmodels.panel.model.RandomEffects.from_formula.html#linearmodels.panel.model.RandomEffects.from_formula">[docs]</a>    <span class=nd >@classmethod</span>
    <span class=k >def</span> <span class=nf >from_formula</span><span class=p >(</span>
        <span class=bp >cls</span><span class=p >,</span>
        <span class=n >formula</span><span class=p >:</span> <span class=nb >str</span><span class=p >,</span>
        <span class=n >data</span><span class=p >:</span> <span class=n >PanelDataLike</span><span class=p >,</span>
        <span class=o >*</span><span class=p >,</span>
        <span class=n >weights</span><span class=p >:</span> <span class=n >PanelDataLike</span> <span class=o >|</span> <span class=kc >None</span> <span class=o >=</span> <span class=kc >None</span><span class=p >,</span>
        <span class=n >check_rank</span><span class=p >:</span> <span class=nb >bool</span> <span class=o >=</span> <span class=kc >True</span><span class=p >,</span>
    <span class=p >)</span> <span class=o >-&gt;</span> <span class=n >RandomEffects</span><span class=p >:</span>
        <span class=sd >"""</span>
<span class=sd >        Create a model from a formula</span>

<span class=sd >        Parameters</span>
<span class=sd >        ----------</span>
<span class=sd >        formula : str</span>
<span class=sd >            Formula to transform into model. Conforms to formulaic formula</span>
<span class=sd >            rules.</span>
<span class=sd >        data : array_like</span>
<span class=sd >            Data structure that can be coerced into a PanelData.  In most</span>
<span class=sd >            cases, this should be a multi-index DataFrame where the level 0</span>
<span class=sd >            index contains the entities and the level 1 contains the time.</span>
<span class=sd >        weights: array_like</span>
<span class=sd >            Weights to use in estimation.  Assumes residual variance is</span>
<span class=sd >            proportional to inverse of weight to that the residual times</span>
<span class=sd >            the weight should be homoskedastic.</span>
<span class=sd >        check_rank : bool</span>
<span class=sd >            Flag indicating whether to perform a rank check on the exogenous</span>
<span class=sd >            variables to ensure that the model is identified. Skipping this</span>
<span class=sd >            check can reduce the time required to validate a model</span>
<span class=sd >            specification. Results may be numerically unstable if this check</span>
<span class=sd >            is skipped and the matrix is not full rank.</span>

<span class=sd >        Returns</span>
<span class=sd >        -------</span>
<span class=sd >        RandomEffects</span>
<span class=sd >            Model specified using the formula</span>

<span class=sd >        Notes</span>
<span class=sd >        -----</span>
<span class=sd >        Unlike standard  formula syntax, it is necessary to explicitly include</span>
<span class=sd >        a constant using the constant indicator (1)</span>

<span class=sd >        Examples</span>
<span class=sd >        --------</span>
<span class=sd >        &gt;&gt;&gt; from linearmodels import RandomEffects</span>
<span class=sd >        &gt;&gt;&gt; from linearmodels.panel import generate_panel_data</span>
<span class=sd >        &gt;&gt;&gt; panel_data = generate_panel_data()</span>
<span class=sd >        &gt;&gt;&gt; mod = RandomEffects.from_formula("y ~ 1 + x1", panel_data.data)</span>
<span class=sd >        &gt;&gt;&gt; res = mod.fit()</span>
<span class=sd >        """</span>
        <span class=n >parser</span> <span class=o >=</span> <span class=n >PanelFormulaParser</span><span class=p >(</span><span class=n >formula</span><span class=p >,</span> <span class=n >data</span><span class=p >)</span>
        <span class=n >dependent</span><span class=p >,</span> <span class=n >exog</span> <span class=o >=</span> <span class=n >parser</span><span class=o >.</span><span class=n >data</span>
        <span class=n >mod</span> <span class=o >=</span> <span class=bp >cls</span><span class=p >(</span><span class=n >dependent</span><span class=p >,</span> <span class=n >exog</span><span class=p >,</span> <span class=n >weights</span><span class=o >=</span><span class=n >weights</span><span class=p >,</span> <span class=n >check_rank</span><span class=o >=</span><span class=n >check_rank</span><span class=p >)</span>
        <span class=n >mod</span><span class=o >.</span><span class=n >formula</span> <span class=o >=</span> <span class=n >formula</span>
        <span class=k >return</span> <span class=n >mod</span></div>

<div class=viewcode-block  id=RandomEffects.fit ><a class=viewcode-back  href="../../../panel/panel/linearmodels.panel.model.RandomEffects.fit.html#linearmodels.panel.model.RandomEffects.fit">[docs]</a>    <span class=k >def</span> <span class=nf >fit</span><span class=p >(</span>
        <span class=bp >self</span><span class=p >,</span>
        <span class=o >*</span><span class=p >,</span>
        <span class=n >small_sample</span><span class=p >:</span> <span class=nb >bool</span> <span class=o >=</span> <span class=kc >False</span><span class=p >,</span>
        <span class=n >cov_type</span><span class=p >:</span> <span class=nb >str</span> <span class=o >=</span> <span class=s2 >"unadjusted"</span><span class=p >,</span>
        <span class=n >debiased</span><span class=p >:</span> <span class=nb >bool</span> <span class=o >=</span> <span class=kc >True</span><span class=p >,</span>
        <span class=o >**</span><span class=n >cov_config</span><span class=p >:</span> <span class=nb >bool</span> <span class=o >|</span> <span class=nb >float</span> <span class=o >|</span> <span class=nb >str</span> <span class=o >|</span> <span class=n >IntArray</span> <span class=o >|</span> <span class=n >DataFrame</span> <span class=o >|</span> <span class=n >PanelData</span><span class=p >,</span>
    <span class=p >)</span> <span class=o >-&gt;</span> <span class=n >RandomEffectsResults</span><span class=p >:</span>
        <span class=sd >"""</span>
<span class=sd >        Estimate model parameters</span>

<span class=sd >        Parameters</span>
<span class=sd >        ----------</span>
<span class=sd >        small_sample : bool</span>
<span class=sd >            Apply a small-sample correction to the estimate of the variance of</span>
<span class=sd >            the random effect.</span>
<span class=sd >        cov_type : str</span>
<span class=sd >            Name of covariance estimator (see notes). Default is "unadjusted".</span>
<span class=sd >        debiased : bool</span>
<span class=sd >            Flag indicating whether to debiased the covariance estimator using</span>
<span class=sd >            a degree of freedom adjustment.</span>
<span class=sd >        **cov_config</span>
<span class=sd >            Additional covariance-specific options.  See Notes.</span>

<span class=sd >        Returns</span>
<span class=sd >        -------</span>
<span class=sd >        RandomEffectsResults</span>
<span class=sd >            Estimation results</span>

<span class=sd >        Examples</span>
<span class=sd >        --------</span>
<span class=sd >        &gt;&gt;&gt; from linearmodels import RandomEffects</span>
<span class=sd >        &gt;&gt;&gt; mod = RandomEffects(y, x)</span>
<span class=sd >        &gt;&gt;&gt; res = mod.fit(cov_type="clustered", cluster_entity=True)</span>

<span class=sd >        Notes</span>
<span class=sd >        -----</span>
<span class=sd >        Four covariance estimators are supported:</span>

<span class=sd >        * "unadjusted", "homoskedastic" - Assume residual are homoskedastic</span>
<span class=sd >        * "robust", "heteroskedastic" - Control for heteroskedasticity using</span>
<span class=sd >          White's estimator</span>
<span class=sd >        * "clustered` - One- or two-way clustering.  Configuration options are:</span>

<span class=sd >          * ``clusters`` - Input containing 1 or 2 variables.</span>
<span class=sd >            Clusters should be integer values, although other types will</span>
<span class=sd >            be coerced to integer values by treating as categorical variables</span>
<span class=sd >          * ``cluster_entity`` - Boolean flag indicating to use entity</span>
<span class=sd >            clusters</span>
<span class=sd >          * ``cluster_time`` - Boolean indicating to use time clusters</span>

<span class=sd >        * "kernel" - Driscoll-Kraay HAC estimator. Configurations options are:</span>

<span class=sd >          * ``kernel`` - One of the supported kernels (bartlett, parzen, qs).</span>
<span class=sd >            Default is Bartlett's kernel, which is produces a covariance</span>
<span class=sd >            estimator similar to the Newey-West covariance estimator.</span>
<span class=sd >          * ``bandwidth`` - Bandwidth to use when computing the kernel.  If</span>
<span class=sd >            not provided, a naive default is used.</span>
<span class=sd >        """</span>
        <span class=n >w</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >weights</span><span class=o >.</span><span class=n >values2d</span>
        <span class=n >root_w</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span><span class=n >Float64Array</span><span class=p >,</span> <span class=n >np</span><span class=o >.</span><span class=n >sqrt</span><span class=p >(</span><span class=n >w</span><span class=p >))</span>
        <span class=n >demeaned_dep</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >demean</span><span class=p >(</span><span class=s2 >"entity"</span><span class=p >,</span> <span class=n >weights</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >weights</span><span class=p >)</span>
        <span class=n >demeaned_exog</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >exog</span><span class=o >.</span><span class=n >demean</span><span class=p >(</span><span class=s2 >"entity"</span><span class=p >,</span> <span class=n >weights</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >weights</span><span class=p >)</span>
        <span class=k >assert</span> <span class=nb >isinstance</span><span class=p >(</span><span class=n >demeaned_dep</span><span class=p >,</span> <span class=n >PanelData</span><span class=p >)</span>
        <span class=k >assert</span> <span class=nb >isinstance</span><span class=p >(</span><span class=n >demeaned_exog</span><span class=p >,</span> <span class=n >PanelData</span><span class=p >)</span>
        <span class=n >y</span> <span class=o >=</span> <span class=n >demeaned_dep</span><span class=o >.</span><span class=n >values2d</span>
        <span class=n >x</span> <span class=o >=</span> <span class=n >demeaned_exog</span><span class=o >.</span><span class=n >values2d</span>
        <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >has_constant</span><span class=p >:</span>
            <span class=n >w_sum</span> <span class=o >=</span> <span class=n >w</span><span class=o >.</span><span class=n >sum</span><span class=p >()</span>
            <span class=n >y_gm</span> <span class=o >=</span> <span class=p >(</span><span class=n >w</span> <span class=o >*</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >values2d</span><span class=p >)</span><span class=o >.</span><span class=n >sum</span><span class=p >(</span><span class=mi >0</span><span class=p >)</span> <span class=o >/</span> <span class=n >w_sum</span>
            <span class=n >x_gm</span> <span class=o >=</span> <span class=p >(</span><span class=n >w</span> <span class=o >*</span> <span class=bp >self</span><span class=o >.</span><span class=n >exog</span><span class=o >.</span><span class=n >values2d</span><span class=p >)</span><span class=o >.</span><span class=n >sum</span><span class=p >(</span><span class=mi >0</span><span class=p >)</span> <span class=o >/</span> <span class=n >w_sum</span>
            <span class=n >y</span> <span class=o >+=</span> <span class=n >root_w</span> <span class=o >*</span> <span class=n >y_gm</span>
            <span class=n >x</span> <span class=o >+=</span> <span class=n >root_w</span> <span class=o >*</span> <span class=n >x_gm</span>
        <span class=n >params</span> <span class=o >=</span> <span class=n >_lstsq</span><span class=p >(</span><span class=n >x</span><span class=p >,</span> <span class=n >y</span><span class=p >,</span> <span class=n >rcond</span><span class=o >=</span><span class=kc >None</span><span class=p >)[</span><span class=mi >0</span><span class=p >]</span>
        <span class=n >weps</span> <span class=o >=</span> <span class=n >y</span> <span class=o >-</span> <span class=n >x</span> <span class=o >@</span> <span class=n >params</span>

        <span class=n >wybar</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >mean</span><span class=p >(</span><span class=s2 >"entity"</span><span class=p >,</span> <span class=n >weights</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >weights</span><span class=p >)</span>
        <span class=n >wxbar</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >exog</span><span class=o >.</span><span class=n >mean</span><span class=p >(</span><span class=s2 >"entity"</span><span class=p >,</span> <span class=n >weights</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >weights</span><span class=p >)</span>
        <span class=n >params</span> <span class=o >=</span> <span class=n >_lstsq</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >asarray</span><span class=p >(</span><span class=n >wxbar</span><span class=p >),</span> <span class=n >np</span><span class=o >.</span><span class=n >asarray</span><span class=p >(</span><span class=n >wybar</span><span class=p >),</span> <span class=n >rcond</span><span class=o >=</span><span class=kc >None</span><span class=p >)[</span><span class=mi >0</span><span class=p >]</span>
        <span class=n >wu</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >asarray</span><span class=p >(</span><span class=n >wybar</span><span class=p >)</span> <span class=o >-</span> <span class=n >np</span><span class=o >.</span><span class=n >asarray</span><span class=p >(</span><span class=n >wxbar</span><span class=p >)</span> <span class=o >@</span> <span class=n >params</span>

        <span class=n >nobs</span> <span class=o >=</span> <span class=n >weps</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >]</span>
        <span class=n >neffects</span> <span class=o >=</span> <span class=n >wu</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >]</span>
        <span class=n >nvar</span> <span class=o >=</span> <span class=n >x</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >1</span><span class=p >]</span>
        <span class=n >sigma2_e</span> <span class=o >=</span> <span class=nb >float</span><span class=p >(</span><span class=n >weps</span><span class=o >.</span><span class=n >T</span> <span class=o >@</span> <span class=n >weps</span><span class=p >)</span> <span class=o >/</span> <span class=p >(</span><span class=n >nobs</span> <span class=o >-</span> <span class=n >nvar</span> <span class=o >-</span> <span class=n >neffects</span> <span class=o >+</span> <span class=mi >1</span><span class=p >)</span>
        <span class=n >ssr</span> <span class=o >=</span> <span class=nb >float</span><span class=p >(</span><span class=n >wu</span><span class=o >.</span><span class=n >T</span> <span class=o >@</span> <span class=n >wu</span><span class=p >)</span>
        <span class=n >t</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >asarray</span><span class=p >(</span><span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >count</span><span class=p >(</span><span class=s2 >"entity"</span><span class=p >))</span>
        <span class=n >unbalanced</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >ptp</span><span class=p >(</span><span class=n >t</span><span class=p >)</span> <span class=o >!=</span> <span class=mi >0</span>
        <span class=k >if</span> <span class=n >small_sample</span> <span class=ow >and</span> <span class=n >unbalanced</span><span class=p >:</span>
            <span class=n >ssr</span> <span class=o >=</span> <span class=nb >float</span><span class=p >((</span><span class=n >t</span> <span class=o >*</span> <span class=n >wu</span><span class=p >)</span><span class=o >.</span><span class=n >T</span> <span class=o >@</span> <span class=n >wu</span><span class=p >)</span>
            <span class=n >wx</span><span class=p >:</span> <span class=n >DataFrame</span> <span class=o >=</span> <span class=n >root_w</span> <span class=o >*</span> <span class=bp >self</span><span class=o >.</span><span class=n >exog</span><span class=o >.</span><span class=n >dataframe</span>
            <span class=n >means</span> <span class=o >=</span> <span class=n >wx</span><span class=o >.</span><span class=n >groupby</span><span class=p >(</span><span class=n >level</span><span class=o >=</span><span class=mi >0</span><span class=p >)</span><span class=o >.</span><span class=n >transform</span><span class=p >(</span><span class=s2 >"mean"</span><span class=p >)</span><span class=o >.</span><span class=n >values</span>
            <span class=n >denom</span> <span class=o >=</span> <span class=n >means</span><span class=o >.</span><span class=n >T</span> <span class=o >@</span> <span class=n >means</span>
            <span class=n >sums</span> <span class=o >=</span> <span class=n >wx</span><span class=o >.</span><span class=n >groupby</span><span class=p >(</span><span class=n >level</span><span class=o >=</span><span class=mi >0</span><span class=p >)</span><span class=o >.</span><span class=n >sum</span><span class=p >()</span><span class=o >.</span><span class=n >values</span>
            <span class=n >num</span> <span class=o >=</span> <span class=n >sums</span><span class=o >.</span><span class=n >T</span> <span class=o >@</span> <span class=n >sums</span>
            <span class=n >tr</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >trace</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >linalg</span><span class=o >.</span><span class=n >inv</span><span class=p >(</span><span class=n >denom</span><span class=p >)</span> <span class=o >@</span> <span class=n >num</span><span class=p >)</span>
            <span class=n >sigma2_u</span> <span class=o >=</span> <span class=nb >max</span><span class=p >(</span><span class=mi >0</span><span class=p >,</span> <span class=p >(</span><span class=n >ssr</span> <span class=o >-</span> <span class=p >(</span><span class=n >neffects</span> <span class=o >-</span> <span class=n >nvar</span><span class=p >)</span> <span class=o >*</span> <span class=n >sigma2_e</span><span class=p >)</span> <span class=o >/</span> <span class=p >(</span><span class=n >nobs</span> <span class=o >-</span> <span class=n >tr</span><span class=p >))</span>
        <span class=k >else</span><span class=p >:</span>
            <span class=n >t_bar</span> <span class=o >=</span> <span class=n >neffects</span> <span class=o >/</span> <span class=p >((</span><span class=mf >1.0</span> <span class=o >/</span> <span class=n >t</span><span class=p >)</span><span class=o >.</span><span class=n >sum</span><span class=p >())</span>
            <span class=n >sigma2_u</span> <span class=o >=</span> <span class=nb >max</span><span class=p >(</span><span class=mi >0</span><span class=p >,</span> <span class=n >ssr</span> <span class=o >/</span> <span class=p >(</span><span class=n >neffects</span> <span class=o >-</span> <span class=n >nvar</span><span class=p >)</span> <span class=o >-</span> <span class=n >sigma2_e</span> <span class=o >/</span> <span class=n >t_bar</span><span class=p >)</span>
        <span class=n >rho</span> <span class=o >=</span> <span class=n >sigma2_u</span> <span class=o >/</span> <span class=p >(</span><span class=n >sigma2_u</span> <span class=o >+</span> <span class=n >sigma2_e</span><span class=p >)</span>

        <span class=n >theta</span> <span class=o >=</span> <span class=mf >1.0</span> <span class=o >-</span> <span class=n >np</span><span class=o >.</span><span class=n >sqrt</span><span class=p >(</span><span class=n >sigma2_e</span> <span class=o >/</span> <span class=p >(</span><span class=n >t</span> <span class=o >*</span> <span class=n >sigma2_u</span> <span class=o >+</span> <span class=n >sigma2_e</span><span class=p >))</span>
        <span class=n >theta_out</span> <span class=o >=</span> <span class=n >DataFrame</span><span class=p >(</span><span class=n >theta</span><span class=p >,</span> <span class=n >columns</span><span class=o >=</span><span class=p >[</span><span class=s2 >"theta"</span><span class=p >],</span> <span class=n >index</span><span class=o >=</span><span class=n >wybar</span><span class=o >.</span><span class=n >index</span><span class=p >)</span>
        <span class=n >wy</span> <span class=o >=</span> <span class=n >root_w</span> <span class=o >*</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >values2d</span>
        <span class=n >wx</span> <span class=o >=</span> <span class=n >root_w</span> <span class=o >*</span> <span class=bp >self</span><span class=o >.</span><span class=n >exog</span><span class=o >.</span><span class=n >values2d</span>
        <span class=n >index</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >index</span>
        <span class=n >reindex</span> <span class=o >=</span> <span class=n >index</span><span class=o >.</span><span class=n >levels</span><span class=p >[</span><span class=mi >0</span><span class=p >][</span><span class=n >index</span><span class=o >.</span><span class=n >codes</span><span class=p >[</span><span class=mi >0</span><span class=p >]]</span>
        <span class=n >wybar</span> <span class=o >=</span> <span class=p >(</span><span class=n >theta</span> <span class=o >*</span> <span class=n >wybar</span><span class=p >)</span><span class=o >.</span><span class=n >loc</span><span class=p >[</span><span class=n >reindex</span><span class=p >]</span>
        <span class=n >wxbar</span> <span class=o >=</span> <span class=p >(</span><span class=n >theta</span> <span class=o >*</span> <span class=n >wxbar</span><span class=p >)</span><span class=o >.</span><span class=n >loc</span><span class=p >[</span><span class=n >reindex</span><span class=p >]</span>
        <span class=n >wy</span> <span class=o >-=</span> <span class=n >wybar</span><span class=o >.</span><span class=n >values</span>
        <span class=n >wx</span> <span class=o >-=</span> <span class=n >wxbar</span><span class=o >.</span><span class=n >values</span>
        <span class=n >params</span> <span class=o >=</span> <span class=n >_lstsq</span><span class=p >(</span><span class=n >wx</span><span class=p >,</span> <span class=n >wy</span><span class=p >,</span> <span class=n >rcond</span><span class=o >=</span><span class=kc >None</span><span class=p >)[</span><span class=mi >0</span><span class=p >]</span>

        <span class=n >df_resid</span> <span class=o >=</span> <span class=n >wy</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >]</span> <span class=o >-</span> <span class=n >wx</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >1</span><span class=p >]</span>
        <span class=n >cov_config</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_setup_clusters</span><span class=p >(</span><span class=n >cov_config</span><span class=p >)</span>
        <span class=n >extra_df</span> <span class=o >=</span> <span class=mi >0</span>
        <span class=k >if</span> <span class=s2 >"extra_df"</span> <span class=ow >in</span> <span class=n >cov_config</span><span class=p >:</span>
            <span class=n >cov_config</span> <span class=o >=</span> <span class=n >cov_config</span><span class=o >.</span><span class=n >copy</span><span class=p >()</span>
            <span class=n >_extra_df</span> <span class=o >=</span> <span class=n >cov_config</span><span class=o >.</span><span class=n >pop</span><span class=p >(</span><span class=s2 >"extra_df"</span><span class=p >)</span>
            <span class=k >assert</span> <span class=nb >isinstance</span><span class=p >(</span><span class=n >_extra_df</span><span class=p >,</span> <span class=p >(</span><span class=nb >str</span><span class=p >,</span> <span class=nb >int</span><span class=p >))</span>
            <span class=n >extra_df</span> <span class=o >=</span> <span class=nb >int</span><span class=p >(</span><span class=n >_extra_df</span><span class=p >)</span>
        <span class=n >cov</span> <span class=o >=</span> <span class=n >setup_covariance_estimator</span><span class=p >(</span>
            <span class=bp >self</span><span class=o >.</span><span class=n >_cov_estimators</span><span class=p >,</span>
            <span class=n >cov_type</span><span class=p >,</span>
            <span class=n >wy</span><span class=p >,</span>
            <span class=n >wx</span><span class=p >,</span>
            <span class=n >params</span><span class=p >,</span>
            <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >entity_ids</span><span class=p >,</span>
            <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >time_ids</span><span class=p >,</span>
            <span class=n >debiased</span><span class=o >=</span><span class=n >debiased</span><span class=p >,</span>
            <span class=n >extra_df</span><span class=o >=</span><span class=n >extra_df</span><span class=p >,</span>
            <span class=o >**</span><span class=n >cov_config</span><span class=p >,</span>
        <span class=p >)</span>

        <span class=n >weps</span> <span class=o >=</span> <span class=n >wy</span> <span class=o >-</span> <span class=n >wx</span> <span class=o >@</span> <span class=n >params</span>
        <span class=n >eps</span> <span class=o >=</span> <span class=n >weps</span> <span class=o >/</span> <span class=n >root_w</span>
        <span class=n >index</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >index</span>
        <span class=n >fitted</span> <span class=o >=</span> <span class=n >DataFrame</span><span class=p >(</span><span class=bp >self</span><span class=o >.</span><span class=n >exog</span><span class=o >.</span><span class=n >values2d</span> <span class=o >@</span> <span class=n >params</span><span class=p >,</span> <span class=n >index</span><span class=p >,</span> <span class=p >[</span><span class=s2 >"fitted_values"</span><span class=p >])</span>
        <span class=n >effects</span> <span class=o >=</span> <span class=n >DataFrame</span><span class=p >(</span>
            <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >values2d</span> <span class=o >-</span> <span class=n >np</span><span class=o >.</span><span class=n >asarray</span><span class=p >(</span><span class=n >fitted</span><span class=p >)</span> <span class=o >-</span> <span class=n >eps</span><span class=p >,</span>
            <span class=n >index</span><span class=p >,</span>
            <span class=p >[</span><span class=s2 >"estimated_effects"</span><span class=p >],</span>
        <span class=p >)</span>
        <span class=n >idiosyncratic</span> <span class=o >=</span> <span class=n >DataFrame</span><span class=p >(</span><span class=n >eps</span><span class=p >,</span> <span class=n >index</span><span class=p >,</span> <span class=p >[</span><span class=s2 >"idiosyncratic"</span><span class=p >])</span>
        <span class=n >residual_ss</span> <span class=o >=</span> <span class=nb >float</span><span class=p >(</span><span class=n >weps</span><span class=o >.</span><span class=n >T</span> <span class=o >@</span> <span class=n >weps</span><span class=p >)</span>
        <span class=n >wmu</span><span class=p >:</span> <span class=nb >float</span> <span class=o >|</span> <span class=n >Float64Array</span> <span class=o >=</span> <span class=mf >0.0</span>
        <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >has_constant</span><span class=p >:</span>
            <span class=n >wmu</span> <span class=o >=</span> <span class=n >root_w</span> <span class=o >*</span> <span class=n >_lstsq</span><span class=p >(</span><span class=n >root_w</span><span class=p >,</span> <span class=n >wy</span><span class=p >,</span> <span class=n >rcond</span><span class=o >=</span><span class=kc >None</span><span class=p >)[</span><span class=mi >0</span><span class=p >]</span>
        <span class=n >wy_demeaned</span> <span class=o >=</span> <span class=n >wy</span> <span class=o >-</span> <span class=n >wmu</span>
        <span class=n >total_ss</span> <span class=o >=</span> <span class=nb >float</span><span class=p >(</span><span class=n >wy_demeaned</span><span class=o >.</span><span class=n >T</span> <span class=o >@</span> <span class=n >wy_demeaned</span><span class=p >)</span>
        <span class=n >r2</span> <span class=o >=</span> <span class=mi >1</span> <span class=o >-</span> <span class=n >residual_ss</span> <span class=o >/</span> <span class=n >total_ss</span>

        <span class=n >res</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_postestimation</span><span class=p >(</span>
            <span class=n >params</span><span class=p >,</span> <span class=n >cov</span><span class=p >,</span> <span class=n >debiased</span><span class=p >,</span> <span class=n >df_resid</span><span class=p >,</span> <span class=n >weps</span><span class=p >,</span> <span class=n >wy</span><span class=p >,</span> <span class=n >wx</span><span class=p >,</span> <span class=n >root_w</span>
        <span class=p >)</span>
        <span class=n >res</span><span class=o >.</span><span class=n >update</span><span class=p >(</span>
            <span class=nb >dict</span><span class=p >(</span>
                <span class=n >df_resid</span><span class=o >=</span><span class=n >df_resid</span><span class=p >,</span>
                <span class=n >df_model</span><span class=o >=</span><span class=n >x</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >1</span><span class=p >],</span>
                <span class=n >nobs</span><span class=o >=</span><span class=n >y</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >],</span>
                <span class=n >residual_ss</span><span class=o >=</span><span class=n >residual_ss</span><span class=p >,</span>
                <span class=n >total_ss</span><span class=o >=</span><span class=n >total_ss</span><span class=p >,</span>
                <span class=n >r2</span><span class=o >=</span><span class=n >r2</span><span class=p >,</span>
                <span class=n >resids</span><span class=o >=</span><span class=n >eps</span><span class=p >,</span>
                <span class=n >wresids</span><span class=o >=</span><span class=n >weps</span><span class=p >,</span>
                <span class=n >index</span><span class=o >=</span><span class=n >index</span><span class=p >,</span>
                <span class=n >sigma2_eps</span><span class=o >=</span><span class=n >sigma2_e</span><span class=p >,</span>
                <span class=n >sigma2_effects</span><span class=o >=</span><span class=n >sigma2_u</span><span class=p >,</span>
                <span class=n >rho</span><span class=o >=</span><span class=n >rho</span><span class=p >,</span>
                <span class=n >theta</span><span class=o >=</span><span class=n >theta_out</span><span class=p >,</span>
                <span class=n >fitted</span><span class=o >=</span><span class=n >fitted</span><span class=p >,</span>
                <span class=n >effects</span><span class=o >=</span><span class=n >effects</span><span class=p >,</span>
                <span class=n >idiosyncratic</span><span class=o >=</span><span class=n >idiosyncratic</span><span class=p >,</span>
            <span class=p >)</span>
        <span class=p >)</span>

        <span class=k >return</span> <span class=n >RandomEffectsResults</span><span class=p >(</span><span class=n >res</span><span class=p >)</span></div></div>


<div class=viewcode-block  id=FamaMacBeth ><a class=viewcode-back  href="../../../panel/panel/linearmodels.panel.model.FamaMacBeth.html#linearmodels.panel.model.FamaMacBeth">[docs]</a><span class=k >class</span> <span class=nc >FamaMacBeth</span><span class=p >(</span><span class=n >_PanelModelBase</span><span class=p >):</span>
    <span class=sa >r</span><span class=sd >"""</span>
<span class=sd >    Pooled coefficient estimator for panel data</span>

<span class=sd >    Parameters</span>
<span class=sd >    ----------</span>
<span class=sd >    dependent : array_like</span>
<span class=sd >        Dependent (left-hand-side) variable (time by entity)</span>
<span class=sd >    exog : array_like</span>
<span class=sd >        Exogenous or right-hand-side variables (variable by time by entity).</span>
<span class=sd >    weights : array_like</span>
<span class=sd >        Weights to use in estimation.  Assumes residual variance is</span>
<span class=sd >        proportional to inverse of weight to that the residual time</span>
<span class=sd >        the weight should be homoskedastic.</span>

<span class=sd >    Notes</span>
<span class=sd >    -----</span>
<span class=sd >    The model is given by</span>

<span class=sd >    .. math::</span>

<span class=sd >        y_{it}=\beta^{\prime}x_{it}+\epsilon_{it}</span>

<span class=sd >    The Fama-MacBeth estimator is computed by performing T regressions, one</span>
<span class=sd >    for each time period using all available entity observations.  Denote the</span>
<span class=sd >    estimate of the model parameters as :math:`\hat{\beta}_t`.  The reported</span>
<span class=sd >    estimator is then</span>

<span class=sd >    .. math::</span>

<span class=sd >        \hat{\beta} = T^{-1}\sum_{t=1}^T \hat{\beta}_t</span>

<span class=sd >    While the model does not explicitly include time-effects, the</span>
<span class=sd >    implementation based on regressing all observation in a single</span>
<span class=sd >    time period is "as-if" time effects are included.</span>

<span class=sd >    Parameter inference is made using the set of T parameter estimates with</span>
<span class=sd >    either the standard covariance estimator or a kernel-based covariance,</span>
<span class=sd >    depending on ``cov_type``.</span>
<span class=sd >    """</span>

    <span class=k >def</span> <span class=fm >__init__</span><span class=p >(</span>
        <span class=bp >self</span><span class=p >,</span>
        <span class=n >dependent</span><span class=p >:</span> <span class=n >PanelDataLike</span><span class=p >,</span>
        <span class=n >exog</span><span class=p >:</span> <span class=n >PanelDataLike</span><span class=p >,</span>
        <span class=o >*</span><span class=p >,</span>
        <span class=n >weights</span><span class=p >:</span> <span class=n >PanelDataLike</span> <span class=o >|</span> <span class=kc >None</span> <span class=o >=</span> <span class=kc >None</span><span class=p >,</span>
        <span class=n >check_rank</span><span class=p >:</span> <span class=nb >bool</span> <span class=o >=</span> <span class=kc >True</span><span class=p >,</span>
    <span class=p >):</span>
        <span class=nb >super</span><span class=p >()</span><span class=o >.</span><span class=fm >__init__</span><span class=p >(</span><span class=n >dependent</span><span class=p >,</span> <span class=n >exog</span><span class=p >,</span> <span class=n >weights</span><span class=o >=</span><span class=n >weights</span><span class=p >,</span> <span class=n >check_rank</span><span class=o >=</span><span class=n >check_rank</span><span class=p >)</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >_validate_blocks</span><span class=p >()</span>

    <span class=k >def</span> <span class=nf >_validate_blocks</span><span class=p >(</span><span class=bp >self</span><span class=p >)</span> <span class=o >-&gt;</span> <span class=kc >None</span><span class=p >:</span>
        <span class=n >x</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_x</span>
        <span class=n >root_w</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >sqrt</span><span class=p >(</span><span class=bp >self</span><span class=o >.</span><span class=n >_w</span><span class=p >)</span>
        <span class=n >wx</span> <span class=o >=</span> <span class=n >root_w</span> <span class=o >*</span> <span class=n >x</span>

        <span class=n >exog</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >exog</span><span class=o >.</span><span class=n >dataframe</span>
        <span class=n >wx_df</span> <span class=o >=</span> <span class=n >DataFrame</span><span class=p >(</span>
            <span class=n >wx</span><span class=p >[</span><span class=bp >self</span><span class=o >.</span><span class=n >_not_null</span><span class=p >],</span> <span class=n >index</span><span class=o >=</span><span class=n >exog</span><span class=o >.</span><span class=n >notnull</span><span class=p >()</span><span class=o >.</span><span class=n >index</span><span class=p >,</span> <span class=n >columns</span><span class=o >=</span><span class=n >exog</span><span class=o >.</span><span class=n >columns</span>
        <span class=p >)</span>

        <span class=k >def</span> <span class=nf >validate_block</span><span class=p >(</span><span class=n >ex</span><span class=p >:</span> <span class=n >Float64Array</span><span class=p >)</span> <span class=o >-&gt;</span> <span class=nb >bool</span><span class=p >:</span>
            <span class=k >def</span> <span class=nf >_mr</span><span class=p >(</span><span class=n >ex</span><span class=p >:</span> <span class=n >DataFrame</span><span class=p >)</span> <span class=o >-&gt;</span> <span class=nb >int</span><span class=p >:</span>
                <span class=sd >"""lstsq based matrix_rank"""</span>
                <span class=k >return</span> <span class=n >_lstsq</span><span class=p >(</span><span class=n >ex</span><span class=p >,</span> <span class=n >np</span><span class=o >.</span><span class=n >ones</span><span class=p >(</span><span class=n >ex</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >]))[</span><span class=mi >2</span><span class=p >]</span>

            <span class=k >return</span> <span class=n >ex</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >]</span> <span class=o >&gt;=</span> <span class=n >ex</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >1</span><span class=p >]</span> <span class=ow >and</span> <span class=n >_mr</span><span class=p >(</span><span class=n >ex</span><span class=p >)</span> <span class=o >==</span> <span class=n >ex</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >1</span><span class=p >]</span>

        <span class=n >valid_blocks</span> <span class=o >=</span> <span class=n >wx_df</span><span class=o >.</span><span class=n >groupby</span><span class=p >(</span><span class=n >level</span><span class=o >=</span><span class=mi >1</span><span class=p >)</span><span class=o >.</span><span class=n >apply</span><span class=p >(</span><span class=n >validate_block</span><span class=p >)</span>
        <span class=k >if</span> <span class=ow >not</span> <span class=n >valid_blocks</span><span class=o >.</span><span class=n >any</span><span class=p >():</span>
            <span class=n >err</span> <span class=o >=</span> <span class=p >(</span>
                <span class=s2 >"Model cannot be estimated. All blocks of time-series observations are rank</span><span class=se >\n</span><span class=s2 >"</span>
                <span class=s2 >"deficient, and so it is not possible to estimate any cross-sectional "</span>
                <span class=s2 >"regressions."</span>
            <span class=p >)</span>
            <span class=k >raise</span> <span class=ne >ValueError</span><span class=p >(</span><span class=n >err</span><span class=p >)</span>
        <span class=k >if</span> <span class=n >valid_blocks</span><span class=o >.</span><span class=n >sum</span><span class=p >()</span> <span class=o >&lt;</span> <span class=n >exog</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >1</span><span class=p >]:</span>
            <span class=kn >import</span> <span class=nn >warnings</span>

            <span class=n >warnings</span><span class=o >.</span><span class=n >warn</span><span class=p >(</span>
                <span class=s2 >"The number of time-series observation available to estimate "</span>
                <span class=s2 >"cross-sectional</span><span class=se >\n</span><span class=s2 >regressions, </span><span class=si >{}</span><span class=s2 >, is less than the number of "</span>
                <span class=s2 >"parameters in the model. Parameter</span><span class=se >\n</span><span class=s2 >inference is not "</span>
                <span class=s2 >"available."</span><span class=o >.</span><span class=n >format</span><span class=p >(</span><span class=n >valid_blocks</span><span class=o >.</span><span class=n >sum</span><span class=p >()),</span>
                <span class=n >InferenceUnavailableWarning</span><span class=p >,</span>
                <span class=n >stacklevel</span><span class=o >=</span><span class=mi >3</span><span class=p >,</span>
            <span class=p >)</span>
        <span class=k >elif</span> <span class=n >valid_blocks</span><span class=o >.</span><span class=n >sum</span><span class=p >()</span> <span class=o >&lt;</span> <span class=n >valid_blocks</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >]:</span>
            <span class=kn >import</span> <span class=nn >warnings</span>

            <span class=n >warnings</span><span class=o >.</span><span class=n >warn</span><span class=p >(</span>
                <span class=s2 >"</span><span class=si >{}</span><span class=s2 > of the time-series regressions cannot be estimated due to "</span>
                <span class=s2 >"deficient rank."</span><span class=o >.</span><span class=n >format</span><span class=p >(</span><span class=n >valid_blocks</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >]</span> <span class=o >-</span> <span class=n >valid_blocks</span><span class=o >.</span><span class=n >sum</span><span class=p >()),</span>
                <span class=n >MissingValueWarning</span><span class=p >,</span>
                <span class=n >stacklevel</span><span class=o >=</span><span class=mi >3</span><span class=p >,</span>
            <span class=p >)</span>

<div class=viewcode-block  id=FamaMacBeth.fit ><a class=viewcode-back  href="../../../panel/panel/linearmodels.panel.model.FamaMacBeth.fit.html#linearmodels.panel.model.FamaMacBeth.fit">[docs]</a>    <span class=k >def</span> <span class=nf >fit</span><span class=p >(</span>
        <span class=bp >self</span><span class=p >,</span>
        <span class=n >cov_type</span><span class=p >:</span> <span class=nb >str</span> <span class=o >=</span> <span class=s2 >"unadjusted"</span><span class=p >,</span>
        <span class=n >debiased</span><span class=p >:</span> <span class=nb >bool</span> <span class=o >=</span> <span class=kc >True</span><span class=p >,</span>
        <span class=n >bandwidth</span><span class=p >:</span> <span class=nb >float</span> <span class=o >|</span> <span class=kc >None</span> <span class=o >=</span> <span class=kc >None</span><span class=p >,</span>
        <span class=n >kernel</span><span class=p >:</span> <span class=nb >str</span> <span class=o >|</span> <span class=kc >None</span> <span class=o >=</span> <span class=kc >None</span><span class=p >,</span>
    <span class=p >)</span> <span class=o >-&gt;</span> <span class=n >FamaMacBethResults</span><span class=p >:</span>
        <span class=sd >"""</span>
<span class=sd >        Estimate model parameters</span>

<span class=sd >        Parameters</span>
<span class=sd >        ----------</span>
<span class=sd >        cov_type : str</span>
<span class=sd >            Name of covariance estimator (see notes). Default is "unadjusted".</span>
<span class=sd >        debiased : bool</span>
<span class=sd >            Flag indicating whether to debiased the covariance estimator using</span>
<span class=sd >            a degree of freedom adjustment.</span>
<span class=sd >        bandwidth : float</span>
<span class=sd >            The bandwidth to use when cov_type is "kernel". If None, it is</span>
<span class=sd >            automatically computed.</span>
<span class=sd >        kernel : str</span>
<span class=sd >            The kernel to use.  None chooses the default kernel.</span>

<span class=sd >        Returns</span>
<span class=sd >        -------</span>
<span class=sd >        PanelResults</span>
<span class=sd >            Estimation results</span>

<span class=sd >        Examples</span>
<span class=sd >        --------</span>
<span class=sd >        &gt;&gt;&gt; from linearmodels import FamaMacBeth</span>
<span class=sd >        &gt;&gt;&gt; mod = FamaMacBeth(y, x)</span>
<span class=sd >        &gt;&gt;&gt; res = mod.fit(cov_type="kernel", kernel="Parzen")</span>

<span class=sd >        Notes</span>
<span class=sd >        -----</span>
<span class=sd >        Two covariance estimators are supported:</span>

<span class=sd >        * "unadjusted", "homoskedastic", "robust", "heteroskedastic" use the</span>
<span class=sd >          standard covariance estimator of the T parameter estimates.</span>
<span class=sd >        * "kernel" is a HAC estimator. Configurations options are:</span>
<span class=sd >        """</span>
        <span class=n >y</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span><span class=n >Float64Array</span><span class=p >,</span> <span class=bp >self</span><span class=o >.</span><span class=n >_y</span><span class=p >)</span>
        <span class=n >x</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span><span class=n >Float64Array</span><span class=p >,</span> <span class=bp >self</span><span class=o >.</span><span class=n >_x</span><span class=p >)</span>
        <span class=n >root_w</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span><span class=n >Float64Array</span><span class=p >,</span> <span class=n >np</span><span class=o >.</span><span class=n >sqrt</span><span class=p >(</span><span class=bp >self</span><span class=o >.</span><span class=n >_w</span><span class=p >))</span>
        <span class=n >wy</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span><span class=n >Float64Array</span><span class=p >,</span> <span class=n >root_w</span> <span class=o >*</span> <span class=n >y</span><span class=p >)</span>
        <span class=n >wx</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span><span class=n >Float64Array</span><span class=p >,</span> <span class=n >root_w</span> <span class=o >*</span> <span class=n >x</span><span class=p >)</span>

        <span class=n >dep</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >dataframe</span>
        <span class=n >exog</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >exog</span><span class=o >.</span><span class=n >dataframe</span>
        <span class=n >index</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >index</span>
        <span class=n >wy_df</span> <span class=o >=</span> <span class=n >DataFrame</span><span class=p >(</span><span class=n >wy</span><span class=p >[</span><span class=bp >self</span><span class=o >.</span><span class=n >_not_null</span><span class=p >],</span> <span class=n >index</span><span class=o >=</span><span class=n >index</span><span class=p >,</span> <span class=n >columns</span><span class=o >=</span><span class=n >dep</span><span class=o >.</span><span class=n >columns</span><span class=p >)</span>
        <span class=n >wx_df</span> <span class=o >=</span> <span class=n >DataFrame</span><span class=p >(</span>
            <span class=n >wx</span><span class=p >[</span><span class=bp >self</span><span class=o >.</span><span class=n >_not_null</span><span class=p >],</span> <span class=n >index</span><span class=o >=</span><span class=n >exog</span><span class=o >.</span><span class=n >notnull</span><span class=p >()</span><span class=o >.</span><span class=n >index</span><span class=p >,</span> <span class=n >columns</span><span class=o >=</span><span class=n >exog</span><span class=o >.</span><span class=n >columns</span>
        <span class=p >)</span>

        <span class=n >yx</span> <span class=o >=</span> <span class=n >DataFrame</span><span class=p >(</span>
            <span class=n >np</span><span class=o >.</span><span class=n >c_</span><span class=p >[</span><span class=n >wy_df</span><span class=o >.</span><span class=n >values</span><span class=p >,</span> <span class=n >wx_df</span><span class=o >.</span><span class=n >values</span><span class=p >],</span>
            <span class=n >columns</span><span class=o >=</span><span class=nb >list</span><span class=p >(</span><span class=n >wy_df</span><span class=o >.</span><span class=n >columns</span><span class=p >)</span> <span class=o >+</span> <span class=nb >list</span><span class=p >(</span><span class=n >wx_df</span><span class=o >.</span><span class=n >columns</span><span class=p >),</span>
            <span class=n >index</span><span class=o >=</span><span class=n >wy_df</span><span class=o >.</span><span class=n >index</span><span class=p >,</span>
        <span class=p >)</span>

        <span class=k >def</span> <span class=nf >single</span><span class=p >(</span><span class=n >z</span><span class=p >:</span> <span class=n >DataFrame</span><span class=p >)</span> <span class=o >-&gt;</span> <span class=n >Series</span><span class=p >:</span>
            <span class=n >exog</span> <span class=o >=</span> <span class=n >z</span><span class=o >.</span><span class=n >iloc</span><span class=p >[:,</span> <span class=mi >1</span><span class=p >:]</span><span class=o >.</span><span class=n >values</span>
            <span class=k >if</span> <span class=n >exog</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >]</span> <span class=o >&lt;</span> <span class=n >exog</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >1</span><span class=p >]:</span>
                <span class=k >return</span> <span class=n >Series</span><span class=p >([</span><span class=n >np</span><span class=o >.</span><span class=n >nan</span><span class=p >]</span> <span class=o >*</span> <span class=nb >len</span><span class=p >(</span><span class=n >z</span><span class=o >.</span><span class=n >columns</span><span class=p >),</span> <span class=n >index</span><span class=o >=</span><span class=n >z</span><span class=o >.</span><span class=n >columns</span><span class=p >)</span>
            <span class=n >dep</span> <span class=o >=</span> <span class=n >z</span><span class=o >.</span><span class=n >iloc</span><span class=p >[:,</span> <span class=p >:</span><span class=mi >1</span><span class=p >]</span><span class=o >.</span><span class=n >values</span>
            <span class=n >params</span><span class=p >,</span> <span class=n >_</span><span class=p >,</span> <span class=n >rank</span><span class=p >,</span> <span class=n >_</span> <span class=o >=</span> <span class=n >_lstsq</span><span class=p >(</span><span class=n >exog</span><span class=p >,</span> <span class=n >dep</span><span class=p >)</span>
            <span class=k >if</span> <span class=n >rank</span> <span class=o >!=</span> <span class=n >exog</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >1</span><span class=p >]:</span>
                <span class=k >return</span> <span class=n >Series</span><span class=p >([</span><span class=n >np</span><span class=o >.</span><span class=n >nan</span><span class=p >]</span> <span class=o >*</span> <span class=nb >len</span><span class=p >(</span><span class=n >z</span><span class=o >.</span><span class=n >columns</span><span class=p >),</span> <span class=n >index</span><span class=o >=</span><span class=n >z</span><span class=o >.</span><span class=n >columns</span><span class=p >)</span>
            <span class=k >return</span> <span class=n >Series</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >r_</span><span class=p >[</span><span class=n >np</span><span class=o >.</span><span class=n >nan</span><span class=p >,</span> <span class=n >params</span><span class=o >.</span><span class=n >ravel</span><span class=p >()],</span> <span class=n >index</span><span class=o >=</span><span class=n >z</span><span class=o >.</span><span class=n >columns</span><span class=p >)</span>

        <span class=n >all_params</span> <span class=o >=</span> <span class=n >yx</span><span class=o >.</span><span class=n >groupby</span><span class=p >(</span><span class=n >level</span><span class=o >=</span><span class=mi >1</span><span class=p >)</span><span class=o >.</span><span class=n >apply</span><span class=p >(</span><span class=n >single</span><span class=p >)</span>
        <span class=n >all_params</span> <span class=o >=</span> <span class=n >all_params</span><span class=o >.</span><span class=n >iloc</span><span class=p >[:,</span> <span class=mi >1</span><span class=p >:]</span>
        <span class=n >params</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >asarray</span><span class=p >(</span><span class=n >all_params</span><span class=o >.</span><span class=n >mean</span><span class=p >(</span><span class=mi >0</span><span class=p >)</span><span class=o >.</span><span class=n >values</span><span class=p >[:,</span> <span class=kc >None</span><span class=p >],</span> <span class=n >dtype</span><span class=o >=</span><span class=nb >float</span><span class=p >)</span>

        <span class=n >wy</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >asarray</span><span class=p >(</span><span class=n >wy_df</span><span class=p >)</span>
        <span class=n >wx</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >asarray</span><span class=p >(</span><span class=n >wx_df</span><span class=p >)</span>
        <span class=n >index</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >index</span>
        <span class=n >fitted</span> <span class=o >=</span> <span class=n >DataFrame</span><span class=p >(</span><span class=bp >self</span><span class=o >.</span><span class=n >exog</span><span class=o >.</span><span class=n >values2d</span> <span class=o >@</span> <span class=n >params</span><span class=p >,</span> <span class=n >index</span><span class=p >,</span> <span class=p >[</span><span class=s2 >"fitted_values"</span><span class=p >])</span>
        <span class=n >effects</span> <span class=o >=</span> <span class=n >DataFrame</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >full</span><span class=p >(</span><span class=n >fitted</span><span class=o >.</span><span class=n >shape</span><span class=p >,</span> <span class=n >np</span><span class=o >.</span><span class=n >nan</span><span class=p >),</span> <span class=n >index</span><span class=p >,</span> <span class=p >[</span><span class=s2 >"estimated_effects"</span><span class=p >])</span>
        <span class=n >idiosyncratic</span> <span class=o >=</span> <span class=n >DataFrame</span><span class=p >(</span>
            <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >values2d</span> <span class=o >-</span> <span class=n >fitted</span><span class=o >.</span><span class=n >values</span><span class=p >,</span> <span class=n >index</span><span class=p >,</span> <span class=p >[</span><span class=s2 >"idiosyncratic"</span><span class=p >]</span>
        <span class=p >)</span>

        <span class=n >eps</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >values2d</span> <span class=o >-</span> <span class=n >fitted</span><span class=o >.</span><span class=n >values</span>
        <span class=n >weps</span> <span class=o >=</span> <span class=n >wy</span> <span class=o >-</span> <span class=n >wx</span> <span class=o >@</span> <span class=n >params</span>
        <span class=n >w</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >weights</span><span class=o >.</span><span class=n >values2d</span>
        <span class=n >root_w</span> <span class=o >=</span> <span class=n >cast</span><span class=p >(</span><span class=n >Float64Array</span><span class=p >,</span> <span class=n >np</span><span class=o >.</span><span class=n >sqrt</span><span class=p >(</span><span class=n >w</span><span class=p >))</span>
        <span class=c1 >#</span>
        <span class=n >residual_ss</span> <span class=o >=</span> <span class=nb >float</span><span class=p >(</span><span class=n >weps</span><span class=o >.</span><span class=n >T</span> <span class=o >@</span> <span class=n >weps</span><span class=p >)</span>
        <span class=n >y</span> <span class=o >=</span> <span class=n >e</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >values2d</span>
        <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >has_constant</span><span class=p >:</span>
            <span class=n >e</span> <span class=o >=</span> <span class=n >y</span> <span class=o >-</span> <span class=p >(</span><span class=n >w</span> <span class=o >*</span> <span class=n >y</span><span class=p >)</span><span class=o >.</span><span class=n >sum</span><span class=p >()</span> <span class=o >/</span> <span class=n >w</span><span class=o >.</span><span class=n >sum</span><span class=p >()</span>
        <span class=n >total_ss</span> <span class=o >=</span> <span class=nb >float</span><span class=p >(</span><span class=n >w</span><span class=o >.</span><span class=n >T</span> <span class=o >@</span> <span class=p >(</span><span class=n >e</span><span class=o >**</span><span class=mi >2</span><span class=p >))</span>
        <span class=n >r2</span> <span class=o >=</span> <span class=mi >1</span> <span class=o >-</span> <span class=n >residual_ss</span> <span class=o >/</span> <span class=n >total_ss</span>

        <span class=k >if</span> <span class=n >cov_type</span> <span class=ow >not</span> <span class=ow >in</span> <span class=p >(</span>
            <span class=s2 >"robust"</span><span class=p >,</span>
            <span class=s2 >"unadjusted"</span><span class=p >,</span>
            <span class=s2 >"homoskedastic"</span><span class=p >,</span>
            <span class=s2 >"heteroskedastic"</span><span class=p >,</span>
            <span class=s2 >"kernel"</span><span class=p >,</span>
        <span class=p >):</span>
            <span class=k >raise</span> <span class=ne >ValueError</span><span class=p >(</span><span class=s2 >"Unknown cov_type"</span><span class=p >)</span>

        <span class=n >bandwidth</span> <span class=o >=</span> <span class=mf >0.0</span> <span class=k >if</span> <span class=n >cov_type</span> <span class=o >!=</span> <span class=s2 >"kernel"</span> <span class=k >else</span> <span class=n >bandwidth</span>
        <span class=n >cov</span> <span class=o >=</span> <span class=n >FamaMacBethCovariance</span><span class=p >(</span>
            <span class=n >wy</span><span class=p >,</span>
            <span class=n >wx</span><span class=p >,</span>
            <span class=n >params</span><span class=p >,</span>
            <span class=n >all_params</span><span class=p >,</span>
            <span class=n >debiased</span><span class=o >=</span><span class=n >debiased</span><span class=p >,</span>
            <span class=n >kernel</span><span class=o >=</span><span class=n >kernel</span><span class=p >,</span>
            <span class=n >bandwidth</span><span class=o >=</span><span class=n >bandwidth</span><span class=p >,</span>
        <span class=p >)</span>

        <span class=n >df_resid</span> <span class=o >=</span> <span class=n >wy</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >]</span> <span class=o >-</span> <span class=n >params</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >]</span>
        <span class=n >res</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_postestimation</span><span class=p >(</span>
            <span class=n >params</span><span class=p >,</span> <span class=n >cov</span><span class=p >,</span> <span class=n >debiased</span><span class=p >,</span> <span class=n >df_resid</span><span class=p >,</span> <span class=n >weps</span><span class=p >,</span> <span class=n >wy</span><span class=p >,</span> <span class=n >wx</span><span class=p >,</span> <span class=n >root_w</span>
        <span class=p >)</span>
        <span class=n >index</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >dependent</span><span class=o >.</span><span class=n >index</span>
        <span class=n >res</span><span class=o >.</span><span class=n >update</span><span class=p >(</span>
            <span class=nb >dict</span><span class=p >(</span>
                <span class=n >df_resid</span><span class=o >=</span><span class=n >df_resid</span><span class=p >,</span>
                <span class=n >df_model</span><span class=o >=</span><span class=n >x</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >1</span><span class=p >],</span>
                <span class=n >nobs</span><span class=o >=</span><span class=n >y</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >0</span><span class=p >],</span>
                <span class=n >residual_ss</span><span class=o >=</span><span class=n >residual_ss</span><span class=p >,</span>
                <span class=n >total_ss</span><span class=o >=</span><span class=n >total_ss</span><span class=p >,</span>
                <span class=n >r2</span><span class=o >=</span><span class=n >r2</span><span class=p >,</span>
                <span class=n >resids</span><span class=o >=</span><span class=n >eps</span><span class=p >,</span>
                <span class=n >wresids</span><span class=o >=</span><span class=n >weps</span><span class=p >,</span>
                <span class=n >index</span><span class=o >=</span><span class=n >index</span><span class=p >,</span>
                <span class=n >fitted</span><span class=o >=</span><span class=n >fitted</span><span class=p >,</span>
                <span class=n >effects</span><span class=o >=</span><span class=n >effects</span><span class=p >,</span>
                <span class=n >idiosyncratic</span><span class=o >=</span><span class=n >idiosyncratic</span><span class=p >,</span>
                <span class=n >all_params</span><span class=o >=</span><span class=n >all_params</span><span class=p >,</span>
            <span class=p >)</span>
        <span class=p >)</span>
        <span class=k >return</span> <span class=n >FamaMacBethResults</span><span class=p >(</span><span class=n >res</span><span class=p >)</span></div>

<div class=viewcode-block  id=FamaMacBeth.from_formula ><a class=viewcode-back  href="../../../panel/panel/linearmodels.panel.model.FamaMacBeth.from_formula.html#linearmodels.panel.model.FamaMacBeth.from_formula">[docs]</a>    <span class=nd >@classmethod</span>
    <span class=k >def</span> <span class=nf >from_formula</span><span class=p >(</span>
        <span class=bp >cls</span><span class=p >,</span>
        <span class=n >formula</span><span class=p >:</span> <span class=nb >str</span><span class=p >,</span>
        <span class=n >data</span><span class=p >:</span> <span class=n >PanelDataLike</span><span class=p >,</span>
        <span class=o >*</span><span class=p >,</span>
        <span class=n >weights</span><span class=p >:</span> <span class=n >PanelDataLike</span> <span class=o >|</span> <span class=kc >None</span> <span class=o >=</span> <span class=kc >None</span><span class=p >,</span>
        <span class=n >check_rank</span><span class=p >:</span> <span class=nb >bool</span> <span class=o >=</span> <span class=kc >True</span><span class=p >,</span>
    <span class=p >)</span> <span class=o >-&gt;</span> <span class=n >FamaMacBeth</span><span class=p >:</span>
        <span class=sd >"""</span>
<span class=sd >        Create a model from a formula</span>

<span class=sd >        Parameters</span>
<span class=sd >        ----------</span>
<span class=sd >        formula : str</span>
<span class=sd >            Formula to transform into model. Conforms to formulaic formula</span>
<span class=sd >            rules.</span>
<span class=sd >        data : array_like</span>
<span class=sd >            Data structure that can be coerced into a PanelData.  In most</span>
<span class=sd >            cases, this should be a multi-index DataFrame where the level 0</span>
<span class=sd >            index contains the entities and the level 1 contains the time.</span>
<span class=sd >        weights: array_like</span>
<span class=sd >            Weights to use in estimation.  Assumes residual variance is</span>
<span class=sd >            proportional to inverse of weight to that the residual times</span>
<span class=sd >            the weight should be homoskedastic.</span>
<span class=sd >        check_rank : bool</span>
<span class=sd >            Flag indicating whether to perform a rank check on the exogenous</span>
<span class=sd >            variables to ensure that the model is identified. Skipping this</span>
<span class=sd >            check can reduce the time required to validate a model</span>
<span class=sd >            specification. Results may be numerically unstable if this check</span>
<span class=sd >            is skipped and the matrix is not full rank.</span>

<span class=sd >        Returns</span>
<span class=sd >        -------</span>
<span class=sd >        FamaMacBeth</span>
<span class=sd >            Model specified using the formula</span>

<span class=sd >        Notes</span>
<span class=sd >        -----</span>
<span class=sd >        Unlike standard  formula syntax, it is necessary to explicitly include</span>
<span class=sd >        a constant using the constant indicator (1)</span>

<span class=sd >        Examples</span>
<span class=sd >        --------</span>
<span class=sd >        &gt;&gt;&gt; from linearmodels import FamaMacBeth</span>
<span class=sd >        &gt;&gt;&gt; from linearmodels.panel import generate_panel_data</span>
<span class=sd >        &gt;&gt;&gt; panel_data = generate_panel_data()</span>
<span class=sd >        &gt;&gt;&gt; mod = FamaMacBeth.from_formula("y ~ 1 + x1", panel_data.data)</span>
<span class=sd >        &gt;&gt;&gt; res = mod.fit()</span>
<span class=sd >        """</span>
        <span class=n >parser</span> <span class=o >=</span> <span class=n >PanelFormulaParser</span><span class=p >(</span><span class=n >formula</span><span class=p >,</span> <span class=n >data</span><span class=p >)</span>
        <span class=n >dependent</span><span class=p >,</span> <span class=n >exog</span> <span class=o >=</span> <span class=n >parser</span><span class=o >.</span><span class=n >data</span>
        <span class=n >mod</span> <span class=o >=</span> <span class=bp >cls</span><span class=p >(</span><span class=n >dependent</span><span class=p >,</span> <span class=n >exog</span><span class=p >,</span> <span class=n >weights</span><span class=o >=</span><span class=n >weights</span><span class=p >,</span> <span class=n >check_rank</span><span class=o >=</span><span class=n >check_rank</span><span class=p >)</span>
        <span class=n >mod</span><span class=o >.</span><span class=n >formula</span> <span class=o >=</span> <span class=n >formula</span>
        <span class=k >return</span> <span class=n >mod</span></div></div>
</pre></div> </article> </div> </div> </main> </div> <footer class=md-footer > <div class=md-footer-nav > <nav class="md-footer-nav__inner md-grid"> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright > <div class=md-footer-copyright__highlight > &#169; Copyright 2017, Kevin Sheppard. </div> Created using <a href="http://www.sphinx-doc.org/">Sphinx</a> 5.0.2. and <a href="https://github.com/bashtage/sphinx-material/">Material for Sphinx</a> </div> </div> </div> </footer> <script src="../../../_static/javascripts/application.js"></script> <script>app.initialize({version: "1.0.4", url: {base: ".."}})</script>